!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("as-sys"),require("lodash")):"function"==typeof define&&define.amd?define(["as-sys","lodash"],t):(e=e||self).CommBase=t(e.asSys,e._)}(this,(function(e,t){"use strict";var n={version:"1.0.0"};function Authenticating(n){e.setup(this,Authenticating.prototype,n),"Basic"===n.authMethod&&t.extend(this.ajaxSettings,{headers:{Authorization:"Basic "+btoa(this.username+":"+this.password)}})}Authenticating.prototype={username:null,password:null,authMethod:null,ajaxSettings:null};var i={async:!0,dataType:"json",method:"GET",processData:!1};function Communicating(n){e.setup(this,Communicating.prototype,n),this.listeners={},this.error=null,this.pendingRequests=[],this.inRequest=!1,this.ajaxSettings=t.defaults(this.ajaxSettings,i)}function Delaying(e){this.delayTimer=null,this.delay=e&&e.delay||this.delay}return Communicating.prototype={__expects:["prepareQuery"],connector:null,serverUrl:"",onPrepare:null,onError:null,onSuccess:null,ajaxSettings:null,doRequest:function(n,i){if(this.inRequest)this.pendingRequests.push(arguments);else{this.inRequest=!0,"function"==typeof n&&(i=n,n=null);var s=this,r=null,o=t.defaults(this.prepareQuery(n),this.ajaxSettings);if("function"==typeof i||(t.each(s.listeners,(function(t){!1===e.act(t,t.beforeRequest,o,s)&&(r=t)})),null===r))return o.error=function(n,r,a){"function"==typeof i?i(null,n):(t.each(s.listeners,(function(t){e.act(t,t.afterResponse,null,n,o,s)})),e.act(s,s.onError,n,o))},o.success=function(n,r,a){var u=e.act(s,"parseResponse",n)||n;"function"==typeof i?i(u,n,a):(t.each(s.listeners,(function(t){e.act(t,t.afterResponse,u,a,o,s)})),e.act(s,s.onSuccess,u,a,o))},o.complete=function(){s.inRequest=!1,s.pendingRequests.length>0&&s.doRequest.apply(s,s.pendingRequests.shift())},e.broadcast(s,"onPrepare",o),e.act(s,s.onPrepare,o),s.connector(o);e.act(r,s.onError,null,"Request cancelled",r,s)}},init:function(){var n=this;e.pass(n,Communicating,"init"),t.each(this.listeners,(function(t){e.act(t,t.init,n)}))},addListeners:function(e){for(var t,n=e,i=0,s=(n=arguments.length>1?arguments:Array.isArray(e)?e:[e]).length;i<s;++i)t=n[i],this.listeners[t.id]=t;return this},removeOneListener:function(e){return"object"==typeof e&&(e=e.id),delete this.listeners[e],this},removeListeners:function(e,n){if("function"!=typeof e)throw{name:"Enumeration error",message:"Attempt to select-remove listeners with non-function 'selector': "+e};var i=this;return t.each(i.listeners,(function(t,s){e.call(n,t,s,i)&&delete i.listeners[s]})),i},enumerateListeners:function(e,n){if("function"!=typeof e)throw{name:"Enumeration error",message:"Attempt to enumerate listeners with non-function 'selector': "+e};var i=this;t.each(this.listeners,(function(t,s){e.call(n,t,s,i)}))},getListener:function(e){return this.listeners[e]}},Delaying.prototype={delay:300,doRequest:function(){var t=this,doInvoke=function(){e.pass(t,meSkill,"doRequest"),t.delayTimer=null};if(null==this.delay||this.delay<10)return doInvoke();null!=this.delayTimer&&clearTimeout(this.delayTimer),this.delayTimer=setTimeout(doInvoke,this.delay)}},n.Communicating=Communicating,n.Delaying=Delaying,n.Authenticating=Authenticating,n}));