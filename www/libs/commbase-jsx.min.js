!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("as-sys"),require("lodash")):"function"==typeof define&&define.amd?define(["as-sys","lodash"],t):(e=e||self).CommBase=t(e.asSys,e._)}(this,(function(e,t){"use strict";var n={version:"1.0.0"};function Authenticating(n){e.setup(this,n),"Basic"===n.authMethod&&t.extend(this.ajaxSettings,{headers:{Authorization:"Basic "+btoa(this.username+":"+this.password)}})}Authenticating.prototype={username:null,password:null,authMethod:null,ajaxSettings:null};var s={async:!0,dataType:"json",method:"GET",processData:!1};function Communicating(n){e.setup(this,n),this.listeners={},this.response=null,this.error=null,this.pendingRequests=[],this.inRequest=!1,this.ajaxSettings=t.defaults(this.ajaxSettings,s)}function Delaying(e){this.delayTimer=null,this.delay=e&&e.delay||this.delay}return Communicating.prototype={__expects:["prepareQuery"],connector:null,serverUrl:"",onPrepare:null,onError:null,onSuccess:null,ajaxSettings:null,doRequest:function(n,s){if(this.inRequest)this.pendingRequests.push(arguments);else{this.inRequest=!0,"function"==typeof n&&(s=n,n=null);var i=this,r=null,o=t.defaults(this.prepareQuery(n),this.ajaxSettings);if("function"==typeof s||(t.each(i.listeners,(function(t){!1===e.act(t,t.beforeRequest,o,i)&&(r=t)})),null===r))return o.error=function(n,r,a){"function"==typeof s?s(null,n):(t.each(i.listeners,(function(t){e.act(t,t.afterResponse,null,n,o,i)})),e.act(i,i.onError,n,o))},o.success=function(n,r,a){i.response=e.act(i,"parseResponse",n)||n,"function"==typeof s?s(i.response,a):(t.each(i.listeners,(function(t){e.act(t,t.afterResponse,i.response,o,a,i)})),e.act(i,i.onSuccess,i.response,a,o))},o.complete=function(){i.inRequest=!1,i.pendingRequests.length>0&&i.doRequest.apply(i,i.pendingRequests.shift())},e.broadcast(i,"onPrepare",o),e.act(i,i.onPrepare,o),i.connector.ajax(o);e.act(r,i.onError,null,"Request cancelled",r,i)}},init:function(){var n=this;e.pass(n,Communicating,"init"),t.each(this.listeners,(function(t){e.act(t,t.init,n)}))},addListeners:function(e){for(var t,n=e,s=0,i=(n=arguments.length>1?arguments:Array.isArray(e)?e:[e]).length;s<i;++s)t=n[s],this.listeners[t.id]=t;return this},removeOneListener:function(e){return"object"==typeof e&&(e=e.id),delete this.listeners[e],this},removeListeners:function(e,n){if("function"!=typeof e)throw{name:"Enumeration error",message:"Attempt to select-remove listeners with non-function 'selector': "+e};var s=this;return t.each(s.listeners,(function(t,i){e.call(n,t,i,s)&&delete s.listeners[i]})),s},enumerateListeners:function(e,n){if("function"!=typeof e)throw{name:"Enumeration error",message:"Attempt to enumerate listeners with non-function 'selector': "+e};var s=this;t.each(this.listeners,(function(t,i){e.call(n,t,i,s)}))},getListener:function(e){return this.listeners[e]}},Delaying.prototype={delay:300,doRequest:function(){var t=this,doInvoke=function(){e.pass(t,meSkill,"doRequest"),t.delayTimer=null};if(null==this.delay||this.delay<10)return doInvoke();null!=this.delayTimer&&clearTimeout(this.delayTimer),this.delayTimer=setTimeout(doInvoke,this.delay)}},n.Communicating=Communicating,n.Delaying=Delaying,n.Authenticating=Authenticating,n}));