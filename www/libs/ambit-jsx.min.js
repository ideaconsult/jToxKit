/** AmbitJsX library - a neXt Ambit queries JavaScript library. Copyright Â© 2019, IDEAConsult Ltd. All rights reserved. @license MIT.*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("as-sys"),require("lodash")):"function"==typeof define&&define.amd?define(["as-sys","lodash"],e):(t=t||self).Ambit=e(t.asSys,t._)}(this,(function(t,e){"use strict";var o={version:"1.0.0"};function Paging(t){}Paging.prototype.nextPage=function(){};var i={pollDelay:250,pollTimeout:15e3};function Tasking(e){t.setup(this,i,e)}Tasking.prototype.init=function(e){t.pass(this,Tasking,"init",e),this.manager=e},Tasking.prototype.pollTask=function(t,e){var o,i,n=this,l=null;i=function(t){"string"==typeof t&&(t={url:t,method:"GET"}),t.dataType="json",n.manager.doRequest(t,!0,(function(t,i){null==t?e(null,i):o(t,i)}))},o=function(t,o){null==t||null==t.task||t.task.length<1?e(t,o):(t=t.task[0]).completed>-1||t.error?e(t,o):null==l?(l=Date.now(),setTimeout((function(){i(t.result)}),n.pollDelay)):Date.now()-l>n.poolTimeout?e(t,o):setTimeout((function(){i(t.result)}),n.pollDelay)},i(t)};var n={baseUrl:null};function Querying(e){t.setup(this,n,e),this.baseUrl||(this.baseUrl=this.serverUrl)}Querying.prototype.__expects=["buildUrl"],Querying.prototype.prepareQuery=function(t){var o,i;return"object"!=typeof t?(o=t,t={}):o=t.url,i=o.indexOf("?"),e.defaults({url:this.buildUrl(o),serviceId:i>0?o.substr(0,i):o},t)};var l={};function Authorization(e){t.setup(this,l,e)}Authorization.prototype.init=function(e){t.pass(this,Authorization,"init",e),this.manager=e},Authorization.prototype.loadRoles=function(){this.manager.doRequest("admin/restpolicy",(function(t,e,o){}))},Authorization.prototype.loadPolicies=function(){this.manager.doRequest("admin/restpolicy",(function(t,e,o){}))},Authorization.prototype.addPolicy=function(t){this.manager.doRequest("admin/restpolicy",(function(t,e,o){}))};var r={forceCreate:!1,defaultUri:null};function Modelling(e){t.setup(this,r,e),this.models=null}Modelling.prototype.__expects=["pollTask","populate"],Modelling.prototype.serviceId="model",Modelling.prototype.init=function(e){t.pass(this,Modelling,"init",e),this.manager=e},Modelling.prototype.doRequest=function(e){var o=this;o.manager.doRequest(e||this.defaultUri||"model",(function(e,i){e&&e.model?o.models=e.model:200==i.status&&(e={model:[]}),t.act(o,o.populate,e.model)}))},Modelling.prototype.getModel=function(t,e){var o=this,reportIt=function(t,o){return e(t&&t.completed>-1?t.result:null,o)},createIt=function(){o.pollTask({url:t,method:"POST"},reportIt)};o.forceCreate?createIt():o.manager.doRequest("model?algorithm="+encodeURIComponent(t),(function(t,o,i){t||404==o.status?t&&0!=t.model.length?e(t.model[0].URI,o,i):createIt():e(null,o,i)}))},Modelling.prototype.runPrediction=function(e,o,i){var n,l=this,r=!1,a=null;n=function(t){r?i(null,t):l.pollTask({url:o,method:"POST",data:{dataset_uri:e}},(function(t,e){r=!0,t&&t.completed>-1&&a(t.result)}))},a=function(e){var o={url:e,method:"GET",dataType:"json"};l.manager.doRequest(o,(function(e,o,l){if(e)if(e&&e.dataEntry&&e.dataEntry.length>0){for(var r=!0,a=0,u=e.dataEntry.length;a<u;++a)if(t.weight(e.dataEntry[a].values)>0){r=!1;break}r?n(o):i(e,o)}else n(o);else i(e,o)}))},l.forceCreate?n():a(l.manager.addUrlParameters(e,"feature_uris[]="+encodeURIComponent(o+"/predicted")))};var a={defaultFilter:null};function Algorithming(e){t.setup(this,a,e),this.algorithms=null}return Algorithming.prototype.__expects=["populate"],Algorithming.prototype.serviceId="algorithm",Algorithming.prototype.init=function(e){t.pass(this,Algorithming,"init",e),this.manager=e},Algorithming.prototype.doRequest=function(t){var e=this,o="algorithm",i=t||this.defaultFilter;i&&(o="algorithm?search="+i),e.manager.doRequest(o,(function(t,o){t&&t.algorithm?e.algorithm=t.algorithm:200==o.status&&(t={algorithm:[]}),e.populate(t.algorithm)}))},o.Paging=Paging,o.Tasking=Tasking,o.Querying=Querying,o.Configuring=function Configuring(t){},o.Authorization=Authorization,o.Modelling=Modelling,o.Algorithming=Algorithming,o}));