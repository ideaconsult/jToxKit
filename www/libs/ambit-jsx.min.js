/** AmbitJsX library - a neXt Ambit queries JavaScript library. Copyright Â© 2019, IDEAConsult Ltd. All rights reserved. @license MIT.*/
!function(t,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o(require("as-sys")):"function"==typeof define&&define.amd?define(["as-sys"],o):(t=t||self).Ambit=o(t.asSys)}(this,(function(t){"use strict";var o={version:"1.0.0"};function Paging(t){}Paging.prototype.nextPage=function(){};var e={pollDelay:250,pollTimeout:15e3};function Tasking(o){t.setup(this,e,o)}function Authorization(o){t.setup(this,Authorization.prototype,o)}Tasking.prototype.init=function(o){t.pass(this,Tasking,"init",o),this.manager=o},Tasking.prototype.pollTask=function(t,o){var e,n,i=this,l=null;n=function(t){"string"==typeof t&&(t={url:t,method:"GET"}),t.error=function(t){o(null,t)},t.success=e,t.dataType="json",i.manager.doRequest(t)},e=function(t,e){null==t||null==t.task||t.task.length<1?o(t,e):(t=t.task[0]).completed>-1||t.error?o(t,e):null==l?(l=Date.now(),setTimeout((function(){n(t.result)}),i.pollDelay)):Date.now()-l>i.poolTimeout?o(t,e):setTimeout((function(){n(t.result)}),i.pollDelay)},n(t)},Authorization.prototype={afterResponse:null,loadRoles(){},loadPolicies(){},addPolicy(t){}};var n={algorithms:!1,forceCreate:!1,loadOnInit:!1,listFilter:null,onLoaded:null};function Modelling(o){t.setup(this,n,o),this.models=null}return Modelling.prototype.__expects=["pollTask"],Modelling.prototype.init=function(o){t.pass(this,Modelling,"init",o),this.manager=o,this.loadOnInit&&this.queryList()},Modelling.prototype.listModels=function(){var o=this;o.manager.doRequest("model",(function(e,n){e&&e.model?o.models=e.model:200==n.status&&(e={model:[]}),t.act(o,o.onLoaded,e)}))},Modelling.prototype.listAlgorithms=function(o){var e=this,n="algorithm";o&&(n+="?search="+o),e.manager.doRequest(n,(function(o,n){o&&o.algorithm?e.algorithm=o.algorithm:200==n.status&&(o={algorithm:[]}),t.act(e,e.onLoaded,o,n)}))},Modelling.prototype.getModel=function(t,o){var e=this,reportIt=function(t,e){return o(t&&t.completed>-1?t.result:null,e)};e.forceCreate?e.pollTask({url:t,method:"POST"},reportIt):e.manager.doRequest("model?algorithm="+encodeURIComponent(t),(function(n,i){n||404==i.status?n&&0!=n.model.length?o(n.model[0].URI,i):e.pollTask({url:t,method:"POST"},reportIt):o(null,i)}))},Modelling.prototype.runPrediction=function(o,e,n){var i=this,l=!1,s=null,createIt=function(t){l?n(null,t):i.pollTask({url:e,method:"POST",data:{dataset_uri:o}},(function(t,o){l=!0,t&&t.completed>-1&&s(t.result)}))};s=function(o){i.manager.connector({url:o,method:"GET",dataType:"json",error:function(t){n(null,t)},success:function(o,e){if(o&&o.dataEntry&&o.dataEntry.length>0){for(var i=!0,l=0,s=o.dataEntry.length;l<s;++l)if(t.weight(o.dataEntry[l].values)>0){i=!1;break}i?createIt(e):n(o,e)}else createIt(e)}})},i.forceCreate?createIt():s(jT.addParameter(o,"feature_uris[]="+encodeURIComponent(e+"/predicted")))},Modelling.prototype.queryList=function(t){this.algorithms?this.listAlgorithms(this.listFilter=t||this.listFilter):this.listModels(this.modelUri)},o.Paging=Paging,o.Tasking=Tasking,o.Authorization=Authorization,o.Modelling=Modelling,o}));