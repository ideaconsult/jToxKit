/** AmbitJsX library - a neXt Ambit queries JavaScript library. Copyright Â© 2019, IDEAConsult Ltd. All rights reserved. @license MIT.*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("as-sys")):"function"==typeof define&&define.amd?define(["as-sys"],e):(t=t||self).Ambit=e(t.asSys)}(this,(function(t){"use strict";var e={version:"1.0.0"};function Paging(t){}Paging.prototype.nextPage=function(){};var o={pollDelay:250,pollTimeout:15e3};function Tasking(e){t.setup(this,o,e)}function Authorization(e){t.setup(this,Authorization.prototype,e)}function Modelling(e){t.setup(this,Modelling.prototype,e),this.models=null}return Tasking.prototype.init=function(e){t.pass(this,Tasking,"init",e),this.manager=e},Tasking.prototype.pollTask=function(t,e){var o,n,i=this,l=null;n=function(t){"string"==typeof t&&(t={url:t,method:"GET"}),t.error=function(t){e(null,t)},t.success=o,t.dataType="json",i.manager.doRequest(t)},o=function(t,o){null==t||null==t.task||t.task.length<1?e(t,o):(t=t.task[0]).completed>-1||t.error?e(t,o):null==l?(l=Date.now(),setTimeout((function(){n(t.result)}),i.pollDelay)):Date.now()-l>i.poolTimeout?e(t,o):setTimeout((function(){n(t.result)}),i.pollDelay)},n(t)},Authorization.prototype={afterResponse:null,loadRoles(){},loadPolicies(){},addPolicy(t){}},Modelling.prototype={__expects:["pollTask"],algorithms:!1,forceCreate:!1,loadOnInit:!1,listFilter:null,onLoaded:null,init:function(e){t.pass(this,jT.Modelling,"init",e),this.manager=e,this.loadOnInit&&this.queryList()},listModels:function(){var e=this;e.manager.doRequest("model",(function(o,n){o&&o.model?e.models=o.model:200==n.status&&(o={model:[]}),t.act(e,e.onLoaded,o)}))},listAlgorithms:function(e){var o=this,n="algorithm";e&&(n+="?search="+e),o.manager.doRequest(n,(function(e,n){e&&e.algorithm?o.algorithm=e.algorithm:200==n.status&&(e={algorithm:[]}),t.act(o,o.onLoaded,e,n)}))},getModel:function(t,e){var o=this,reportIt=function(t,o){return e(t&&t.completed>-1?t.result:null,o)};o.forceCreate?o.pollTask({url:t,method:"POST"},reportIt):o.manager.doRequest("model?algorithm="+encodeURIComponent(t),(function(n,i){n||404==i.status?n&&0!=n.model.length?e(n.model[0].URI,i):o.pollTask({url:t,method:"POST"},reportIt):e(null,i)}))},runPrediction:function(e,o,n){var i=this,l=!1,s=null,createIt=function(t){l?n(null,t):i.pollTask({url:o,method:"POST",data:{dataset_uri:e}},(function(t,e){l=!0,t&&t.completed>-1&&s(t.result)}))};s=function(e){i.manager.connector({url:e,method:"GET",dataType:"json",error:function(t){n(null,t)},success:function(e,o){if(e&&e.dataEntry&&e.dataEntry.length>0){for(var i=!0,l=0,s=e.dataEntry.length;l<s;++l)if(t.weight(e.dataEntry[l].values)>0){i=!1;break}i?createIt(o):n(e,o)}else createIt(o)}})},i.forceCreate?createIt():s(jT.ui.addParameter(e,"feature_uris[]="+encodeURIComponent(o+"/predicted")))},queryList:function(t){this.algorithms?this.listAlgorithms(this.listFilter=t||this.listFilter):this.listModels(this.modelUri)}},e.Paging=Paging,e.Tasking=Tasking,e.Authorization=Authorization,e.Modelling=Modelling,e}));