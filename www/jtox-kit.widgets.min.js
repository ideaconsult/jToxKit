!function(t,i,e){t.ui=i.extend(t.ui,{templates:{},fillTemplate:function(i,n){return e(t.ui.formatString(e(i).html(),n).replace(/(<img(\s+.*)?)(\s+jt-src=")/,'$1 src="'))},fillTree:function(t,n){e(".data-field",t).each(function(){var t=e(this),s=i.path(n,t.data("field"));s!==undefined&&t.html(s)})},updateCounter:function(t,i,e){var n=null,s="";return null==i&&(i=0),null==e?(n=/\(([\d\?]+)\)$/,s=""+i):(n=/\(([\d\?]+\/[\d\?\+-]+)\)$/,s=i+"/"+e),t.match(n)?t=t.replace(n,"("+s+")"):t+=" ("+s+")",t},enterBlur:function(t){13==t.keyCode&&this.blur()},fixBaseUrl:function(t){return null!=t&&"/"==t.charAt(t.length-1)&&(t=t.slice(0,-1)),t},grabBaseUrl:function(t,i){if(null!=t){if(i)return t.slice(0,t.indexOf("/"+i));if(0==t.indexOf("http"))return this.formBaseUrl(this.parseURL(t))}return this.settings.baseUrl},formBaseUrl:function(t){var i=t.host?t.protocol+"://"+t.host+(t.port.length>0?":"+t.port:"")+"/"+t.segments[0]:null;return console.log("Deduced base URL: "+i+" (from: "+t.source+")"),i},copyToClipboard:function(t,i){i||(i="Press Ctrl-C (Command-C) to copy and then Enter."),window.prompt(i,t)}}),t.ui=i.extend(t.ui,{rootSettings:{},kitsMap:{},templateRoot:null,callId:0,initKit:function(n){var s=this,a=n.data(),o=a.kit,r=e.extend(!0,{},s.rootSettings);parent=null,i.each(n.parents(".jtox-kit,.jtox-widget").toArray().reverse(),function(t){parent=s.kit(t),null!=parent&&(r=e.extend(!0,r,parent))}),parent||(parent=s),(a=e.extend(!0,r,a)).baseUrl=s.fixBaseUrl(a.baseUrl),a.target=n,a.id===undefined&&(a.id=n.attr("id"));var l=function(i,e){if(!o)return null;var n=window[o];"function"!=typeof n&&(o=o.charAt(0).toUpperCase()+o.slice(1),n=t.ui[o]||t[o]);var r=null;return"function"==typeof n?r=new n(i):"object"==typeof n&&"function"==typeof n.init&&(r=n.init(i)),null!=r?(n.prototype.__kits===undefined&&(n.prototype.__kits=[]),n.prototype.__kits.push(r),r.parentKit=parent,null!==a.id&&(s.kitsMap[a.id]=r)):console.log("jToxError: trying to initialize unexistent jTox kit: "+o),r};if(null!=a.configFile)e.ajax({settings:"GET",url:a.configFile},function(t){t&&e.extend(!0,a,t),n.data("jtKit",l(a))});else{if("string"==typeof a.configuration&&window[a.configuration]){var u=window[a.configuration];e.extend(!0,a,"function"==typeof u?u.call(o,a,o):u)}n.data("jtKit",l(a))}},initialize:function(t){var i=this;if(!t){i.initTemplates(),e(document).on("click",".jtox-kit span.ui-icon-copy",function(){return this.copyToClipboard(e(this).data("uuid")),!1}),e(document).on("click",".jtox-foldable>.title",function(t){e(this).parent().toggleClass("folded")}),e(document).on("click",".jtox-diagram span.ui-icon",function(){e(this).toggleClass("ui-icon-zoomin").toggleClass("ui-icon-zoomout"),e("img",this.parentNode).toggleClass("jtox-smalldiagram")});var n=this.parseURL(document.location),s=n.params;i.rootSettings.baseUrl?s.baseUrl&&(s.baseUrl=i.fixBaseUrl(s.baseUrl)):s.baseUrl=i.formBaseUrl(n),i.rootSettings=e.extend(!0,i.rootSettings,s),i.fullUrl=n,t=document}var a=function(){e(this).data("manualInit")||i.initKit(e(this))};e(".jtox-kit",t).each(a),e(".jtox-widget",t).each(a)},kit:function(t){return"string"!=typeof t?e(t).data("jtKit"):this.kitsMap[t]!==undefined?this.kitsMap[t]:e("#"+t).data("jtKit")},attachKit:function(t,i){return e(t).data("jtKit",i)},parentKit:function(t,i){var n=this,s=null;return"string"==typeof t&&(t=window[t]),e(i).parents(".jtox-kit").each(function(){var i=n.kit(this);i&&!s&&(!t||i instanceof t)&&(s=i)}),s},initTemplates:function(){var t=this,i=e(".jtox-template")[0];i||((i=document.createElement("div")).className="jtox-template",document.body.appendChild(i));var n=i.innerHTML;for(var s in t.templates)n+=t.templates[s];i.innerHTML=n,t.templateRoot=i},insertTool:function(t,i){var e=this.tools[t];return null!=e&&(i.innerHTML=e,this.init(i)),i},installHandlers:function(i,e){null==e&&(e=i.rootElement),t.$(".jtox-handler",e).each(function(){var e=t.$(this).data("handler"),n=null;null!=i.settings.configuration&&null!=i.settings.configuration.handlers&&(n=i.settings.configuration.handlers[e]),(n=n||window[e])?"INPUT"==this.tagName||"SELECT"==this.tagName||"TEXTAREA"==this.tagName?t.$(this).on("change",n).on("keydown",t.ui.enterBlur):t.$(this).on("click",n):console.log("jToxQuery: referring unknown handler: "+e)})}}),t.ListWidget=function(t){i.extend(!0,this,i.common(t,this)),this.target=e(t.target),this.length=0,this.clearItems()},t.ListWidget.prototype={itemId:"id",populate:function(t,i){this.items=t,this.length=t.length,this.target.empty();for(var e=0,n=t.length;e<n;e++)this.target.append(this.renderItem("function"==typeof i?i(t[e]):t[e]))},addItem:function(t){return this.items.push(t),++this.length,this.renderItem(t)},clearItems:function(){this.target.empty(),this.items=[],this.length=0},findItem:function(t){var e=this;return i.findIndex(this.items,"string"!=typeof t?t:function(i){return i[e.itemId]===t})},eraseItem:function(t){var i=this.findItem(t),e=i>=0&&this.items.splice(i,1)[0];return this.length=this.items.length,e},enumerateItems:function(t){for(var i=this.target.children(),e=0,n=this.items.length;e<n;++e)t.call(i[e],this.items[e])}},t.TagWidget=function(t){i.extend(!0,this,i.common(t,this)),this.target=e(t.target),this.subtarget&&(this.target=this.target.find(this.subtarget).eq(0)),this.id=t.id,this.color=this.color||this.target.data("color"),this.color&&this.target.addClass(this.color)},t.TagWidget.prototype={__expects:["hasValue","clickHandler"],color:null,renderItem:null,onUpdated:null,subtarget:null,init:function(e){i.pass(this,t.TagWidget,"init",e),this.manager=e},populate:function(t,e){var n,s,a,o=this,r=null,l=0;if(null==t.length||0==t.length)e||this.target.html("No items found in this selection").addClass("jt-no-tags");else{t.sort(function(t,i){return(t.value||t.val)<(i.value||i.val)?-1:1}),e||this.target.empty();for(var u=0,h=t.length;u<h;u++)a=(r=t[u]).value||r.val,s=this.exclusion&&this.hasValue(a),l+=r.count,r.title=a.toString(),"function"==typeof this.modifyTag&&(r=this.modifyTag(r)),s||(r.onMain=o.clickHandler(a)),this.target.append(n=this.renderItem(r)),s&&n.addClass("selected")}i.act(this,this.onUpdated,l)}};var n={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,echoParams:"none"};t.AutocompleteWidget=function(t){i.extend(!0,this,i.common(t,this)),this.target=e(t.target),this.id=t.id,this.lookupMap=t.lookupMap||{},this.parameters=i.extend(!0,{},n),this.facetPath=this.useJson?"facets":"facet_counts.facet_fields",this.useJson||(this.parameters["json.nl"]="map")},t.AutocompleteWidget.prototype={__expects:["addValue","doSpying"],servlet:"autophrase",urlFeed:null,useJson:!1,maxResults:30,activeFacets:null,init:function(n){i.pass(this,t.AutocompleteWidget,"init",n),this.manager=n;var s=this;if(s.findBox=this.target.find("input").on("change",function(t){var i=e(this);s.addValue(i.val())&&!s.requestSent&&(i.blur().autocomplete("disable"),n.doRequest())}),null!=s.urlFeed){var a=e.url().param(s.urlFeed);s.addValue(a),s.findBox.val(a)}s.findBox.autocomplete({minLength:0,source:function(t,i){s.reportCallback=i,s.makeRequest(t.term)},select:function(t,i){i.item&&(s.requestSent=!0,n.getListener(i.item.id).addValue(i.item.value)&&n.doRequest())}})},makeRequest:function(t){var i=this;this.doSpying(function(e){e.removeParameters("fl"),e.mergeParameters(i.parameters),i.addValue(t||"")},function(t){i.onResponse(t)})},onResponse:function(t){var e=this,n=[];i.each(i.path(t,this.facetPath),function(t,s){n.length>=e.maxResults||"object"!=typeof t||e.activeFacets&&!1===e.activeFacets[s]||i.each(e.useJson?t.buckets:t,function(t,i){n.length>=e.maxResults||(e.useJson||(t={val:i,count:t}),n.push({id:s,value:t.val,label:(e.lookupMap[t.val]||t.val)+" ("+t.count+") - "+s}))})}),"function"==typeof this.reportCallback&&e.reportCallback(n)},afterRequest:function(t){var i=this.manager.getParameter("q").value||"";this.findBox.val("*:*"!=i&&i.length>0?i:"").autocomplete("enable"),this.requestSent=!1}},t.SimpleItemWidget=function(t){i.extend(!0,this,i.common(t,this)),this.target=e(t.target)},t.SimpleItemWidget.prototype={template:null,classes:null,renderItem:function(i){return t.ui.fillTemplate(template,i).addClass(this.classes)}},t.AccordionExpansion=function(t){i.extend(!0,this,i.common(t,this)),this.target=e(t.target),this.header=null,this.id=t.id,this.automatic&&(t.target=this.makeExpansion())},t.AccordionExpansion.prototype={automatic:!0,title:null,classes:null,expansionTemplate:null,before:null,renderExpansion:function(i){return t.ui.fillTemplate(this.expansionTemplate,i).addClass(this.classes)},makeExpansion:function(t,i){if(!this.header){i||(i=this),t||(t=this.before);var n=this.renderExpansion(i);return this.accordion=this.target,t?"number"==typeof t?this.accordion.children().eq(t).before(n):"string"==typeof t?e(t,this.accordion[0]).before(n):e(t).before(n):this.accordion.append(n),this.refresh(),this.header=e("#"+this.id+"_header"),this.target=e("#"+this.id)}},getHeaderText:function(){return this.header.contents().filter(function(){return 3==this.nodeType})[0]},refresh:function(){this.accordion.accordion("refresh")}},t.SliderWidget=function(t){i.extend(!0,this,i.common(t,this)),this.target=e(t.target),this.prepareLimits(t.limits),null==this.initial&&(this.initial=this.isRange?[this.limits[0],this.limits[1]]:(this.limits[0]+this.limits[1])/2),this.target.val(Array.isArray(this.initial)?this.initial.join(","):this.initial),this.automatic&&this.makeSlider()},t.SliderWidget.prototype={__expects:["updateHandler"],limits:null,units:null,initial:null,title:null,width:null,automatic:!0,isRange:!0,showScale:!0,format:"%s {{units}}",prepareLimits:function(t){this.limits="string"==typeof t?t.split(","):t,this.limits[0]=parseFloat(this.limits[0]),this.limits[1]=parseFloat(this.limits[1]),this.precision=Math.pow(10,parseInt(Math.min(1,Math.floor(Math.log10(this.limits[1]-this.limits[0]+1)-3)))),this.precision<1&&this.precision>.01&&(this.precison=.01)},updateSlider:function(t,i){Array.isArray(t)&&(t=t.join(",")),null!=i?(this.prepareLimits(i),this.target.jRange("updateRange",this.limits,t)):this.target.jRange("setValue",t)},makeSlider:function(){var i=this,e=this.limits[1]>this.limits[0],n=[t.ui.formatNumber(this.limits[0],this.precision),this.title+(e||!this.units?"":" ("+this.units+")"),t.ui.formatNumber(this.limits[1],this.precision)],s=i.updateHandler(),a={from:this.limits[0],to:this.limits[1],step:this.precision,scale:n,showScale:this.showScale,showLabels:e,disable:!e,isRange:this.isRange,width:this.width,format:t.ui.formatString(this.format,this)||""};return null!=this.color&&(a.theme="theme-"+this.color),a.ondragend=function(t){return"string"==typeof t&&i.isRange&&(t=t.split(",")),t=Array.isArray(t)?t.map(function(t){return parseFloat(t)}):parseFloat(t),s(t)},this.target.jRange(a)}},t.Switching=function(t){i.extend(!0,this,i.common(t,this));var n=this;n.target=e(n.selector,e(t.target)[0]).on("change",function(t){var s=e(this).val();"toggle"==mode&&i.path(n,n.field,"true"==s||"on"==s)})},t.Switching.prototype={mode:"toggle",selector:".switcher",field:null}}(jToxKit,asSys,jQuery);