!function(r,h,l){r.ui=h.extend(r.ui,{templates:{},fillTemplate:function(t,i){return l(r.ui.formatString(l(t).html(),i).replace(/(<img(\s+.*)?)(\s+jt-src=")/,'$1 src="'))},fillTree:function(t,e){l(".data-field",t).each(function(){var t=l(this),i=h.path(e,t.data("field"));i!==undefined&&t.html(i)})},updateCounter:function(t,i,e){var n=null,s="";return null==i&&(i=0),null==e?(n=/\(([\d\?]+)\)$/,s=""+i):(n=/\(([\d\?]+\/[\d\?\+-]+)\)$/,s=i+"/"+e),t.match(n)?t=t.replace(n,"("+s+")"):t+=" ("+s+")",t},enterBlur:function(t){13==t.keyCode&&this.blur()},fixBaseUrl:function(t){return null!=t&&"/"==t.charAt(t.length-1)&&(t=t.slice(0,-1)),t},grabBaseUrl:function(t,i){if(null!=t){if(i)return t.slice(0,t.indexOf("/"+i));if(0==t.indexOf("http"))return this.formBaseUrl(this.parseURL(t))}return this.settings.baseUrl},formBaseUrl:function(t){var i=t.host?t.protocol+"://"+t.host+(0<t.port.length?":"+t.port:"")+"/"+t.segments[0]:null;return console.log("Deduced base URL: "+i+" (from: "+t.source+")"),i},copyToClipboard:function(t,i){i||(i="Press Ctrl-C (Command-C) to copy and then Enter."),window.prompt(i,t)}}),r.ui=h.extend(r.ui,{rootSettings:{},kitsMap:{},templateRoot:null,callId:0,initKit:function(i){var s=this,a=i.data(),o=a.kit,e=l.extend(!0,{},s.rootSettings);parent=null,h.each(i.parents(".jtox-kit,.jtox-widget").toArray().reverse(),function(t){parent=s.kit(t),null!=parent&&(e=l.extend(!0,e,parent))}),parent||(parent=s),(a=l.extend(!0,e,a)).baseUrl=s.fixBaseUrl(a.baseUrl),a.target=i,a.id===undefined&&(a.id=i.attr("id"));var n=function(t,i){if(!o)return null;var e=window[o];"function"!=typeof e&&(o=o.charAt(0).toUpperCase()+o.slice(1),e=r.ui[o]||r[o]);var n=null;return"function"==typeof e?n=new e(t):"object"==typeof e&&"function"==typeof e.init&&(n=e.init(t)),null!=n?(e.prototype.__kits===undefined&&(e.prototype.__kits=[]),e.prototype.__kits.push(n),n.parentKit=parent,null!==a.id&&(s.kitsMap[a.id]=n)):console.log("jToxError: trying to initialize unexistent jTox kit: "+o),n};if(null!=a.configFile)l.ajax({settings:"GET",url:a.configFile},function(t){t&&l.extend(!0,a,t),i.data("jtKit",n(a))});else{if("string"==typeof a.configuration&&window[a.configuration]){var t=window[a.configuration];l.extend(!0,a,"function"==typeof t?t.call(o,a,o):t)}i.data("jtKit",n(a))}},initialize:function(t){var i=this;if(!t){i.initTemplates(),l(document).on("click",".jtox-kit span.ui-icon-copy",function(){return this.copyToClipboard(l(this).data("uuid")),!1}),l(document).on("click",".jtox-foldable>.title",function(t){l(this).parent().toggleClass("folded")}),l(document).on("click",".jtox-diagram span.ui-icon",function(){l(this).toggleClass("ui-icon-zoomin").toggleClass("ui-icon-zoomout"),l("img",this.parentNode).toggleClass("jtox-smalldiagram")});var e=this.parseURL(document.location),n=e.params;i.rootSettings.baseUrl?n.baseUrl&&(n.baseUrl=i.fixBaseUrl(n.baseUrl)):n.baseUrl=i.formBaseUrl(e),i.rootSettings=l.extend(!0,i.rootSettings,n),i.fullUrl=e,t=document}var s=function(){l(this).data("manualInit")||i.initKit(l(this))};l(".jtox-kit",t).each(s),l(".jtox-widget",t).each(s)},kit:function(t){return"string"!=typeof t?l(t).data("jtKit"):this.kitsMap[t]!==undefined?this.kitsMap[t]:l("#"+t).data("jtKit")},attachKit:function(t,i){return l(t).data("jtKit",i)},parentKit:function(i,t){var e=this,n=null;return"string"==typeof i&&(i=window[i]),l(t).parents(".jtox-kit").each(function(){var t=e.kit(this);t&&!n&&(!i||t instanceof i)&&(n=t)}),n},initTemplates:function(){var t=this,i=l(".jtox-template")[0];i||((i=document.createElement("div")).className="jtox-template",document.body.appendChild(i));var e=i.innerHTML;for(var n in t.templates)e+=t.templates[n];i.innerHTML=e,t.templateRoot=i},insertTool:function(t,i){var e=this.tools[t];return null!=e&&(i.innerHTML=e,this.init(i)),i},installHandlers:function(e,t){null==t&&(t=e.rootElement),r.$(".jtox-handler",t).each(function(){var t=r.$(this).data("handler"),i=null;null!=e.settings.configuration&&null!=e.settings.configuration.handlers&&(i=e.settings.configuration.handlers[t]),(i=i||window[t])?"INPUT"==this.tagName||"SELECT"==this.tagName||"TEXTAREA"==this.tagName?r.$(this).on("change",i).on("keydown",r.ui.enterBlur):r.$(this).on("click",i):console.log("jToxQuery: referring unknown handler: "+t)})}}),r.ListWidget=function(t){h.extend(!0,this,h.common(t,this)),this.target=l(t.target),this.length=0,this.clearItems()},r.ListWidget.prototype={itemId:"id",populate:function(t,i){this.items=t,this.length=t.length,this.target.empty();for(var e=0,n=t.length;e<n;e++)this.target.append(this.renderItem("function"==typeof i?i(t[e]):t[e]))},addItem:function(t){return this.items.push(t),++this.length,this.renderItem(t)},clearItems:function(){this.target.empty(),this.items=[],this.length=0},findItem:function(i){var e=this;return h.findIndex(this.items,"string"!=typeof i?i:function(t){return t[e.itemId]===i})},eraseItem:function(t){var i=this.findItem(t),e=0<=i&&this.items.splice(i,1)[0];return this.length=this.items.length,e},enumerateItems:function(t){for(var i=this.target.children(),e=0,n=this.items.length;e<n;++e)t.call(i[e],this.items[e])}},r.TagWidget=function(t){h.extend(!0,this,h.common(t,this)),this.target=l(t.target),this.subtarget&&(this.target=this.target.find(this.subtarget).eq(0)),this.id=t.id,this.color=this.color||this.target.data("color"),this.color&&this.target.addClass(this.color)},r.TagWidget.prototype={__expects:["hasValue","clickHandler"],color:null,renderItem:null,onUpdated:null,subtarget:null,init:function(t){h.pass(this,r.TagWidget,"init",t),this.manager=t},populate:function(t,i){var e,n,s,a=null,o=0;if(null==t.length||0==t.length)i||this.target.html("No items found in this selection").addClass("jt-no-tags");else{this.target.removeClass("jt-no-tags"),t.sort(function(t,i){return(t.value||t.val)<(i.value||i.val)?-1:1}),i||this.target.empty();for(var r=0,l=t.length;r<l;r++)s=(a=t[r]).value||a.val,n=this.exclusion&&this.hasValue(s),o+=a.count,a.title=s.toString(),"function"==typeof this.modifyTag&&(a=this.modifyTag(a)),n||(a.onMain=this.clickHandler(s)),this.target.append(e=this.renderItem(a)),n&&e.addClass("selected")}h.act(this,this.onUpdated,o)}};var i={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,echoParams:"none"};r.AutocompleteWidget=function(t){h.extend(!0,this,h.common(t,this)),this.target=l(t.target),this.id=t.id,this.lookupMap=t.lookupMap||{},this.parameters=h.extend(!0,{},i),this.facetPath=this.useJson?"facets":"facet_counts.facet_fields",this.useJson||(this.parameters["json.nl"]="map")},r.AutocompleteWidget.prototype={__expects:["addValue","doSpying"],servlet:"autophrase",urlFeed:null,useJson:!1,maxResults:30,activeFacets:null,init:function(e){h.pass(this,r.AutocompleteWidget,"init",e),this.manager=e;var n=this;if(n.findBox=this.target.find("input").on("change",function(t){var i=l(this);n.addValue(i.val())&&!n.requestSent&&(i.blur().autocomplete("disable"),e.doRequest())}),null!=n.urlFeed){var t=l.url().param(n.urlFeed);n.addValue(t),n.findBox.val(t)}n.findBox.autocomplete({minLength:0,source:function(t,i){n.reportCallback=i,n.makeRequest(t.term)},select:function(t,i){i.item&&(n.requestSent=!0,e.getListener(i.item.id).addValue(i.item.value)&&e.doRequest())}})},makeRequest:function(i){var e=this;this.doSpying(function(t){t.removeParameters("fl"),t.mergeParameters(e.parameters),e.addValue(i||"")},function(t){e.onResponse(t)})},onResponse:function(t){var n=this,s=[];h.each(h.path(t,this.facetPath),function(t,e){s.length>=n.maxResults||"object"!=typeof t||n.activeFacets&&!1===n.activeFacets[e]||h.each(n.useJson?t.buckets:t,function(t,i){s.length>=n.maxResults||(n.useJson||(t={val:i,count:t}),s.push({id:e,value:t.val,label:(n.lookupMap[t.val]||t.val)+" ("+t.count+") - "+e}))})}),"function"==typeof this.reportCallback&&n.reportCallback(s)},afterRequest:function(t){var i=this.manager.getParameter("q").value||"";this.findBox.val("*:*"!=i&&0<i.length?i:"").autocomplete("enable"),this.requestSent=!1}},r.SimpleItemWidget=function(t){h.extend(!0,this,h.common(t,this)),this.target=l(t.target)},r.SimpleItemWidget.prototype={template:null,classes:null,renderItem:function(t){return r.ui.fillTemplate(template,t).addClass(this.classes)}},r.AccordionExpansion=function(t){h.extend(!0,this,h.common(t,this)),this.target=l(t.target),this.header=null,this.id=t.id,this.automatic&&(t.target=this.makeExpansion())},r.AccordionExpansion.prototype={automatic:!0,title:null,classes:null,expansionTemplate:null,before:null,renderExpansion:function(t){return r.ui.fillTemplate(this.expansionTemplate,t).addClass(this.classes)},makeExpansion:function(t,i){if(!this.header){i||(i=this),t||(t=this.before);var e=this.renderExpansion(i);return this.accordion=this.target,t?"number"==typeof t?this.accordion.children().eq(t).before(e):"string"==typeof t?l(t,this.accordion[0]).before(e):l(t).before(e):this.accordion.append(e),this.refresh(),this.header=l("#"+this.id+"_header"),this.target=l("#"+this.id)}},getHeaderText:function(){return this.header.contents().filter(function(){return 3==this.nodeType})[0]},refresh:function(){this.accordion.accordion("refresh")}},r.SliderWidget=function(t){h.extend(!0,this,h.common(t,this)),this.target=l(t.target),this.prepareLimits(t.limits),null==this.initial&&(this.initial=this.isRange?[this.limits[0],this.limits[1]]:(this.limits[0]+this.limits[1])/2),this.target.val(Array.isArray(this.initial)?this.initial.join(","):this.initial),this.automatic&&this.makeSlider()},r.SliderWidget.prototype={__expects:["updateHandler"],limits:null,units:null,initial:null,title:null,width:null,automatic:!0,isRange:!0,showScale:!0,format:"%s {{units}}",prepareLimits:function(t){this.limits="string"==typeof t?t.split(","):t,this.limits[0]=parseFloat(this.limits[0]),this.limits[1]=parseFloat(this.limits[1]),this.precision=Math.pow(10,parseInt(Math.min(1,Math.floor(Math.log10(this.limits[1]-this.limits[0]+1)-3)))),this.precision<1&&.01<this.precision&&(this.precison=.01)},updateSlider:function(t,i){Array.isArray(t)&&(t=t.join(",")),null!=i?(this.prepareLimits(i),this.target.jRange("updateRange",this.limits,t)):this.target.jRange("setValue",t)},makeSlider:function(){var i=this,t=this.limits[1]>this.limits[0],e=[r.ui.formatNumber(this.limits[0],this.precision),this.title+(t||!this.units?"":" ("+this.units+")"),r.ui.formatNumber(this.limits[1],this.precision)],n=i.updateHandler(),s={from:this.limits[0],to:this.limits[1],step:this.precision,scale:e,showScale:this.showScale,showLabels:t,disable:!t,isRange:this.isRange,width:this.width,format:r.ui.formatString(this.format,this)||""};return null!=this.color&&(s.theme="theme-"+this.color),s.ondragend=function(t){return"string"==typeof t&&i.isRange&&(t=t.split(",")),t=Array.isArray(t)?t.map(function(t){return parseFloat(t)}):parseFloat(t),n(t)},this.target.jRange(s)}},r.Switching=function(t){h.extend(!0,this,h.common(t,r.Switching.prototype));var e=this,i=l(e.switchSelector,l(t.target)[0]),n=h.path(e,e.switchField);"boolean"==typeof n?i[0].checked=n:i.val(n),i.on("change",function(t){var i=l(this).val();h.path(e,e.switchField,"boolean"==typeof n?this.checked||"on"===i:i),h.act(e,e.onSwitching,t),t.stopPropagation()})},r.Switching.prototype={switchSelector:".switcher",switchField:null,onSwitching:null},r.Running=function(t){h.extend(!0,this,h.common(t,r.Running.prototype));var i=this,e=l(i.runSelector,l(t.target)[0]),n=i.runTarget||i;e.on("click",function(t){h.act(n,i.runMethod,this,t),t.stopPropagation()})},r.Running.prototype={runSelector:".switcher",runMethod:null,runTarget:null}}(jToxKit,asSys,jQuery);