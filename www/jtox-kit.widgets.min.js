!function(t,e,i){t.ui=e.extend(t.ui,{fillTemplate:function(e,n){return i(t.ui.formatString(i(e).html(),n).replace(/(<img(\s+.*)?)(\s+jt-src=")/,'$1 src="'))},updateCounter:function(t,e,i){var n=null,s="";return null==e&&(e=0),null==i?(n=/\(([\d\?]+)\)$/,s=""+e):(n=/\(([\d\?]+\/[\d\?\+-]+)\)$/,s=""+e+"/"+i),t.match(n)?t=t.replace(n,"("+s+")"):t+=" ("+s+")",t}}),t.ListWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.length=0,this.clearItems()},t.ListWidget.prototype={itemId:"id",populate:function(t,e){this.items=t,this.length=t.length,this.target.empty();for(var i=0,n=t.length;i<n;i++)this.target.append(this.renderItem("function"==typeof e?e(t[i]):t[i]))},addItem:function(t){return this.items.push(t),++this.length,this.renderItem(t)},clearItems:function(){this.target.empty(),this.items=[],this.length=0},findItem:function(t){var i=this;return e.findIndex(this.items,"string"!=typeof t?t:function(e){return e[i.itemId]===t})},eraseItem:function(t){var e=this.findItem(t),i=e>=0&&this.items.splice(e,1)[0];return this.length=this.items.length,i},enumerateItems:function(t){for(var e=this.target.children(),i=0,n=this.items.length;i<n;++i)t.call(e[i],this.items[i])}},t.TagWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.subtarget&&(this.target=this.target.find(this.subtarget).eq(0)),this.id=t.id,this.color=this.color||this.target.data("color"),this.color&&this.target.addClass(this.color)},t.TagWidget.prototype={__expects:["hasValue","clickHandler"],color:null,renderItem:null,onUpdated:null,subtarget:null,init:function(i){e.pass(this,t.TagWidget,"init",i),this.manager=i},populate:function(t){var i,n,s,a=this,r=null,o=0;if(t.sort(function(t,e){return(t.value||t.val)<(e.value||e.val)?-1:1}),0==t.length)this.target.html("No items found in current selection");else{this.target.empty();for(var l=0,h=t.length;l<h;l++)r=t[l],s=r.value||r.val,n=this.hasValue(s),o+=r.count,r.title=s.toString(),"function"==typeof this.modifyTag&&(r=this.modifyTag(r)),n||(r.onMain=a.clickHandler(s)),this.target.append(i=this.renderItem(r)),n&&i.addClass("selected")}e.act(this,this.onUpdated,o)}};var n={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,"json.nl":"map",echoParams:"none"};t.AutocompleteWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.delayed=null,this.fqName=this.useJson?"json.filter":"fq",this.spyManager=new t.SpyManager({parameters:e.extend(!0,n,t.parameters)});var s=this;e.each(t.groups,function(t){s.spyManager.addParameter("facet.field",t.field,e.extend(!0,{key:t.id},t.facet.domain))})},t.AutocompleteWidget.prototype={__expects:["doRequest","setValue"],servlet:"autophrase",useJson:!1,maxResults:30,groups:{},init:function(n){e.pass(this,t.AutocompleteWidget,"init",n),this.manager=n;var s=this;s.findBox=this.target.find("input").on("change",function(t){var e=i(this);s.setValue(e.val())&&!s.requestSent&&(e.blur().autocomplete("disable"),s.manager.doRequest())}),s.findBox.autocomplete({minLength:0,source:function(t,e){s.reportCallback=e,s.makeRequest(t.term,function(t){s.onResponse(t)},function(t,i,n){e(["Err : '"+i+"!"])})},select:function(t,e){e.item&&(s.requestSent=!0,n.getListener(e.item.id).addValue(e.item.value)&&n.doRequest())}})},makeRequest:function(t,i,n){var s=this.manager.getParameter(this.fqName);this.spyManager.removeParameters("fq");for(var a=0,r=s.length;a<r;++a)this.spyManager.addParameter("fq",s[a].value);this.spyManager.addParameter("q",t||"*:*");var o=e.extend(o,this.manager.ajaxSettings,this.spyManager.prepareQuery());return o.url=this.manager.solrUrl+(this.servlet||this.manager.servlet)+o.url+"&wt=json&json.wrf=?",o.success=i,o.error=n,this.manager.connector.ajax(o)},onResponse:function(t){var i=this,n=[];e.each(this.groups,function(e){if(!(n.length>=i.maxResults))for(var s in t.facet_counts.facet_fields[e.id])if(n.push({id:e.id,value:s,label:(lookup[s]||s)+" ("+t.facet_counts.facet_fields[e.id][s]+") - "+e.id}),n.length>=i.maxResults)break}),"function"==typeof this.reportCallback&&i.reportCallback(n)},afterRequest:function(t){var e=this.manager.getParameter("q").value;this.findBox.val("*:*"!=e&&e.length>0?e:"").autocomplete("enable"),this.requestSent=!1}},t.SimpleItemWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target)},t.SimpleItemWidget.prototype={template:null,classes:null,renderItem:function(e){return t.ui.fillTemplate(template,e).addClass(this.classes)}},t.AccordionExpansion=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.header=null,this.automatic&&(t.target=this.makeExpansion())},t.AccordionExpansion.prototype={automatic:!0,title:null,hdrClasses:null,mainClasses:null,template:null,renderExpansion:function(e){return t.ui.fillTemplate(this.template,e).addClass(this.classes)},makeExpansion:function(t,e){if(!this.header){this.title=e||this.title||this.id;var n=this.renderExpansion(this);return this.accordion=this.target,t?"number"==typeof t?this.accordion.children().eq(t).before(n):"string"==typeof t?i(t,this.accordion[0]).before(n):i(t).before(n):this.accordion.append(n),this.refresh(),this.header=i("#"+this.id+"_header"),this.target=i("#"+this.id)}},getHeaderText:function(){return this.header.contents().filter(function(){return 3==this.nodeType})[0]},refresh:function(){this.accordion.accordion("refresh")}}}(jToxKit,asSys,jQuery);
