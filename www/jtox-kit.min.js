/** jToxKit - Chem-informatics UI tools, widgets and kits library. Copyright Â© 2016-2019, IDEAConsult Ltd. All rights reserved. @license MIT.*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("lodash"),require("as-sys"),require("solr-jsx"),require("ambit-jsx"),require("jquery")):"function"==typeof define&&define.amd?define(["lodash","as-sys","solr-jsx","ambit-jsx","jquery"],e):(t=t||self).jToxKit=e(t._,t.asSys,t.Solr,t.Ambit,t.$)}(this,(function(t,e,i,n,r){"use strict";var a={version:"3.0.0",fixBaseUrl:t=>(null!=t&&"/"==t.charAt(t.length-1)&&(t=t.slice(0,-1)),t),grabBaseUrl(t,e){if(null!=t){if(e)return t.slice(0,t.indexOf("/"+e));if(0==t.indexOf("http"))return this.formBaseUrl(this.parseURL(t))}return this.settings.baseUrl},formBaseUrl(t){var e=t.host?t.protocol+"://"+t.host+(t.port.length>0?":"+t.port:"")+"/"+t.segments[0]:null;return console&&console.log("Deduced base URL: "+e+" (from: "+t.source+")"),e},copyToClipboard(t,e){e||(e="Press Ctrl-C (Command-C) to copy and then Enter."),window.prompt(e,t)},formatString:function(e,i,n){for(var r=e.split(/\{\{([^}]+)\}\}/),a=r.length,s="",o=0;s+=r[o++],!(o>=a);++o){var l=t.get(i,r[o]);s+=null!=l?l:"function"==typeof n?n(r[o]):"string"==typeof n?n:""}return s},formatNumber:(t,e)=>(e<1&&(e=parseInt(1/e)),Math.round(t*e)/e),formatUnits:t=>t.toString().replace(/(^|\W)u(\w)/g,"$1&#x00B5;$2").replace(/\^\(?([\-\d]+)\)?/g,"<sup>$1</sup>").replace(/ /g,"&nbsp;"),addParameter:(t,e)=>t+(-1=="&?".indexOf(t.charAt(t.length-1))?t.indexOf("?")>0?"&":"?":"")+e,removeParameter:(t,e)=>t.replace(new RegExp("(.*?.*)("+e+"=[^&s$]*&?)(.*)"),"$1$3"),parseURL:function(t){var e=document.createElement("a");return e.href=t,{source:t,protocol:e.protocol.replace(":",""),host:e.hostname,port:e.port,query:e.search,params:function(){for(var t,i,n,r={},a=e.search.replace(/^\?/,"").split("&"),s=a.length,o=0;o<s;o++)a[o]&&(i=(t=a[o].split("=")).length>1?decodeURIComponent(t[1].replace(/\+/g," ")):"",t[0].indexOf("[]")==t[0].length-2?(n=r[t[0].slice(0,-2)])===undefined?r[t[0].slice(0,-2)]=[i]:n.push(i):r[t[0]]=i);return r}(),file:(e.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1],hash:e.hash.replace("#",""),path:e.pathname.replace(/^([^\/])/,"/$1"),relative:(e.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],segments:e.pathname.replace(/^\//,"").split("/")}},modifyURL(t,e,i){var n,r,a=document.createElement("a"),s=i?e+"="+encodeURIComponent(i):"";if(a.href=t,n=(r=a.search).match(new RegExp(e+"=[\\S^&]+")))r=r.replace(n[0],s);else{if(!s)return;"?"==r.charAt(0)?r="?"+s:r+=("&"==r.slice(-1)?"":"&")+s}return a.search=r,a.href},escapeHTML:function(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,(function(t){return e[t]}))},fillTemplate(t,e){return r(this.formatString(r(t).html(),e).replace(/(<img(\s+.*)?)(\s+jt-src=")/,'$1 src="'))},fillTree(e,i){r(".data-field",e).each((function(){var e=r(this),n=t.get(i,e.data("field"));n!==undefined&&e.html(n)}))},joinDeep:(e,i,n)=>t.map(e,(function(t){t[i]})).join(n),activateDownload:function(t,e,i,n){var r=URL.createObjectURL(e),a=!1;t?t.style.visibility="visible":(t=document.createElement("a"),a=n=!0),t.href=r,t.download=i,!0===n&&t.addEventListener("click",(function(){setTimeout((function(){t.parentElement&&t.parentElement.removeChild(t),window.URL.revokeObjectURL(r)}),0)})),a&&t.click()},promiseXHR:function(t){return new Promise((function(e,i){var n=new XMLHttpRequest;n.open(t.method||"GET",t.url,!0),t.headers&&Object.keys(t.headers).forEach((function(e){n.setRequestHeader(e,t.headers[e])})),Object.keys(t.settings).forEach((function(e){n[e]=t.settings[e]})),n.onreadystatechange=function(){4===n.readyState&&(0==n.status&&n.response||n.status>=200&&n.status<300?e(n.response,n.statusText,n):i(n,n.statusText,n.responseText))},n.send(t.body||t.data)}))},blobFromBase64:function(t,e){return new Blob([t],{type:e})}},s={rootSettings:{},kitsMap:{},templateRoot:null,templates:{},callId:0,initKit:function(e){var i=this,n=e.data(),r=n.kit,s=$.extend(!0,{},i.rootSettings),o=null;t.each(e.parents(".jtox-kit,.jtox-widget").toArray().reverse(),(function(t){null!=(o=i.getInstance(t))&&(s=$.extend(!0,s,o))})),o||(o=i),(n=$.extend(!0,s,n)).baseUrl=i.fixBaseUrl(n.baseUrl),n.target=e,n.id===undefined&&(n.id=e.attr("id"));var realInit=function(t){if(!r)return null;var e=window[r];"function"!=typeof e&&(r=r.charAt(0).toUpperCase()+r.slice(1),e=a.kit[r]||a.widget[r]||a[r]);var s=null;return"function"==typeof e?s=new e(t):"object"==typeof e&&"function"==typeof e.init&&(s=e.init(t)),null!=s?(e.prototype.__kits===undefined&&(e.prototype.__kits=[]),e.prototype.__kits.push(s),s.parentKit=o,null!==n.id&&(i.kitsMap[n.id]=s)):console&&console.log("jToxError: trying to initialize unexistent jTox kit: "+r),s};if(null==n.configFile){if("string"==typeof n.configuration&&window[n.configuration]){var l=window[n.configuration];$.extend(!0,n,"function"==typeof l?l.call(r,n,r):l)}var u=realInit(n);return e.data("jtKit",u),u}$.ajax({settings:"GET",url:n.configFile},(function(t){t&&$.extend(!0,n,t),e.data("jtKit",realInit(n))}))},initialize:function(t){var e=this;if(!t){e.initTemplates(),$(document).on("click",".jtox-kit span.ui-icon-copy",(function(){return this.copyToClipboard($(this).data("uuid")),!1})),$(document).on("click",".jtox-foldable>.title",(function(t){$(this).parent().toggleClass("folded")})),$(document).on("click",".jtox-diagram span.ui-icon",(function(){$(this).toggleClass("ui-icon-zoomin").toggleClass("ui-icon-zoomout"),$("img",this.parentNode).toggleClass("jtox-smalldiagram")}));var i=this.parseURL(document.location),n=i.params;e.rootSettings.baseUrl?n.baseUrl&&(n.baseUrl=e.fixBaseUrl(n.baseUrl)):n.baseUrl=e.formBaseUrl(i),e.rootSettings=$.extend(!0,e.rootSettings,n),e.fullUrl=i,t=document}var fnInit=function(){var t=$(this);if(!t.data("manualInit")){var i=e.initKit(t),n=t.data("jtoxManager");i?"__parent"===n?i.parentKit.addListeners(i):null!=n&&(e.kitsMap[n]?e.kitsMap[n].addListeners(i):console&&console.log("'"+t.attr("id")+"' is binding to unknown kit: "+n)):console&&console.log("Referring unknown widget: "+t.data("kit"))}};$(".jtox-kit",t).each(fnInit),$(".jtox-widget",t).each(fnInit)},getInstance:function(t){return"string"!=typeof t?$(t).data("jtKit"):this.kitsMap[t]!==undefined?this.kitsMap[t]:$("#"+t).data("jtKit")},attachKit:function(t,e){return $(t).data("jtKit",e)},parentKit:function(t,e){var i=this,n=null;return"string"==typeof t&&(t=window[t]),$(e).parents(".jtox-kit").each((function(){var e=i.getInstance(this);e&&!n&&(!t||e instanceof t)&&(n=e)})),n},initTemplates:function(){var t=$(".jtox-template")[0];t||((t=document.createElement("div")).className="jtox-template",document.body.appendChild(t));var e=t.innerHTML;for(var i in this.templates)e+=this.templates[i];t.innerHTML=e,this.templateRoot=t},insertTool:function(t,e){var i=this.tools[t];return null!=i&&(e.innerHTML=i,this.init(e)),e}},o={shortenedData:function(t,e,i){var n="";return null==i&&(i=t),i.toString().length<=5?n+=t:(n+='<div class="shortened">'+t+"</div>",null!=e&&(n+='<span class="ui-icon ui-icon-copy" title="'+e+'" data-uuid="'+i+'"></span>')),n},linkedData:function(t,e,i){var n="";return null==i&&(i=t),i.toString().length<=5?n+=t:n+=null!=e?n+='<div title="'+e+'">'+t+"</div>":"<div >"+t+"</div>",n},changeTabsIds:function(t,e){r("ul li a",t).each((function(){var t=r(this).attr("href").substr(1),i=document.getElementById(t);t+=e,i.id=t,r(this).attr("href","#"+t)}))},addTab:function(t,e,i,n){if(null==document.getElementById(i)){var a=document.createElement("li"),s=document.createElement("a");if(a.appendChild(s),s.href="#"+i,s.innerHTML=e,r("ul",t)[0].appendChild(a),"function"==typeof n)n=n(t);else if("string"==typeof n){var o=document.createElement("div");o.innerHTML=n,n=o}return n.id=i,t.appendChild(n),r(t).tabs("refresh"),{tab:s,content:n}}},modifyColDef:function(t,e,i,n){if(e.sTitle===undefined||null==e.sTitle)return null;var a=e.sTitle.toLowerCase(),getColDef=function(e){var i=t.configuration.columns[e];return null!=i&&(n?null!=(i=i[n])&&(null!=i.bVisible&&(i[a]=i[a]||{},i[a].bVisible=!!i[a].bVisible||!!i.bVisible),i=i[a]):i=i[a]),null==i&&(i={}),i};return null==(e=r.extend(e,n?getColDef("_"):{},getColDef(i))).bVisible||e.bVisible?e:null},sortColDefs:function(t){for(var e=0,i=t.length;e<i;++e)t[e].iNaturalOrder=e;t.sort((function(t,e){var i=(t.iOrder||0)-(e.iOrder||0);return 0==i&&(i=t.iNaturalOrder-e.iNaturalOrder),i}))},processColumns:function(t,e){var i=[],n=t.configuration.columns[e];for(var r in n){var a=this.modifyColDef(t,n[r],e);null!=a&&i.push(a)}return this.sortColDefs(i),i},renderMulti:function(t,e,i,n){if((s=t.length)<2)return n(t[0],e,i);for(var r="<table>",a=0,s=t.length;a<s;++a)r+='<tr class="'+(a%2==0?"even":"odd")+'"><td>'+n(t[a],e,i,a)+"</td></tr>";return r+="</table>"},inlineChanger:function(t,e,i,n){return null==n&&(n="changed"),"select"==e?function(e,r,a){return"display"!=r?e||"":'<select class="jt-inlineaction jtox-handler" data-handler="'+n+'" data-data="'+t+'" value="'+(e||"")+'">'+(i||"")+"</select>"}:"checkbox"==e?function(e,r,a){return"display"!=r?e||"":'<input type="checkbox" class="jt-inlineaction jtox-handler" data-handler="'+n+'" data-data="'+t+'"'+(i&&e==i||e?'checked="checked"':"")+'"/>'}:"text"==e?function(e,r,a){return"display"!=r?e||"":'<input type="text" class="jt-inlineaction jtox-handler" data-handler="'+n+'" data-data="'+t+'" value="'+(e||"")+'"'+(i?' placeholder="'+i+'"':"")+"/>"}:void 0},installMultiSelect:function(t,e,i){null==i&&(i=function(t){return t.parentNode}),r("a.select-all",t).on("click",(function(t){r('input[type="checkbox"]',i(this)).each((function(){this.checked=!0,null==e&&r(this).trigger("change")})),null!=e&&e.call(this,t)})),r("a.unselect-all",t).on("click",(function(t){r('input[type="checkbox"]',i(this)).each((function(){this.checked=!1,null==e&&r(this).trigger("change")})),null!=e&&e.call(this,t)}))},installHandlers:function(t,e){null==e&&(e=t.rootElement),r(".jtox-handler",e).each((function(){var e=r(this).data("handler"),i=null;null!=t.configuration&&null!=t.configuration.handlers&&(i=t.configuration.handlers[e]),(i=i||window[e])?"INPUT"==this.tagName||"SELECT"==this.tagName||"TEXTAREA"==this.tagName?r(this).on("change",i).on("keydown",jT.enterBlur):r(this).on("click",i):console&&console.log("jToxQuery: referring unknown handler: "+e)}))},enterBlur:function(t){13==t.keyCode&&this.blur()},rowData:function(t){var e=r(t).closest("tr")[0],i=r(e).closest("table")[0];return r(i).dataTable().fnGetData(e)},rowIndex:function(t){var e=r(t).closest("tr")[0],i=r(e).closest("table")[0];return r(i).dataTable().fnGetPosition(e)},rowInline:function(e,i){var n=r(e).closest("tr")[0],a=r.extend({},i);return r(".jt-inlineaction",n).each((function(){var e=r(this).data("data");null!=e&&t.set(a,e,r(this).val())})),a},columnData:function(e,i,n){var r=new Array(i.length);null==n&&(n="display");for(var a=0,s=i.length;a<s;++a){for(var o={},l=i[a],u=0,c=e.length;u<c;++u){var p=e[u],h=t.get(l,p.mData)||p.sDefaultValue;o[p.sTitle]="function"!=typeof p.mRender?h:p.mRender(h,n,l)}r[a]=o}return r},queryInfo:function(t){for(var e={},i=0,n=t.length;i<n;++i)e[t[i].name]=t[i].value;return e.iSortingCols>0?(e.iSortDirection=e.sSortDir_0.toLowerCase(),e.sSortData=e["mDataProp_"+e.iSortCol_0]):(e.iSortDirection=0,e.sSortData=""),e},putTable:function(t,e,i){var n=this,a=t.onRow,s=r.extend({bPaginate:!1,bProcessing:!0,bLengthChange:!1,bAutoWidth:!1,sDom:t.sDom,oLanguage:t.oLanguage,bServerSide:!1,fnCreatedRow:function(e,i,s){if("function"==typeof a&&!1===a$.act(t,a,e,i,s))return;n.equalizeHeights.apply(window,r("td.jtox-multi table tbody",e).toArray()),n.installHandlers(t,e),"function"==typeof t.selectionHandler&&r("input.jt-selection",e).on("change",t.selectionHandler),t.onDetails&&r(".jtox-details-toggle",e).on("click",(function(r){var a=n.toggleDetails(r,e);a&&a$.act(t,t.onDetails,a,i,this)}))}},t.configuration);null==s.aoColumns&&(s.aoColumns=n.processColumns(t,i)),null==s.oLanguage&&delete s.oLanguage;var o=r(e).dataTable(s);return r(o).dataTable().fnAdjustColumnSizing(),o},renderRelation:function(t,e,i){if("display"!=e)return this.joinDeep(t,"relation",",");for(var n="",r=0,a=t.length;r<a;++r)n+="<span>"+t[r].relation.substring(4).toLowerCase()+"</span>"+this.putInfo(i.URI+"/composition",t[r].compositionName+"("+t[r].compositionUUID+")");return n},renderRange:function(e,i,n,r){var a="";if("string"==typeof e||"number"==typeof e)a+="display"!=n?e:(r?r+"&nbsp;=&nbsp;":"")+this.valueWithUnits(e,i);else if("object"==typeof e&&null!=e){var s=t.trim(e.loValue),o=t.trim(e.upValue);if(""!=String(s)&&""!=String(o)&&e.upQualifier&&"="!=e.loQualifier)r&&(a+=r+"&nbsp;=&nbsp;"),a+=">="==e.loQualifier?"[":"(",a+=s+", "+o,a+="<="==e.upQualifier?"]":") ";else{var fnFormat=function(t,e,i){var n="";return t&&(n+=t+" "),e&&(n+=t||"="!=e?e+" ":""),n+i};""!=String(s)?a+=fnFormat(r,e.loQualifier||"=",s):""!=String(o)?a+=fnFormat(r,e.upQualifier||"=",o):a+=r||("display"==n?"-":"")}a=a.replace(/ /g,"&nbsp;"),"display"==n&&(i=t.trim(e.unit||i))&&(a+='&nbsp;<span class="units">'+i.replace(/ /g,"&nbsp;")+"</span>")}else a+="-";return a},renderObjValue:function(e,i,n,r){if(!e)return"display"==n?"-":"";var a=this.renderRange(e,i,n,r);return"-"==t.trim(a)&&(a=""),""!=a&&"display"!=n&&e.units&&(a+="&nbsp;"+e.units),e.textValue&&(""!=a&&"display"==n&&(a+="&nbsp;/&nbsp;"),a+=e.textValue),a||(a="-"),a},putInfo:function(t,e){return'<sup class="helper"><a target="_blank" href="'+(t||"#")+'" title="'+(e||t)+'"><span class="ui-icon ui-icon-info"></span></a></sup>'},putStars:function(t,e,i){if(t.shortStars)return'<span class="ui-icon ui-icon-star jtox-inline" title="'+i+'"></span>'+e;for(var n='<div title="'+i+'">',r=0;r<t.maxStars;++r)n+='<span class="ui-icon ui-icon-star jtox-inline',r>=e&&(n+=" transparent"),n+='"></span>';return n+"</div>"},diagramUri:function(t){return t&&"string"==typeof t?t.replace(/(.+)(\/conformer.*)/,"$1")+"?media=image/png":""},valueWithUnits:function(e,i){var n="";return null!=e&&(n+=t.trim(e.toString()).replace(/ /g,"&nbsp;"),i&&(n+='&nbsp;<span class="units">'+i.replace(/ /g,"&nbsp;")+"</span>")),n},updateCounter:function(t,e,i){var n=null,r="";return null==e&&(e=0),null==i?(n=/\(([\d\?]+)\)$/,r=""+e):(n=/\(([\d\?]+\/[\d\?\+-]+)\)$/,r=e+"/"+i),t.match(n)?t=t.replace(n,"("+r+")"):t+=" ("+r+")",t},bindControls:function(t,e){var i=r(".jtox-controls",t.rootElement)[0];if(t.showControls){this.fillTree(i,{pagesize:t.pageSize}),r(".next-field",i).on("click",e.nextPage),r(".prev-field",i).on("click",e.prevPage),r("select",i).on("change",e.sizeChange);var n=null;r("input",i).on("keydown",(function(t){var i=this;null!=n&&clearTimeout(n),n=setTimeout((function(){e.filter.apply(i,[t])}),350)}))}else i.style.display="none"},putActions:function(t,e,i){if(t.selectionHandler||t.onDetails){var n=e.mRender;e.mRender=function(e,r,a){var s=n(e,r,a);return"display"!=r||(i&&(s=""),t.selectionHandler&&(s='<input type="checkbox" value="'+e+'" class="'+("string"==typeof t.selectionHandler?'jtox-handler" data-handler="'+t.selectionHandler+'"':'jt-selection"')+"/>"+s),t.onDetails&&(s+='<span class="jtox-details-toggle ui-icon ui-icon-folder-collapsed" data-data="'+e+'" title="Press to open/close detailed info for this entry"></span>')),s}}return e},toggleDetails:function(t,e){r(t.currentTarget).toggleClass("ui-icon-folder-collapsed"),r(t.currentTarget).toggleClass("ui-icon-folder-open"),r(t.currentTarget).toggleClass("jtox-openned"),e||(e=r(t.currentTarget).parents("tr")[0]);var i=r(t.currentTarget).parents("td")[0];if(r(t.currentTarget).hasClass("jtox-openned")){var n=document.createElement("tr"),a=document.createElement("td");return n.appendChild(a),r(a).addClass("jtox-details"),a.setAttribute("colspan",r(e).children().length-1),e.parentNode.insertBefore(n,e.nextElementSibling),i.setAttribute("rowspan","2"),a}return i.removeAttribute("rowspan"),r(e).next().remove(),null},equalizeHeights:function(){for(var t=[],e=0;e<arguments.length;++e)t[e]=arguments[e].firstElementChild;for(;;){var i=0;for(e=0;e<t.length;++e)null!=t[e]&&(jQuery(t[e]).hasClass("lock-height")||""==t[e].style.height||(t[e].style.height="auto"),t[e].offsetHeight>i&&(i=t[e].offsetHeight));if(0==i)break;for(e=0;e<t.length;++e)null!=t[e]&&(jQuery(t[e]).height(i),t[e]=t[e].nextElementSibling)}}};function Populating(t){e.setup(this,t),this.target=$(t.target),this.length=0,this.clearItems()}Populating.prototype.__expects=["renderItem"],Populating.prototype.populate=function(t,e){this.items=t,this.length=t.length,this.target.empty();for(var i=0,n=t.length;i<n;i++)this.target.append(this.renderItem("function"==typeof e?e(t[i]):t[i]))},Populating.prototype.addItem=function(t){return this.items.push(t),++this.length,this.renderItem(t)},Populating.prototype.clearItems=function(){this.target.empty(),this.items=[],this.length=0},Populating.prototype.findItem=function(e){var i=this;return t.findIndex(this.items,"string"!=typeof e?e:function(t){return t[i.itemId]===e})},Populating.prototype.eraseItem=function(t){var e=this.findItem(t),i=e>=0&&this.items.splice(e,1)[0];return this.length=this.items.length,i},Populating.prototype.enumerateItems=function(t){for(var e=this.target.children(),i=0,n=this.items.length;i<n;++i)t.call(e[i],this.items[i])};var l={errorMessage:"Error retrieving data!",imagesRoot:"images/",loadingImgUrl:null};function Loading(t){e.setup(this,l,t),this.target=t&&t.target,this.imagesRoot.match(/(\/|\\)$/)||(this.imagesRoot+="/"),t.loadingImgUrl||(this.loadingImgUrl=this.imagesRoot+"ajax-loader.gif")}Loading.prototype.__expects=["populate"],Loading.prototype.init=function(t){e.pass(this,Loading,"init",t),this.manager=t},Loading.prototype.beforeRequest=function(){r(this.target).html('<img src="'+this.loadingImgUrl+'">')},Loading.prototype.afterResponse=function(t){t?(r(this.target).empty(),this.populate(t.entries)):r(this.target).html(this.errorMessage)};var u={template:null,classes:null};function ItemRendering(t){e.setup(this,u,t),this.target=$(t.target)}ItemRendering.prototype.renderItem=function(t){return a.fillTemplate(template,t).addClass(this.classes)};var c={async:!0,dataType:"json",method:"GET",processData:!1},p={connector:null,serverUrl:"",onPrepare:null,onError:null,onSuccess:null,ajaxSettings:null};function Communicating(i){e.setup(this,p,i),t.endsWith(this.serverUrl,"/")||(this.serverUrl+="/"),this.listeners={},this.error=null,this.pendingRequests=[],this.inRequest=!1,this.ajaxSettings=t.defaults(this.ajaxSettings,c)}Communicating.prototype.__expects=["prepareQuery"],Communicating.prototype.doRequest=function(i,n,r){if(this.inRequest)this.pendingRequests.push(arguments);else{this.inRequest=!0,"function"==typeof i?(r=i,n=!1,i=null):"function"==typeof n&&(r=n,n=!1),i=i||this.servlet||"";var a=this,s=null,o=t.defaults(this.prepareQuery(i),this.ajaxSettings);if(n||(t.each(a.listeners,(function(t){!1===e.act(t,t.beforeRequest,o,a)&&(s=t)})),null===s))return o.error=function(i,s,l){"function"==typeof r&&r(null,i),n||(t.each(a.listeners,(function(t){e.act(t,t.afterResponse,null,i,o,a)})),e.act(a,a.onError,i,o))},o.success=function(i,s,l){var u=e.act(a,"parseResponse",i)||i;"function"==typeof r&&r(u,i,l),n||(t.each(a.listeners,(function(t){e.act(t,t.afterResponse,u,l,o,a)})),e.act(a,a.onSuccess,u,l,o))},o.complete=function(){a.inRequest=!1,a.pendingRequests.length>0&&a.doRequest.apply(a,a.pendingRequests.shift())},e.broadcast(a,"onPrepare",o),e.act(a,a.onPrepare,o),a.connector(o);e.act(s,a.onError,null,"Request cancelled",s,a)}},Communicating.prototype.buildUrl=function(t,e){return(this.serverUrl||"")+this.addUrlParameters(t||"",e)},Communicating.prototype.addUrlParameters=function(t,e){return e&&e.length?("string"!=typeof e&&(e=e.join("&")||""),t+(t.indexOf("?")>0?"&":"?")+e):t},Communicating.prototype.init=function(i){var n=this;e.pass(n,Communicating,"init",i),t.each(this.listeners,(function(t){e.act(t,t.init,n)}))},Communicating.prototype.addListeners=function(t){for(var e,i=t,n=0,r=(i=arguments.length>1?arguments:Array.isArray(t)?t:[t]).length;n<r;++n)e=i[n],this.listeners[e.id]=e;return this},Communicating.prototype.removeOneListener=function(t){return"object"==typeof t&&(t=t.id),delete this.listeners[t],this},Communicating.prototype.removeListeners=function(e,i){if("function"!=typeof e)throw{name:"Enumeration error",message:"Attempt to select-remove listeners with non-function 'selector': "+e};var n=this;return t.each(n.listeners,(function(t,r){e.call(i,t,r,n)&&delete n.listeners[r]})),n},Communicating.prototype.enumerateListeners=function(e,i){if("function"!=typeof e)throw{name:"Enumeration error",message:"Attempt to enumerate listeners with non-function 'selector': "+e};var n=this;t.each(this.listeners,(function(t,r){e.call(i,t,r,n)}))},Communicating.prototype.getListener=function(t){return this.listeners[t]};var h={delay:300};function Delaying(t){e.setup(this,h,t),this.delayTimer=null}function Authenticating(i){e.setup(this,Authenticating.prototype,i),"Basic"===i.authMethod&&t.extend(this.ajaxSettings,{headers:{Authorization:"Basic "+btoa(this.username+":"+this.password)}})}Delaying.prototype.doRequest=function(t,i,n,r){var a=this,doInvoke=function(){e.pass(a,Delaying,"doRequest",t,i,n,r),a.delayTimer=null};if(null==this.delay||this.delay<10)return doInvoke();null!=this.delayTimer&&clearTimeout(this.delayTimer),this.delayTimer=setTimeout(doInvoke,this.delay)},Authenticating.prototype={username:null,password:null,authMethod:null,ajaxSettings:null};var d={servlet:null,privateRequest:!1,onSpyResponse:null};function Spying(t){e.setup(this,d,t),this.manager=null}Spying.prototype.init=function(t){e.pass(this,Spying,"init",t),this.manager=t},Spying.prototype.doSpying=function(e,i){var n=this.manager;n.pushParameters(!0),"function"==typeof e?e(n):t.each(e,(function(e,i){null==e?n.removeParameters(i):Array.isArray(e)?t.each(e,(function(t){n.addParameter(i,t)})):"object"==typeof e?n.addParameter(e):n.addParameter(i,e)})),n.doRequest(this.servlet,this.privateRequest,i||this.onSpyResponse),n.popParameters()};var g={expectJson:!1,useJson:!1,servlet:null,exportDefinition:{extraParams:[],defaultFilter:null,manualFilter:!1,inheritDomain:!0,domain:"",fieldsRegExp:null,idField:"id"}};function Exporting(t){e.setup(this,g,t),this.manager=null}Exporting.prototype.__expects=["addParameter","prepareQuery"],Exporting.prototype.init=function(t){e.pass(this,Exporting,"init",t),this.manager=t,this.servlet=this.servlet||t.servlet||"select",this.fqName=this.useJson?"json.filter":"fq"},Exporting.prototype.transformParameter=function(t,e){var i={value:t.value,name:e||t.name};return this.exportDefinition.inheritDomain&&t.domain&&"parent"==t.domain.type&&(this.exportDefinition.domain?t.value&&!t.value.match(this.exportDefinition.fieldsRegExp)||(i.domain=this.exportDefinition.domain):i.domain=t.domain),i},Exporting.prototype.prepareFilters=function(t){for(var e=[],i=this.manager.getParameter(this.expectJson?"json.filter":"fq"),n=0,r=i.length;n<r;n++){var a=i[n];this.exportDefinition.manualFilter||this.addParameter(this.transformParameter(a,this.fqName)),e.push(Solr.stringifyValue(a))}return this.exportDefinition.manualFilter||(this.addParameter(this.transformParameter(this.manager.getParameter("q"))),t&&this.addParameter(this.fqName,this.exportDefinition.idField+":("+t.join(" ")+")")),e},Exporting.prototype.prepareExport=function(t,e){for(var i=this.prepareFilters(e),n=i.length>1?"("+i.join(" AND ")+")":i.length>0?i[0]:this.exportDefinition.defaultFilter,r=n.replace(/"|\\/g,"\\$&"),a=0,s=(t=(t||[]).concat(this.exportDefinition.extraParams||[])).length;a<s;++a){var o=this.transformParameter(t[a]);"string"==typeof o.value&&(o.value=o.value.replace("{{filter}}",n).replace("{{filter-escaped}}",r)),this.addParameter(o)}return this},Exporting.prototype.getAjax=function(e){return t.extend({},this.manager.ajaxSettings,e,this.prepareQuery())};var f={automatic:!0,title:null,classes:null,expansionTemplate:null,before:null};function AccordionExpander(t){e.setup(this,f,t),this.target=r(t.target),this.header=null,this.id=t.id,this.automatic&&(t.target=this.makeExpansion())}AccordionExpander.prototype.renderExpansion=function(t){return a.fillTemplate(this.expansionTemplate,t).addClass(this.classes)},AccordionExpander.prototype.makeExpansion=function(t,e){if(!this.header){e||(e=this),t||(t=this.before);var i=this.renderExpansion(e);return this.accordion=this.target,t?"number"==typeof t?this.accordion.children().eq(t).before(i):"string"==typeof t?r(t,this.accordion[0]).before(i):r(t).before(i):this.accordion.append(i),this.refresh(),this.header=r("#"+this.id+"_header"),this.target=r("#"+this.id)}},AccordionExpander.prototype.getHeaderText=function(){return this.header.contents().filter((function(){return 3==this.nodeType}))[0]},AccordionExpander.prototype.refresh=function(){this.accordion.accordion("refresh")};var m={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,echoParams:"none"},v={servlet:"select",urlFeed:null,useJson:!1,maxResults:30,activeFacets:null};function Autocompleter(t){e.setup(this,v,t),this.target=r(t.target),this.id=t.id,this.lookupMap=t.lookupMap||{},this.parameters=_.assign({},m),this.facetPath=this.useJson?"facets":"facet_counts.facet_fields",this.useJson||(this.parameters["json.nl"]="map")}function buildServiceId(t){var e=a.parseURL(t.url);return e.protocol+"://"+e.host+e.path}Autocompleter.prototype.__expects=["addValue","doSpying"],Autocompleter.prototype.init=function(t){e.pass(this,Autocompleter,"init",t),this.manager=t;var i=this;if(i.findBox=this.target.find("input").on("change",(function(e){var n=r(this);i.addValue(n.val())&&!i.requestSent&&(n.blur().autocomplete("disable"),t.doRequest())})),null!=i.urlFeed){var n=r.url().param(i.urlFeed);i.addValue(n),i.findBox.val(n)}i.findBox.autocomplete({minLength:0,source:function(t,e){i.reportCallback=e,i.makeRequest(t.term)},select:function(e,n){n.item&&(i.requestSent=!0,t.getListener(n.item.id).addValue(n.item.value)&&t.doRequest())}})},Autocompleter.prototype.makeRequest=function(t){var e=this;this.doSpying((function(i){i.removeParameters("fl"),i.mergeParameters(e.parameters),e.addValue(t||"")}),(function(t){e.onResponse(t)}))},Autocompleter.prototype.onResponse=function(t){var e=this,i=[];_.each(_.get(t,this.facetPath),(function(t,n){i.length>=e.maxResults||"object"!=typeof t||e.activeFacets&&!1===e.activeFacets[n]||_.each(e.useJson?t.buckets:t,(function(t,r){i.length>=e.maxResults||(e.useJson||(t={val:r,count:t}),i.push({id:n,value:t.val,label:(e.lookupMap[t.val]||t.val)+" ("+t.count+") - "+n}))}))})),"function"==typeof this.reportCallback&&e.reportCallback(i)},Autocompleter.prototype.afterResponse=function(){var t=this.manager.getParameter("q").value||"";this.findBox.val("*:*"!=t&&t.length>0?t:"").autocomplete("enable"),this.requestSent=!1};var y={statusDelay:1500,keepMessages:50,lineHeight:"20px",rightSide:!1,hasDetails:!0,autoHide:!0};function Logger(t){e.setup(this,y,t);var i=r(this.target=t.target);i.html(a.templates["logger-main"]),i.addClass("jtox-toolkit jtox-log"),this.id=i.attr("id"),"number"==typeof this.lineHeight&&(this.lineHeight=this.lineHeight.toString()+"px"),"number"!=typeof this.keepMessages&&(this.keepMessages=parseInt(this.keepMessages)),this.listRoot=r(".list-root",this.target)[0],this.statusEl=r(".status",this.target)[0],this.rightSide?(this.statusEl.style.right="0px",i.addClass("right-side")):this.statusEl.style.left="0px",this.setStatus(""),this.events={},this.autoHide&&(i.bind("click",(function(t){r(this).toggleClass("hidden")})),i.bind("mouseleave",(function(t){r(this).addClass("hidden")})))}Logger.prototype.formatEvent=function(t,e){return null!=e?{details:e.status+" "+e.statusText+"<br/>"+e.getAllResponseHeaders()}:null!=t?{header:t.method.toUpperCase()+": "+buildServiceId(t),details:"..."}:null},Logger.prototype.setIcon=function(t,e){"error"==e?t.addClass("ui-state-error"):t.removeClass("ui-state-error"),t.data("status",e),"error"==e?r(".icon",t).addClass("ui-icon ui-icon-alert").removeClass("loading ui-icon-check"):"success"==e?r(".icon",t).addClass("ui-icon ui-icon-check").removeClass("loading ui-icon-alert"):(r(".icon",t).removeClass("ui-icon ui-icon-check ui-icon-alert"),"connecting"==e&&r(".icon",t).addClass("loading"))},Logger.prototype.setStatus=function(t){var e=this;r(".icon",e.statusEl).removeClass("jt-faded"),e.setIcon(r(e.statusEl),t),"error"!=t&&"success"!=t||setTimeout((function(){r(".icon",e.statusEl).addClass("jt-faded");var t=!1;r(".logline",e.listRoot).each((function(){"connecting"==r(e).data("status")&&(t=!0)})),t&&e.setStatus("connecting")}),e.statusDelay)},Logger.prototype.addLine=function(t){var e=this,i=a.fillTemplate("#jtox-logline",t);for(i.height("0px"),this.listRoot.insertBefore(i[0],this.listRoot.firstElementChild),setTimeout((function(){i.height(e.lineHeight)}),150),e.hasDetails&&r(".icon",i[0]).on("click",(function(t){if(i.toggleClass("openned"),i.hasClass("openned")){var n=0;r(".data-field",i[0]).each((function(){n+=this.offsetHeight})),i.height(n+6)}else i.height(e.lineHeight);t.stopPropagation()}));this.listRoot.childNodes.length>e.keepMessages;)this.listRoot.removeChild(this.listRoot.lastElementChild);return i},Logger.prototype.beforeRequest=function(t){var e=this.formatEvent(t),i=this.addLine(e);this.setStatus("connecting"),this.events[t.logId=Date.now()]=i,this.setIcon(i,"connecting"),i.data("status","connecting")},Logger.prototype.afterResponse=function(t,e,i){var n=this.formatEvent(i,e),r=this.events[i.logId],s=t?"success":"error";this.setStatus(s),r?(delete this.events[i.logId],this.setIcon(r,s),a.fillTree(r[0],n),"error"==s&&console&&console.log("Error ["+buildServiceId(i)+"]: "+e.statusText)):console&&console.log("jToxLog: missing line for:"+buildServiceId(i)+"("+e.statusText+")")},Logger.prototype.mountOnHandlers=function(e){var i=this;if("string"==typeof e)e=t.get(window,e);else if("function"==typeof e)e=e.prototype;else if("object"!=typeof e)throw{name:"Wrong argument",message:"Passed object for mounting ["+e+"] cannot be resolved to an object!"};return e.onPrepare=function(t){return i.beforeRequest(t)},e.onSuccess=function(t,e,n){return i.afterResponse(t,e,n,this)},e.onError=function(t,e){return i.afterResponse(null,t,e,this)},e};var b={innerWindow:4,outerWindow:1,prevLabel:"&laquo; Previous",nextLabel:"Next &raquo;",separator:" ",renderHeader(){}};function Pager(t){e.setup(this,b,t),this.target=$(t.target),this.id=t.id,this.manager=null}Pager.prototype.__expects=["nextPage","previousPage"],Pager.prototype.gapMarker=function(){return'<span class="pager-gap">&hellip;</span>'},Pager.prototype.windowedLinks=function(){for(var t=[],e=null,i=this.visiblePageNumbers(),n=0,r=i.length;n<r;n++)e&&i[n]>e+1&&t.push(this.gapMarker()),t.push(this.pageLinkOrSpan(i[n],["pager-current"])),e=i[n];return t},Pager.prototype.visiblePageNumbers=function(){var t=this.currentPage-this.innerWindow,e=this.currentPage+this.innerWindow,i=[];e>this.totalPages&&(t=Math.max(0,t-(e-this.totalPages)),e=this.totalPages),t<1&&(e=Math.min(this.totalPages,e+(1-t)),t=1),i.push(1);for(var n=2;n<=Math.min(1+this.outerWindow,t-1);n++)i.push(n);1+this.outerWindow==t-2&&i.push(t-1);for(n=Math.max(2,t);n<=Math.min(e,this.totalPages-1);n++)i.push(n);this.totalPages-this.outerWindow==e+2&&i.push(e+1);for(n=Math.max(this.totalPages-this.outerWindow,e+1);n<this.totalPages;n++)i.push(n);return this.totalPages>1&&i.push(this.totalPages),i},Pager.prototype.pageLinkOrSpan=function(t,e,i){return i=i||t,t&&t!=this.currentPage?$('<a href="#"></a>').html(i).attr("rel",this.relValue(t)).addClass(e[1]).click(this.clickHandler(t)):$("<span></span>").html(i).addClass(e.join(" "))},Pager.prototype.relValue=function(t){switch(t){case this.previousPage():return"prev"+(1==t?"start":"");case this.nextPage():return"next";case 1:return"start";default:return""}},Pager.prototype.renderHeader=function(t,e,i){},Pager.prototype.renderLinks=function(t){if(this.totalPages){t.unshift(this.pageLinkOrSpan(this.previousPage(),["pager-disabled","pager-prev"],this.prevLabel)),t.push(this.pageLinkOrSpan(this.nextPage(),["pager-disabled","pager-next"],this.nextLabel));var e=$(this.target);e.empty();for(var i=0,n=t.length;i<n;i++){var r=$("<li></li>");this.separator&&i>0&&r.append(this.separator),e.append(r.append(t[i]))}}},Pager.prototype.afterResponse=function(t,i,n){e.pass(this,Pager,"afterResponse",t,i,n),$(this.target).empty(),this.renderLinks(this.windowedLinks()),this.renderHeader(this.pageSize,(this.currentPage-1)*this.pageSize,this.totalEntries)};var x={runSelector:".switcher",runMethod:null,runTarget:null};var R={color:null,renderItem:null,onUpdated:null,subtarget:null};function Tagger(t){e.setup(this,R,t),this.target=r(t.target),this.subtarget&&(this.target=this.target.find(this.subtarget).eq(0)),this.id=t.id,this.color=this.color||this.target.data("color"),this.color&&this.target.addClass(this.color)}function buildValueRange(t,e){var i=" = ";return i+=null==t.min?"-&#x221E;":t.min,t.avg&&(i+="&#x2026;"+t.avg),i+="&#x2026;"+(null==t.max?"&#x221E;":t.max),e&&(i+=" "+a.formatUnits(t.val).replace(/<sup>(2|3)<\/sup>/g,"&#x00B$1;").replace(/<sup>(\d)<\/sup>/g,"^$1")),i}function InnterTagger(t){this.id=t.id,this.pivotWidget=t.pivotWidget}Tagger.prototype.__expects=["hasValue","clickHandler"],Tagger.prototype.init=function(t){e.pass(this,Tagger,"init",t),this.manager=t},Tagger.prototype.populate=function(t,i){var n,r,a,s=null,o=0;if(null==t.length||0==t.length)i||this.target.html("No items found in this selection").addClass("jt-no-tags");else{this.target.removeClass("jt-no-tags"),t.sort((function(t,e){return(t.value||t.val)<(e.value||e.val)?-1:1})),i||this.target.empty();for(var l=0,u=t.length;l<u;l++)a=(s=t[l]).value||s.val,r=this.exclusion&&this.hasValue(a),o+=s.count,s.title=a.toString(),"function"==typeof this.modifyTag&&(s=this.modifyTag(s)),r||(s.onMain=this.clickHandler(a)),this.target.append(n=this.renderItem(s)),r&&n.addClass("selected")}e.act(this,this.onUpdated,o)},InnterTagger.prototype.pivotWidget=null,InnterTagger.prototype.hasValue=function(t){return this.pivotWidget.hasValue(this.id+":"+t)},InnterTagger.prototype.clickHandler=function(t){return this.pivotWidget.clickHandler(this.id+":"+t)},InnterTagger.prototype.modifyTag=function(t){return t.hint=t.unit?"\n"+t.unit.buckets.map((function(t){return buildValueRange(t,!0)})).join("\n"):t.buildValueRange(t),t.color=this.color,t};var S=e(Tagger,InnterTagger),P=/\W/g,T={automatic:!1,renderTag:null,multivalue:!1,aggregate:!1,exclusion:!1};function Pivoter(t){e.setup(this,T,t),this.target=t.target,this.targets={},this.lastEnabled=0,this.initialPivotCounts=null}Pivoter.prototype.__expects=["getFaceterEntry","getPivotEntry","getPivotCounts","auxHandler"],Pivoter.prototype.init=function(t){e.pass(this,Pivoter,"init",t),this.manager=t,this.manager.getListener("current").registerWidget(this,!0)},Pivoter.prototype.addFaceter=function(t,i){var n=e.pass(this,Pivoter,"addFaceter",t,i);return"object"==typeof t&&(n.color=t.color),i>this.lastEnabled&&!t.disabled&&(this.lastEnabled=i),n},Pivoter.prototype.afterResponse=function(t,i,n){var s=this.getPivotCounts(t.facets);e.pass(this,Pivoter,"afterResponse",t,i,n);for(var o=0;o<s.length;++o){var l=s[o],u=l.val.replace(P,"_"),c=this.targets[u];c?c.target.children("ul").hide():(this.targets[u]=c=new a.AccordionExpander(r.extend(!0,{},this.settings,this.getFaceterEntry(0),{id:u,title:l.val})),c.updateHandler=this.updateHandler(c),c.target.children().last().remove()),this.traversePivot(c.target,l,1),c.updateHandler(l.count)}this.target.accordion("refresh")},Pivoter.prototype.updateHandler=function(t){var e=t.getHeaderText();return function(t){e.textContent=a.updateCounter(e.textContent,t)}},Pivoter.prototype.prepareTag=function(t){var e=this.parseValue(t);return{title:e.value,color:this.faceters[e.id].color,count:"i",onMain:this.unclickHandler(t),onAux:this.auxHandler(t)}},Pivoter.prototype.traversePivot=function(t,e,i){var n=[],s=this.getPivotEntry(i),o=e[s.id].buckets;if(i===this.lastEnabled){var l=t.data("widget");l?t.children().slice(1).remove():((l=new S({id:s.id,color:s.color,renderItem:this.renderTag,pivotWidget:this,target:t,multivalue:this.multivalue,aggregate:this.aggregate,exclusion:this.exclusion})).init(this.manager),t.data({widget:l,id:s.id})),l.populate(o,!0),n=[]}else if(null!=o)for(var u=0,c=o.length;u<c;++u){var p,h=o[u],d=h.val.replace(P,"_");t.children().length>1?p=r("#"+d,t[0]).show():(p=a.fillTemplate(r("#tag-facet"),s).attr("id",d),h.title=h.val,h.onMain=this.clickHandler(s.id+":"+h.val),h.hint=buildValueRange(h),p.append(this.renderTag(h).addClass("category title").addClass(s.color)),n.push(p)),this.traversePivot(p,h,i+1)}t.append(n)};var C={limits:null,units:null,initial:null,title:null,width:null,automatic:!0,isRange:!0,showScale:!0,format:"%s {{units}}"};function Slider(t){e.setup(this,C,t),this.target=$(t.target),this.prepareLimits(t.limits),null==this.initial&&(this.initial=this.isRange?[this.limits[0],this.limits[1]]:(this.limits[0]+this.limits[1])/2),this.target.val(Array.isArray(this.initial)?this.initial.join(","):this.initial),this.automatic&&this.makeSlider()}function SimpleRanger(t){this.sliderRoot=t.sliderRoot}Slider.prototype.__expects=["updateHandler"],Slider.prototype.prepareLimits=function(t){this.limits="string"==typeof t?t.split(","):t,this.limits[0]=parseFloat(this.limits[0]),this.limits[1]=parseFloat(this.limits[1]),this.precision=Math.pow(10,parseInt(Math.min(1,Math.floor(Math.log10(this.limits[1]-this.limits[0]+1)-3)))),this.precision<1&&this.precision>.01&&(this.precison=.01)},Slider.prototype.updateSlider=function(t,e){Array.isArray(t)&&(t=t.join(",")),null!=e?(this.prepareLimits(e),this.target.jRange("updateRange",this.limits,t)):this.target.jRange("setValue",t)},Slider.prototype.makeSlider=function(){var t=this,e=this.limits[1]>this.limits[0],i=[a.formatNumber(this.limits[0],this.precision),this.title+(e||!this.units?"":" ("+this.units+")"),a.formatNumber(this.limits[1],this.precision)],n=t.updateHandler(),r={from:this.limits[0],to:this.limits[1],step:this.precision,scale:i,showScale:this.showScale,showLabels:e,disable:!e,isRange:this.isRange,width:this.width,format:a.formatString(this.format,this)||""};return null!=this.color&&(r.theme="theme-"+this.color),r.ondragend=function(e){return"string"==typeof e&&t.isRange&&(e=e.split(",")),e=Array.isArray(e)?e.map((function(t){return parseFloat(t)})):parseFloat(e),n(e)},this.target.jRange(r)},SimpleRanger.prototype.__expects=["addValue","doRequest"],SimpleRanger.prototype.targetValue=null,SimpleRanger.prototype.updateHandler=function(){var t=this;return function(e){t.addValue(e)&&(t.sliderRoot.updateRequest=!0,t.doRequest())}},SimpleRanger.prototype.doRequest=function(){this.manager.doRequest()};var k=e(i.Ranging,i.Patterning,Slider,SimpleRanger,Delaying),w={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,echoParams:"none"},j={field:null,titleSkips:null};function Ranger(t){e.setup(this,j,t),this.slidersTarget=r(t.slidersTarget),this.lookupMap=t.lookupMap||{},this.pivotMap=null,this.rangeWidgets=[],Array.isArray(this.titleSkips)||(this.titleSkips=[this.titleSkips])}Ranger.prototype.__expects=["getPivotEntry","getPivotCounts"],Ranger.prototype.init=function(t){e.pass(this,Ranger,"init",t),this.manager=t;var i=this;i.applyCommand=r("#sliders-controls a.command.apply").on("click",(function(t){return i.skipClear=!0,i.manager.doRequest(),!1})),r("#sliders-controls a.command.close").on("click",(function(t){return i.rangeRemove(),!1}))},Ranger.prototype.afterResponse=function(t,i,n){var r=this.getPivotCounts(t.facets);if(e.pass(this,Ranger,"afterResponse",t,i,n),this.pivotMap)if(this.updateRequest){if(this.rangeWidgets.length>0)for(var a,s,o=this.buildPivotMap(r),l=0,u=this.rangeWidgets.length;l<u;++l)s=o[(a=this.rangeWidgets[l]).targetValue],a.updateSlider([s[l].min,s[l].max])}else this.rangeRemove();else{var c=this.manager.getParameter("q").value||"";c&&"*:*"!=c||this.manager.getParameter(this.useJson?"json.filter":"fq").value||(this.pivotMap=this.buildPivotMap(r))}this.updateRequest=!1},Ranger.prototype.buildPivotMap=function(t){for(var e=this,n={},traverser=function(t,r,a,s){var o,l=e.getPivotEntry(r),u=l.id,c=l.color;if(l.ranging&&!l.disabled&&(s=u+":"+t.val),a+=(t.val?l.field+":"+i.escapeValue(t.val):"-"+l.field+":*")+" ",o=t,null!=(l=e.getPivotEntry(r+1))&&(t=t[l.id].buckets),null!=l&&t.length)for(var p=0,h=t.length;p<h;++p)traverser(t[p],r+1,a,s);else{var d=n[s];d===undefined&&(n[s]=d=[]),d.push({id:u,pattern:a,color:c,min:o.min,max:o.max,avg:o.avg,val:o.val,count:o.count})}},r=0;r<t.length;++r)traverser(t[r],0,"");return n},Ranger.prototype.rangeRemove=function(){this.slidersTarget.empty().parent().removeClass("active");for(var t=0,e=this.rangeWidgets.length;t<e;++t)this.rangeWidgets[t].clearValues();this.rangeWidgets=[],this.lastPivotMap=this.lastPivotValue=null},Ranger.prototype.buildTitle=function(t,e){for(var i=t.pattern.replace(/\\"/g,"%0022").match(/\w+:([^\s:\/"]+|"[^"]+")/g),n=[],r=0;r<i.length;++r){var a=i[r].match(/(\w+):([^\s:\/"]+|"[^"]+")/),s=a[2].replace(/^\s*\(\s*|\s*\)\s*$/g,"");a[1].match(e)||n.push(this.lookupMap[s]||s)}return n.join("/")+" <i>("+t.count+")</i>"},Ranger.prototype.ensurePivotMap=function(t){if(null!=this.pivotMap)return!0;var e=this.useJson?"json.filter":"fq",i=this;return this.doSpying((function(t){t.removeParameters(e),t.removeParameters("fl"),t.getParameter("q").value="",t.mergeParameters(w)}),(function(e){i.pivotMap=i.buildPivotMap(i.getPivotCounts(e.facets)),i.openRangers(t)})),!1},Ranger.prototype.openRangers=function(t){var e=this.pivotMap[t],i=(this.lastPivotMap=this.buildPivotMap(this.getPivotCounts()))[t];this.lastPivotValue=t,this.slidersTarget.empty().parent().addClass("active");for(var n=0,s=e.length;n<s;++n){var o,l=e[n],u=i[n],c={},p=a.fillTemplate("#slider-one");this.slidersTarget.append(p),c.id=l.id,c.targetValue=t,c.color=l.color,c.field=this.field,c.limits=[l.min,l.max],c.initial=[u.min,u.max],c.target=p,c.isRange=!0,c.valuePattern=l.pattern+"{{v}}",c.automatic=!0,c.width=parseInt(this.slidersTarget.width()-r("#sliders-controls").width()-20)/(Math.min(s,2)+.1),c.title=this.buildTitle(u,/^unit[_shd]*|^effectendpoint[_shd]*/),c.units="unit"==u.id?a.formatUnits(u.val):"",c.useJson=this.useJson,c.domain=this.domain,c.sliderRoot=this,this.rangeWidgets.push(o=new k(c)),o.init(this.manager)}},Ranger.prototype.auxHandler=function(t){var e=this;return function(i){return i.stopPropagation(),e.rangeRemove(),t!=e.lastPivotValue&&e.ensurePivotMap(t)&&e.openRangers(t),!1}},Ranger.prototype.clearValues=function(){this.rangeRemove(),e.pass(this,Ranger,"clearValues")};var I={switchSelector:".switcher",switchField:null,onSwitching:null};function Texter(t){this.target=r(t.target).find("input").on("change",this.clickHandler()),this.id=t.id}Texter.prototype.__expects=["clickHandler "],Texter.prototype.afterResponse=function(){r(this.target).val("")};var L={useJson:!1,renderItem:null};function SolrQueryReporter(t){e.setup(this,L,t),this.target=t.target,this.id=t.id,this.manager=null,this.facetWidgets={},this.fqName=this.useJson?"json.filter":"fq"}SolrQueryReporter.prototype.init=function(t){e.pass(this,SolrQueryReporter,"init",t),this.manager=t},SolrQueryReporter.prototype.registerWidget=function(t,e){this.facetWidgets[t.id]=e},SolrQueryReporter.prototype.afterResponse=function(){var t=this,e=[],i=this.manager.getParameter("q"),n=this.manager.getAllValues(this.fqName);i.value&&!i.value.match(/^(\*:)?\*$/)&&e.push(t.renderItem({title:i.value,count:"x",onMain:()=>(i.value="",t.manager.doRequest(),!1)}).addClass("tag_fixed"));for(var r=0,a=null!=n?n.length:0;r<a;r++){var s,o=n[r],l=null;for(var u in t.facetWidgets)if(l=(s=t.manager.getListener(u)).fqParse(o))break;if(null!=l){Array.isArray(l)||(l=[l]);for(var c=0,p=l.length;c<p;++c){var h,d=l[c],g="function"==typeof s.prepareTag?s.prepareTag(d):{title:d,count:"x",color:s.color,onMain:s.unclickHandler(d)};e.push(h=t.renderItem(g).addClass("tag_selected "+(g.onAux?"tag_open":"tag_fixed"))),p>1&&h.addClass("tag_combined")}p>1&&h.addClass("tag_last")}}e.length?(e.push(t.renderItem({title:"Clear",onMain(){for(var e in i.value="",t.facetWidgets)t.manager.getListener(e).clearValues();return t.manager.doRequest(),!1}}).addClass("tag_selected tag_clear tag_fixed")),this.target.empty().addClass("tags").append(e)):this.target.removeClass("tags").html("<li>No filters selected!</li>")};var E='<a href="{{href}}" title="{{hint}}" target="{{target}}" class="{{css}}">{{value}}</a>',M={baseUrl:"",summaryPrimes:["RESULTS"],tagDbs:{},onCreated:null,onClick:null,imagesRoot:"images/",summaryRenderers:{RESULTS:function(t,e){var i=this;return t.map((function(t){return t.split(".").map((function(t){return i.lookupMap[t]||t})).join(".")}))},REFOWNERS:function(t,e){return{topic:"Study Providers",content:t.map((function(t){return a.formatString(E,{href:"#",hint:"Freetext search",target:"_self",value:t,css:"freetext_selector"})}))}},REFS:function(t,e){return{topic:"References",content:t.map((function(t){var e=t.match(/^doi:(.+)$/);return e=null!=e?"https://www.doi.org/"+e[1]:t,a.formatString(e.match(/^https?:\/\//)?E:'<span title="{{hint}}" class="{{css}}">{{value}}</span>',{href:e,hint:"External reference",target:"ref",value:t})}))}}}};function SolrItemLister(t){e.setup(this,M,t),this.baseUrl=a.fixBaseUrl(t.baseUrl)+"/",this.lookupMap=t.lookupMap||{},this.target=t.target,this.id=t.id,this.imagesRoot.match(/(\/|\\)$/)||(this.imagesRoot+="/")}SolrItemLister.prototype.renderItem=function(t){var e=this,i=r(this.renderSubstance(t));return i.length?(r(this.target).append(i),"function"==typeof this.onClick&&r("a.command",i[0]).on("click",(function(n){e.onClick.call(i[0],n,t,e)})),"function"==typeof this.onCreated&&this.onCreated.call(i,t,this),r("a.more",i[0]).on("click",(function(t){t.preventDefault(),t.stopPropagation();var e=r(this),i=r(".more-less",e.parent()[0]);return i.is(":visible")?(i.hide(),e.text("more")):(i.show(),e.text("less")),!1})),null):null},SolrItemLister.prototype.renderSubstance=function(t){var e=r("#summary-item").html(),i=this.buildSummary(t),n=this.getBaseUrl(t),summaryRender=function(t){return t.map((function(t){return a.formatString(e,t)})).join("")},s={logo:this.tagDbs[t.dbtag_hss]&&this.tagDbs[t.dbtag_hss].icon||this.imagesRoot+"logo.png",link:"#",href:"#",title:(t.publicname||t.name)+(t.pubname===t.name?"":"  ("+t.name+")")+(null==t.substanceType?"":" "+(this.lookupMap[t.substanceType]||t.substanceType)),composition:this.renderComposition(t,'<a href="'+n+t.s_uuid+'/structure" title="Composition" target="'+t.s_uuid+'">&hellip;</a>').join("<br/>"),summary:i.length>0?summaryRender(i.splice(0,this.summaryPrimes.length)):"",item_id:(this.prefix||this.id||"item")+"_"+t.s_uuid,footer:'<a href="'+n+t.s_uuid+'" title="Substance" target="'+t.s_uuid+'">Material</a><a href="'+n+t.s_uuid+'/structure" title="Composition" target="'+t.s_uuid+'">Composition</a><a href="'+n+t.s_uuid+'/study" title="Study" target="'+t.s_uuid+'">Studies</a>'};if(i.length>0&&(s.summary+='<a href="#" class="more">more</a><div class="more-less" style="display:none;">'+summaryRender(i)+"</div>"),null==t.content)s.link=n+t.s_uuid,s.href=s.link+"/study",s.href_title="Study",s.href_target=t.s_uuid;else if(s.href_title="External: "+s.link,s.href_target="external",t.content.length>0){s.link=t.content[0];for(var o=0,l=t.content.length;o<l;o++)s.footer+='<a href="'+t.content[o]+'" target="external">External database</a>'}return a.fillTemplate("#result-item",s)},SolrItemLister.prototype.getBaseUrl=function(t){if(this.tagDbs[t.dbtag_hss]!==undefined){var e=this.tagDbs[t.dbtag_hss].server,i=e.substr(-1);return e+("/"!=i?"/substance/":"substance/")}return this.baseUrl},SolrItemLister.prototype.renderComposition=function(t,e){var i=[],n=t._extended_&&t._extended_.composition;if(n){var r={};_.each(n,(function(t){var e=r[t.component_s],i=[];e===undefined&&(r[t.component_s]=e=[]),_.each(t,(function(t,e){var n=e.match(/^(\w+)_[shd]+$/);(e=n&&n[1]||e).match(/type|id|component/)||i.push(a.formatString(E,{href:"#",hint:"Freetext search on '"+e+"'",target:"_self",value:t,css:"freetext_selector"}))})),e.push(i.join(", "))})),_.each(r,(function(t,n){for(var r="",a=0;a<t.length;++a)""!=t[a]&&(r+=0==a?": ":"; ",t.length>1&&(r+="<strong>["+(a+1)+"]</strong>&nbsp;"),r+=t[a]);""===r&&(r=":&nbsp;"+e),r=n+" ("+t.length+")"+r,i.push(r)}))}return i},SolrItemLister.prototype.buildSummary=function(t){var e=this,i=[];return _.each(t,(function(t,n){var r=n.match(/^SUMMARY\.([^_]+)_?[hsd]*$/);if(r){r=r[1];var a=e.summaryRenderers[r]||e.summaryRenderers._,s="function"==typeof a?a.call(e,t,r):t;if(s){"object"!=typeof s||Array.isArray(s)?s={topic:r.toLowerCase(),values:s}:null==s.topic&&(s.topic=r.toLowerCase()),s.content||(s.content=Array.isArray(s.values)?s.values.join(", "):s.values.toString());var o=e.summaryPrimes.indexOf(r);o>-1&&o<i.length?i.splice(o,0,s):i.push(s)}}})),i};var A={id:null,target:null,shortStars:!1,maxStars:10,selectionHandler:null,sDom:"<Fif>rt",loadOnInit:!1,oLanguage:null,configuration:{columns:{model:{Id:{iOrder:0,sTitle:"Id",mData:"URI",sWidth:"50px",mRender:function(t,e,i){return"display"!=e?i.id:'<a target="_blank" href="'+t+'"><span class="ui-icon ui-icon-link jtox-inline"></span> M'+i.id+"</a>"}},Title:{iOrder:1,sTitle:"Title",mData:"title",sDefaultContent:"-"},Stars:{iOrder:2,sTitle:"Stars",mData:"stars",sWidth:"160px"},Algorithm:{iOrder:3,sTitle:"Algorithm",mData:"algorithm"},Info:{iOrder:4,sTitle:"Info",mData:"trainingDataset",mRender:function(t,e,i){return"display"==e&&t?'<a href="'+t+'"><span class="ui-icon ui-icon-calculator"></span>&nbsp;training set</a>':t}}},algorithm:{Id:{iOrder:0,sTitle:"Id",mData:"uri",sWidth:"150px",mRender:function(t,e,i){return"display"!=e?i.id:'<a target="_blank" href="'+t+'"><span class="ui-icon ui-icon-link jtox-inline"></span> '+i.id+"</a>"}},Title:{iOrder:1,sTitle:"Title",mData:"name",sDefaultContent:"-"},Description:{iOrder:2,sTitle:"Description",sClass:"shortened",mData:"description",sDefaultContent:"-"},Info:{iOrder:3,sTitle:"Info",mData:"format",mRender:function(t,e,i){return"display"==e&&t?"<strong>"+t+"</strong>; "+(i.isSupevised?"<strong>Supervised</strong>; ":"")+'<a target="_blank" href="'+i.implementationOf+'">'+i.implementationOf+"</a>":t}}}}}};function AmbitModelViewer(t){e.setup(this,A,t),this.root$=r(t&&t.target)}return AmbitModelViewer.prototype.__expects=["doRequest","serviceId"],AmbitModelViewer.prototype.init=function(t){var i=this;e.pass(this,AmbitModelViewer,"init",t),i.manager=t,this.root$.addClass("jtox-toolkit").append("<table></table>").addClass("jtox-model"),"algorithm"===i.serviceId&&(i.configuration.columns.model.Stars.mRender=function(t,e,n){return"display"!=e?t:o.putStars(i,t,"Model star rating (worst) 1 - 10 (best)")},i.shortStars&&(i.configuration.columns.model.Stars.sWidth="40px"),i.configuration.columns.model.Algorithm.mRender=function(e,n){var r=e.URI.match(/https{0,1}:\/\/.*\/algorithm\/(\w+).*/)[1];if("display"!=n)return r;var a='<a target="_blank" href="'+e.URI+'"><img src="'+t.baseUrl+e.img+'"/>&nbsp;'+r+"</a>";return i.algorithmLink&&(a+='<a href="'+ccLib.addParameter(i.modelUri,"algorithm="+encodeURIComponent(e.URI))+'"><span class="ui-icon ui-icon-calculator float-right" title="Show models using algorithm '+r+'"></span></a>'),a}),(i.selectionHandler||i.onDetails)&&(o.putActions(i,i.configuration.columns[i.serviceId].Id),i.configuration.columns[i.serviceId].Id.sWidth="60px"),i.oLanguage||(i.oLanguage={sLoadingRecords:"No "+this.serviceId+" found.",sZeroRecords:"No "+this.serviceId+" found.",sEmptyTable:"No "+this.serviceId+" available.",sInfo:"Showing _TOTAL_ "+this.serviceId+"(s) (_START_ to _END_)"}),i.table=o.putTable(i,i.root$.children("table")[0],this.serviceId),this.loadOnInit&&i.doRequest()},AmbitModelViewer.prototype.populate=function(t){r(this.table).dataTable().fnAddData(t)},AmbitModelViewer.prototype.beforeRequest=function(t){if(t.serviceId===self.serviceId)return this.root$.find('input[type="checkbox"]').each((function(){this.checked&&(uri=ccLib.addParameter(uri,"feature_uris[]="+encodeURIComponent(this.value+"/predicted")))})),r(self.table).dataTable().fnClearTable(),uri},t.assign(a,s,o),a.Populating=Populating,a.Loading=Loading,a.ItemRendering=ItemRendering,a.Communicating=Communicating,a.Delaying=Delaying,a.Authenticating=Authenticating,a.Spying=Spying,a.Exporting=Exporting,a.AccordionExpander=AccordionExpander,a.Autocompleter=Autocompleter,a.Logger=Logger,a.Pager=Pager,a.Passer=function Passer(t){e.setup(this,x,t);var i=this,n=r(i.runSelector,r(t.target)[0]),a=i.runTarget||i;n.on("click",(function(t){e.act(a,i.runMethod,this,t),t.stopPropagation()}))},a.Pivoter=Pivoter,a.Ranger=Ranger,a.Slider=Slider,a.Switcher=function Switcher(i){e.setup(this,I,i);var n=this,a=r(n.switchSelector,r(i.target)[0]),s=t.get(n,n.switchField);"boolean"==typeof s?a[0].checked=s:a.val(s),a.on("change",(function(i){var a=r(this).val();t.set(n,n.switchField,"boolean"==typeof s?this.checked||"on"===a:a),e.act(n,n.onSwitching,i),i.stopPropagation()}))},a.Tagger=Tagger,a.Texter=Texter,a.SolrQueryReporter=SolrQueryReporter,a.SolrItemLister=SolrItemLister,a.AmbitModelViewer=AmbitModelViewer,a.widget={SolrResult:e(i.Listing,Populating,SolrItemLister,Loading),SolrPaging:e(i.Paging,Pager),Logger:Logger,AmbitModeller:e(AmbitModelViewer,n.Modelling,n.Tasking),AmbitAlgorithmer:e(AmbitModelViewer,n.Algorithming)},a.kit={},("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{}).jT=a,a}));