/** jToxKit - Chem-informatics UI tools, widgets and kits library. Copyright Â© 2016-2019, IDEAConsult Ltd. All rights reserved. @license MIT.*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("lodash"),require("as-sys"),require("jQuery"),require("solr-jsx"),require("commbase-jsx")):"function"==typeof define&&define.amd?define(["lodash","as-sys","jQuery","solr-jsx","commbase-jsx"],e):(t=t||self)["jtox-kit"]=e(t._,t.a$,t.$,t.Solr,t["file:"][""]["/CommBaseJsX"])}(this,(function(t,e,n,s,a){"use strict";var r={version:"3.0.0",fixBaseUrl:t=>(null!=t&&"/"==t.charAt(t.length-1)&&(t=t.slice(0,-1)),t),grabBaseUrl(t,e){if(null!=t){if(e)return t.slice(0,t.indexOf("/"+e));if(0==t.indexOf("http"))return this.formBaseUrl(this.parseURL(t))}return this.settings.baseUrl},formBaseUrl(t){var e=t.host?t.protocol+"://"+t.host+(t.port.length>0?":"+t.port:"")+"/"+t.segments[0]:null;return console.log("Deduced base URL: "+e+" (from: "+t.source+")"),e},copyToClipboard(t,e){e||(e="Press Ctrl-C (Command-C) to copy and then Enter."),window.prompt(e,t)},formatString:function(t,i,n){for(var s=t.split(/\{\{([^}]+)\}\}/),a=s.length,r="",o=0;r+=s[o++],!(o>=a);++o){var l=e.path(i,s[o]);r+=null!=l?l:"function"==typeof n?n(s[o]):"string"==typeof n?n:""}return r},formatNumber:(t,e)=>(e<1&&(e=parseInt(1/e)),Math.round(t*e)/e),formatUnits:t=>t.toString().replace(/(^|\W)u(\w)/g,"$1&#x00B5;$2").replace(/\^\(?([\-\d]+)\)?/g,"<sup>$1</sup>").replace(/ /g,"&nbsp;"),addParameter:(t,e)=>t+(-1=="&?".indexOf(t.charAt(t.length-1))?t.indexOf("?")>0?"&":"?":"")+e,removeParameter:(t,e)=>t.replace(new RegExp("(.*?.*)("+e+"=[^&s$]*&?)(.*)"),"$1$3"),parseURL:function(t){var e=document.createElement("a");return e.href=t,{source:t,protocol:e.protocol.replace(":",""),host:e.hostname,port:e.port,query:e.search,params:function(){for(var t,i,n,s={},a=e.search.replace(/^\?/,"").split("&"),r=a.length,o=0;o<r;o++)a[o]&&(i=(t=a[o].split("=")).length>1?decodeURIComponent(t[1].replace(/\+/g," ")):"",t[0].indexOf("[]")==t[0].length-2?(n=s[t[0].slice(0,-2)])===undefined?s[t[0].slice(0,-2)]=[i]:n.push(i):s[t[0]]=i);return s}(),file:(e.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1],hash:e.hash.replace("#",""),path:e.pathname.replace(/^([^\/])/,"/$1"),relative:(e.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],segments:e.pathname.replace(/^\//,"").split("/")}},modifyURL(t,e,i){var n,s,a=document.createElement("a"),r=i?e+"="+encodeURIComponent(i):"";if(a.href=t,n=(s=a.search).match(new RegExp(e+"=[\\S^&]+")))s=s.replace(n[0],r);else{if(!r)return;"?"==s.charAt(0)?s="?"+r:s+=("&"==s.slice(-1)?"":"&")+r}return a.search=s,a.href},escapeHTML:function(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,(function(t){return e[t]}))},fillTemplate(t,e){return n(this.formatString(n(t).html(),e).replace(/(<img(\s+.*)?)(\s+jt-src=")/,'$1 src="'))},fillTree(t,i){n(".data-field",t).each((function(){var t=n(this),s=e.path(i,t.data("field"));s!==undefined&&t.html(s)}))},updateCounter(t,e,i){var n=null,s="";return null==e&&(e=0),null==i?(n=/\(([\d\?]+)\)$/,s=""+e):(n=/\(([\d\?]+\/[\d\?\+-]+)\)$/,s=e+"/"+i),t.match(n)?t=t.replace(n,"("+s+")"):t+=" ("+s+")",t},enterBlur(t){13==t.keyCode&&this.blur()}},o={rootSettings:{},kitsMap:{},templateRoot:null,templates:{},callId:0,initKit:function(e){var i=this,n=e.data(),s=n.kit,a=$.extend(!0,{},i.rootSettings);parent=null,t.each(e.parents(".jtox-kit,.jtox-widget").toArray().reverse(),(function(t){parent=i.kit(t),null!=parent&&(a=$.extend(!0,a,parent))})),parent||(parent=i),(n=$.extend(!0,a,n)).baseUrl=i.fixBaseUrl(n.baseUrl),n.target=e,n.id===undefined&&(n.id=e.attr("id"));var realInit=function(t,e){if(!s)return null;var a=window[s];"function"!=typeof a&&(s=s.charAt(0).toUpperCase()+s.slice(1),a=jT.ui[s]||jT[s]);var r=null;return"function"==typeof a?r=new a(t):"object"==typeof a&&"function"==typeof a.init&&(r=a.init(t)),null!=r?(a.prototype.__kits===undefined&&(a.prototype.__kits=[]),a.prototype.__kits.push(r),r.parentKit=parent,null!==n.id&&(i.kitsMap[n.id]=r)):console.log("jToxError: trying to initialize unexistent jTox kit: "+s),r};if(null!=n.configFile)$.ajax({settings:"GET",url:n.configFile},(function(t){t&&$.extend(!0,n,t),e.data("jtKit",realInit(n))}));else{if("string"==typeof n.configuration&&window[n.configuration]){var r=window[n.configuration];$.extend(!0,n,"function"==typeof r?r.call(s,n,s):r)}e.data("jtKit",realInit(n))}},initialize:function(t){var e=this;if(!t){e.initTemplates(),$(document).on("click",".jtox-kit span.ui-icon-copy",(function(){return this.copyToClipboard($(this).data("uuid")),!1})),$(document).on("click",".jtox-foldable>.title",(function(t){$(this).parent().toggleClass("folded")})),$(document).on("click",".jtox-diagram span.ui-icon",(function(){$(this).toggleClass("ui-icon-zoomin").toggleClass("ui-icon-zoomout"),$("img",this.parentNode).toggleClass("jtox-smalldiagram")}));var i=this.parseURL(document.location),n=i.params;e.rootSettings.baseUrl?n.baseUrl&&(n.baseUrl=e.fixBaseUrl(n.baseUrl)):n.baseUrl=e.formBaseUrl(i),e.rootSettings=$.extend(!0,e.rootSettings,n),e.fullUrl=i,t=document}var fnInit=function(){$(this).data("manualInit")||e.initKit($(this))};$(".jtox-kit",t).each(fnInit),$(".jtox-widget",t).each(fnInit)},kit:function(t){return"string"!=typeof t?$(t).data("jtKit"):this.kitsMap[t]!==undefined?this.kitsMap[t]:$("#"+t).data("jtKit")},attachKit:function(t,e){return $(t).data("jtKit",e)},parentKit:function(t,e){var i=this,n=null;return"string"==typeof t&&(t=window[t]),$(e).parents(".jtox-kit").each((function(){var e=i.kit(this);e&&!n&&(!t||e instanceof t)&&(n=e)})),n},initTemplates:function(){var t=$(".jtox-template")[0];t||((t=document.createElement("div")).className="jtox-template",document.body.appendChild(t));var e=t.innerHTML;for(var i in this.templates)e+=this.templates[i];t.innerHTML=e,this.templateRoot=t},insertTool:function(t,e){var i=this.tools[t];return null!=i&&(e.innerHTML=i,this.init(e)),e},installHandlers:function(t,e){null==e&&(e=t.rootElement),jT.$(".jtox-handler",e).each((function(){var e=jT.$(this).data("handler"),i=null;null!=t.settings.configuration&&null!=t.settings.configuration.handlers&&(i=t.settings.configuration.handlers[e]),(i=i||window[e])?"INPUT"==this.tagName||"SELECT"==this.tagName||"TEXTAREA"==this.tagName?jT.$(this).on("change",i).on("keydown",jT.ui.enterBlur):jT.$(this).on("click",i):console.log("jToxQuery: referring unknown handler: "+e)}))}};function Listing(t){e.setup(this,t),this.target=$(t.target),this.length=0,this.clearItems()}function Loading(t){e.setup(this,t)}function AccordionExpansion(t){e.setup(this,t),this.target=n(t.target),this.header=null,this.id=t.id,this.automatic&&(t.target=this.makeExpansion())}Listing.prototype={itemId:"id",populate:function(t,e){this.items=t,this.length=t.length,this.target.empty();for(var i=0,n=t.length;i<n;i++)this.target.append(this.renderItem("function"==typeof e?e(t[i]):t[i]))},addItem:function(t){return this.items.push(t),++this.length,this.renderItem(t)},clearItems:function(){this.target.empty(),this.items=[],this.length=0},findItem:function(e){var i=this;return t.findIndex(this.items,"string"!=typeof e?e:function(t){return t[i.itemId]===e})},eraseItem:function(t){var e=this.findItem(t),i=e>=0&&this.items.splice(e,1)[0];return this.length=this.items.length,i},enumerateItems:function(t){for(var e=this.target.children(),i=0,n=this.items.length;i<n;++i)t.call(e[i],this.items[i])}},Loading.prototype={__expects:["populate"],errorMessage:"Error retrieving data!",init(t){e.pass(this,Loading,"init",t),this.manager=t},beforeRequest(){n(this.target).html(n("<img>").attr("src","images/ajax-loader.gif"))},afterResponse(t,e){t?(n(this.target).empty(),this.populate(t.entries)):n(this.target).html(this.errorMessage)}},AccordionExpansion.prototype={automatic:!0,title:null,classes:null,expansionTemplate:null,before:null,renderExpansion:function(t){return r.ui.fillTemplate(this.expansionTemplate,t).addClass(this.classes)},makeExpansion:function(t,e){if(!this.header){e||(e=this),t||(t=this.before);var i=this.renderExpansion(e);return this.accordion=this.target,t?"number"==typeof t?this.accordion.children().eq(t).before(i):"string"==typeof t?n(t,this.accordion[0]).before(i):n(t).before(i):this.accordion.append(i),this.refresh(),this.header=n("#"+this.id+"_header"),this.target=n("#"+this.id)}},getHeaderText:function(){return this.header.contents().filter((function(){return 3==this.nodeType}))[0]},refresh:function(){this.accordion.accordion("refresh")}};var l={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,echoParams:"none"};function Autocompletion(t){e.setup(this,t),this.target=n(t.target),this.id=t.id,this.lookupMap=t.lookupMap||{},this.parameters=_.assign({},l),this.facetPath=this.useJson?"facets":"facet_counts.facet_fields",this.useJson||(this.parameters["json.nl"]="map")}function SearchStatusShowing(t){e.setup(this,t),this.target=t.target,this.id=t.id,this.manager=null,this.facetWidgets={},this.fqName=this.useJson?"json.filter":"fq"}function ItemShowing(t){e.setup(this,t),this.target=$(t.target)}Autocompletion.prototype={__expects:["addValue","doSpying"],servlet:"select",urlFeed:null,useJson:!1,maxResults:30,activeFacets:null,init:function(t){e.pass(this,Autocompletion,"init",t),this.manager=t;var i=this;if(i.findBox=this.target.find("input").on("change",(function(e){var s=n(this);i.addValue(s.val())&&!i.requestSent&&(s.blur().autocomplete("disable"),t.doRequest())})),null!=i.urlFeed){var s=n.url().param(i.urlFeed);i.addValue(s),i.findBox.val(s)}i.findBox.autocomplete({minLength:0,source:function(t,e){i.reportCallback=e,i.makeRequest(t.term)},select:function(e,n){n.item&&(i.requestSent=!0,t.getListener(n.item.id).addValue(n.item.value)&&t.doRequest())}})},makeRequest:function(t){var e=this;this.doSpying((function(i){i.removeParameters("fl"),i.mergeParameters(e.parameters),e.addValue(t||"")}),(function(t){e.onResponse(t)}))},onResponse:function(t){var e=this,i=[];_.each(_.get(t,this.facetPath),(function(t,n){i.length>=e.maxResults||"object"!=typeof t||e.activeFacets&&!1===e.activeFacets[n]||_.each(e.useJson?t.buckets:t,(function(t,s){i.length>=e.maxResults||(e.useJson||(t={val:s,count:t}),i.push({id:n,value:t.val,label:(e.lookupMap[t.val]||t.val)+" ("+t.count+") - "+n}))}))})),"function"==typeof this.reportCallback&&e.reportCallback(i)},afterResponse:function(t){var e=this.manager.getParameter("q").value||"";this.findBox.val("*:*"!=e&&e.length>0?e:"").autocomplete("enable"),this.requestSent=!1}},SearchStatusShowing.prototype={useJson:!1,renderItem:null,init:function(t){e.pass(this,SearchStatusShowing,"init",t),this.manager=t},registerWidget:function(t,e){this.facetWidgets[t.id]=e},afterResponse:function(t){var e=this,i=[],n=this.manager.getParameter("q"),s=this.manager.getAllValues(this.fqName);n.value&&!n.value.match(/^(\*:)?\*$/)&&i.push(e.renderItem({title:n.value,count:"x",onMain:function(){return n.value="",e.manager.doRequest(),!1}}).addClass("tag_fixed"));for(var a=0,r=null!=s?s.length:0;a<r;a++){var o=s[a],l=null;for(var u in e.facetWidgets){var h=e.manager.getListener(u);if(l=h.fqParse(o))break}if(null!=l){Array.isArray(l)||(l=[l]);for(var c=0,g=l.length;c<g;++c){var d,p=l[c],f="function"==typeof h.prepareTag?h.prepareTag(p):{title:p,count:"x",color:h.color,onMain:h.unclickHandler(p)};i.push(d=e.renderItem(f).addClass("tag_selected "+(f.onAux?"tag_open":"tag_fixed"))),g>1&&d.addClass("tag_combined")}g>1&&d.addClass("tag_last")}}i.length?(i.push(e.renderItem({title:"Clear",onMain:function(){for(var t in n.value="",e.facetWidgets)e.manager.getListener(t).clearValues();return e.manager.doRequest(),!1}}).addClass("tag_selected tag_clear tag_fixed")),this.target.empty().addClass("tags").append(i)):this.target.removeClass("tags").html("<li>No filters selected!</li>")}},ItemShowing.prototype={template:null,classes:null,renderItem:function(t){return r.ui.fillTemplate(template,t).addClass(this.classes)}};var u='<a href="{{href}}" title="{{hint}}" target="{{target}}" class="{{css}}">{{value}}</a>';function ItemListing(t){t.baseUrl=r.fixBaseUrl(t.baseUrl)+"/",e.setup(this,t),this.lookupMap=t.lookupMap||{},this.target=t.target,this.id=t.id}function Logging(i){var s=n(i.target);if(e.setup(this,i),this.target=i.target,s.html(r.ui.templates["logger-main"]),s.addClass("jtox-toolkit jtox-log"),"number"==typeof this.lineHeight&&(this.lineHeight=this.lineHeight.toString()+"px"),"number"!=typeof this.keepMessages&&(this.keepMessages=parseInt(this.keepMessages)),this.listRoot=n(".list-root",this.target)[0],this.statusEl=n(".status",this.target)[0],this.rightSide?(this.statusEl.style.right="0px",s.addClass("right-side")):this.statusEl.style.left="0px",this.setStatus(""),this.events={},this.autoHide&&(s.bind("click",(function(t){n(this).toggleClass("hidden")})),s.bind("mouseleave",(function(t){n(this).addClass("hidden")}))),this.mountDestination){var a="object"==typeof this.mountDestination?this.mountDestination:t.get(window,this.mountDestination),o=this;a.onPrepare=function(t){return o.beforeRequest(t)},a.onSuccess=function(t,e,i){return o.afterResponse(t,i,e)},a.onError=function(t,e){return o.afterResponse(null,t,e)}}}function PageShowing(t){e.setup(this,t),this.target=$(t.target),this.id=t.id,this.manager=null}function Passing(t){e.setup(this,t);var i=this,s=n(i.runSelector,n(t.target)[0]),a=i.runTarget||i;s.on("click",(function(t){e.act(a,i.runMethod,this,t),t.stopPropagation()}))}function Tagging(t){e.setup(this,t),this.target=n(t.target),this.subtarget&&(this.target=this.target.find(this.subtarget).eq(0)),this.id=t.id,this.color=this.color||this.target.data("color"),this.color&&this.target.addClass(this.color)}function buildValueRange(t,e){var i=" = ";return i+=null==t.min?"-&#x221E;":t.min,t.avg&&(i+="&#x2026;"+t.avg),i+="&#x2026;"+(null==t.max?"&#x221E;":t.max),e&&(i+=" "+r.formatUnits(t.val).replace(/<sup>(2|3)<\/sup>/g,"&#x00B$1;").replace(/<sup>(\d)<\/sup>/g,"^$1")),i}function InnerTagWidgeting(t){this.id=t.id,this.pivotWidget=t.pivotWidget}ItemListing.prototype={baseUrl:"",summaryPrimes:["RESULTS"],tagDbs:{},onCreated:null,onClick:null,summaryRenderers:{RESULTS:function(t,e){var i=this;return t.map((function(t){return t.split(".").map((function(t){return i.lookupMap[t]||t})).join(".")}))},REFOWNERS:function(t,e){return{topic:"Study Providers",content:t.map((function(t){return r.formatString(u,{href:"#",hint:"Freetext search",target:"_self",value:t,css:"freetext_selector"})}))}},REFS:function(t,e){return{topic:"References",content:t.map((function(t){var e=t.match(/^doi:(.+)$/);return e=null!=e?"https://www.doi.org/"+e[1]:t,r.formatString(e.match(/^https?:\/\//)?u:'<span title="{{hint}}" class="{{css}}">{{value}}</span>',{href:e,hint:"External reference",target:"ref",value:t})}))}}},renderItem:function(t){var e=this,i=n(this.renderSubstance(t));return i.length?(n(this.target).append(i),"function"==typeof this.onClick&&n("a.command",i[0]).on("click",(function(n){e.onClick.call(i[0],n,t,e)})),"function"==typeof this.onCreated&&this.onCreated.call(i,t,this),n("a.more",i[0]).on("click",(function(t){t.preventDefault(),t.stopPropagation();var e=n(this),i=n(".more-less",e.parent()[0]);return i.is(":visible")?(i.hide(),e.text("more")):(i.show(),e.text("less")),!1})),null):null},renderSubstance:function(t){var e=n("#summary-item").html(),i=this.buildSummary(t),s=this.getBaseUrl(t),summaryRender=function(t){return t.map((function(t){return r.ui.formatString(e,t)})).join("")},a={logo:this.tagDbs[t.dbtag_hss]&&this.tagDbs[t.dbtag_hss].icon||"images/logo.png",link:"#",href:"#",title:(t.publicname||t.name)+(t.pubname===t.name?"":"  ("+t.name+")")+(null==t.substanceType?"":" "+(this.lookupMap[t.substanceType]||t.substanceType)),composition:this.renderComposition(t,'<a href="'+s+t.s_uuid+'/structure" title="Composition" target="'+t.s_uuid+'">&hellip;</a>').join("<br/>"),summary:i.length>0?summaryRender(i.splice(0,this.summaryPrimes.length)):"",item_id:(this.prefix||this.id||"item")+"_"+t.s_uuid,footer:'<a href="'+s+t.s_uuid+'" title="Substance" target="'+t.s_uuid+'">Material</a><a href="'+s+t.s_uuid+'/structure" title="Composition" target="'+t.s_uuid+'">Composition</a><a href="'+s+t.s_uuid+'/study" title="Study" target="'+t.s_uuid+'">Studies</a>'};if(i.length>0&&(a.summary+='<a href="#" class="more">more</a><div class="more-less" style="display:none;">'+summaryRender(i)+"</div>"),null==t.content)a.link=s+t.s_uuid,a.href=a.link+"/study",a.href_title="Study",a.href_target=t.s_uuid;else{var o="External database";if(t.owner_name&&0===t.owner_name.lastIndexOf("caNano",0)?(a.logo="images/canano.jpg",a.href_title="caNanoLab: "+a.link,a.href_target=o="caNanoLab",a.footer=""):(a.logo="images/external.png",a.href_title="External: "+a.link,a.href_target="external"),t.content.length>0){a.link=t.content[0];for(var l=0,u=t.content.length;l<u;l++)a.footer+='<a href="'+t.content[l]+'" target="external">'+o+"</a>"}}return r.ui.fillTemplate("#result-item",a)},getBaseUrl:function(t){if(this.tagDbs[t.dbtag_hss]!==undefined){var e=this.tagDbs[t.dbtag_hss].server,i=e.substr(-1);return e+("/"!=i?"/substance/":"substance/")}return this.baseUrl},renderComposition:function(t,e){var i=[],n=t._extended_&&t._extended_.composition;if(n){var s={};_.each(n,(function(t){var e=s[t.component_s],i=[];e===undefined&&(s[t.component_s]=e=[]),_.each(t,(function(t,e){var n=e.match(/^(\w+)_[shd]+$/);(e=n&&n[1]||e).match(/type|id|component/)||i.push(r.ui.formatString(u,{href:"#",hint:"Freetext search on '"+e+"'",target:"_self",value:t,css:"freetext_selector"}))})),e.push(i.join(", "))})),_.each(s,(function(t,n){for(var s="",a=0;a<t.length;++a)""!=t[a]&&(s+=0==a?": ":"; ",t.length>1&&(s+="<strong>["+(a+1)+"]</strong>&nbsp;"),s+=t[a]);""===s&&(s=":&nbsp;"+e),s=n+" ("+t.length+")"+s,i.push(s)}))}return i},buildSummary:function(t){var e=this,i=[];return _.each(t,(function(t,n){var s=n.match(/^SUMMARY\.([^_]+)_?[hsd]*$/);if(s){s=s[1];var a=e.summaryRenderers[s]||e.summaryRenderers._,r="function"==typeof a?a.call(e,t,s):t;if(r){"object"!=typeof r||Array.isArray(r)?r={topic:s.toLowerCase(),values:r}:null==r.topic&&(r.topic=s.toLowerCase()),r.content||(r.content=Array.isArray(r.values)?r.values.join(", "):r.values.toString());var o=e.summaryPrimes.indexOf(s);o>-1&&o<i.length?i.splice(o,0,r):i.push(r)}}})),i}},Logging.prototype={mountDestination:null,statusDelay:1500,keepMessages:50,lineHeight:"20px",rightSide:!1,hasDetails:!0,autoHide:!0,formatEvent:function(t,e){return null!=e?{details:e.status+" "+e.statusText+"<br/>"+e.getAllResponseHeaders()}:null!=t?{header:t.method.toUpperCase()+": "+t.service,details:"..."}:null},setIcon:function(t,e){"error"==e?t.addClass("ui-state-error"):t.removeClass("ui-state-error"),t.data("status",e),"error"==e?n(".icon",t).addClass("ui-icon ui-icon-alert").removeClass("loading ui-icon-check"):"success"==e?n(".icon",t).addClass("ui-icon ui-icon-check").removeClass("loading ui-icon-alert"):(n(".icon",t).removeClass("ui-icon ui-icon-check ui-icon-alert"),"connecting"==e&&n(".icon",t).addClass("loading"))},setStatus:function(t){var e=this;n(".icon",e.statusEl).removeClass("jt-faded"),e.setIcon(n(e.statusEl),t),"error"!=t&&"success"!=t||setTimeout((function(){n(".icon",e.statusEl).addClass("jt-faded");var t=!1;n(".logline",e.listRoot).each((function(){"connecting"==n(e).data("status")&&(t=!0)})),t&&e.setStatus("connecting")}),e.statusDelay)},addLine:function(t){var e=this,i=r.ui.fillTemplate("#jtox-logline",t);for(i.height("0px"),this.listRoot.insertBefore(i[0],this.listRoot.firstElementChild),setTimeout((function(){i.height(e.lineHeight)}),150),e.hasDetails&&n(".icon",i[0]).on("click",(function(t){if(i.toggleClass("openned"),i.hasClass("openned")){var s=0;n(".data-field",i[0]).each((function(){s+=this.offsetHeight})),i.height(s+6)}else i.height(e.lineHeight);t.stopPropagation()}));this.listRoot.childNodes.length>e.keepMessages;)this.listRoot.removeChild(this.listRoot.lastElementChild);return i},beforeRequest:function(t){r.ui.parseURL(t.url);var e=this.formatEvent(t),i=this.addLine(e);this.setStatus("connecting"),this.events[t.logId=Date.now()]=i,this.setIcon(i,"connecting"),i.data("status","connecting")},afterResponse:function(t,e,i){var n=this.formatEvent(e,i),s=this.events[e.logId],a=t?"success":"error";this.setStatus(a),s?(delete this.events[e.logId],this.setIcon(s,a),r.ui.fillTree(s[0],n),"error"==a&&console&&console.log("Error ["+e.service+"]: "+i.statusText)):console.log("jToxLog: missing line for:"+e.service+"("+i.statusText+")")}},PageShowing.prototype={__expects:["nextPage","previousPage"],innerWindow:4,outerWindow:1,prevLabel:"&laquo; Previous",nextLabel:"Next &raquo;",separator:" ",gapMarker:function(){return'<span class="pager-gap">&hellip;</span>'},windowedLinks:function(){var t=[],e=null;visible=this.visiblePageNumbers();for(var i=0,n=visible.length;i<n;i++)e&&visible[i]>e+1&&t.push(this.gapMarker()),t.push(this.pageLinkOrSpan(visible[i],["pager-current"])),e=visible[i];return t},visiblePageNumbers:function(){var t=this.currentPage-this.innerWindow,e=this.currentPage+this.innerWindow,i=[];e>this.totalPages&&(t=Math.max(0,t-(e-this.totalPages)),e=this.totalPages),t<1&&(e=Math.min(this.totalPages,e+(1-t)),t=1),i.push(1);for(var n=2;n<=Math.min(1+this.outerWindow,t-1);n++)i.push(n);1+this.outerWindow==t-2&&i.push(t-1);for(n=Math.max(2,t);n<=Math.min(e,this.totalPages-1);n++)i.push(n);this.totalPages-this.outerWindow==e+2&&i.push(e+1);for(n=Math.max(this.totalPages-this.outerWindow,e+1);n<this.totalPages;n++)i.push(n);return this.totalPages>1&&i.push(this.totalPages),i},pageLinkOrSpan:function(t,e,i){return i=i||t,t&&t!=this.currentPage?$('<a href="#"></a>').html(i).attr("rel",this.relValue(t)).addClass(e[1]).click(this.clickHandler(t)):$("<span></span>").html(i).addClass(e.join(" "))},relValue:function(t){switch(t){case this.previousPage():return"prev"+(1==t?"start":"");case this.nextPage():return"next";case 1:return"start";default:return""}},renderHeader:function(t,e,i){},renderLinks:function(t){if(this.totalPages){t.unshift(this.pageLinkOrSpan(this.previousPage(),["pager-disabled","pager-prev"],this.prevLabel)),t.push(this.pageLinkOrSpan(this.nextPage(),["pager-disabled","pager-next"],this.nextLabel));var e=$(this.target);e.empty();for(var i=0,n=t.length;i<n;i++){var s=$("<li></li>");this.separator&&i>0&&s.append(this.separator),e.append(s.append(t[i]))}}},afterResponse:function(){e.pass(this,PageShowing,"afterResponse"),$(this.target).empty(),this.renderLinks(this.windowedLinks()),this.renderHeader(this.pageSize,(this.currentPage-1)*this.pageSize,this.totalEntries)}},Passing.prototype={runSelector:".switcher",runMethod:null,runTarget:null},Tagging.prototype={__expects:["hasValue","clickHandler"],color:null,renderItem:null,onUpdated:null,subtarget:null,init:function(t){e.pass(this,Tagging,"init",t),this.manager=t},populate:function(t,i){var n,s,a,r=null,o=0;if(null==t.length||0==t.length)i||this.target.html("No items found in this selection").addClass("jt-no-tags");else{this.target.removeClass("jt-no-tags"),t.sort((function(t,e){return(t.value||t.val)<(e.value||e.val)?-1:1})),i||this.target.empty();for(var l=0,u=t.length;l<u;l++)a=(r=t[l]).value||r.val,s=this.exclusion&&this.hasValue(a),o+=r.count,r.title=a.toString(),"function"==typeof this.modifyTag&&(r=this.modifyTag(r)),s||(r.onMain=this.clickHandler(a)),this.target.append(n=this.renderItem(r)),s&&n.addClass("selected")}e.act(this,this.onUpdated,o)}};var h=/\W/g;InnerTagWidgeting.prototype={pivotWidget:null,hasValue:function(t){return this.pivotWidget.hasValue(this.id+":"+t)},clickHandler:function(t){return this.pivotWidget.clickHandler(this.id+":"+t)},modifyTag:function(t){return t.hint=t.unit?"\n"+t.unit.buckets.map((function(t){return buildValueRange(t,!0)})).join("\n"):t.buildValueRange(t),t.color=this.color,t}};var c=e(Tagging,InnerTagWidgeting);function PivotShowing(t){e.setup(this,t),this.target=t.target,this.targets={},this.lastEnabled=0,this.initialPivotCounts=null}function SliderShowing(t){e.setup(this,t),this.target=$(t.target),this.prepareLimits(t.limits),null==this.initial&&(this.initial=this.isRange?[this.limits[0],this.limits[1]]:(this.limits[0]+this.limits[1])/2),this.target.val(Array.isArray(this.initial)?this.initial.join(","):this.initial),this.automatic&&this.makeSlider()}function SimpleRanger(t){this.sliderRoot=t.sliderRoot}PivotShowing.prototype={__expects:["getFaceterEntry","getPivotEntry","getPivotCounts","auxHandler"],automatic:!1,renderTag:null,multivalue:!1,aggregate:!1,exclusion:!1,init:function(t){e.pass(this,PivotShowing,"init",t),this.manager=t,this.manager.getListener("current").registerWidget(this,!0)},addFaceter:function(t,i){var n=e.pass(this,PivotShowing,"addFaceter",t,i);return"object"==typeof t&&(n.color=t.color),i>this.lastEnabled&&!t.disabled&&(this.lastEnabled=i),n},afterResponse:function(t){var s=this.getPivotCounts(t.facets);for(e.pass(this,PivotShowing,"afterResponse",t),i=0;i<s.length;++i){var a=s[i],o=a.val.replace(h,"_"),l=this.targets[o];l?l.target.children("ul").hide():(this.targets[o]=l=new r.AccordionExpansion(n.extend(!0,{},this.settings,this.getFaceterEntry(0),{id:o,title:a.val})),l.updateHandler=this.updateHandler(l),l.target.children().last().remove()),this.traversePivot(l.target,a,1),l.updateHandler(a.count)}this.target.accordion("refresh")},updateHandler:function(t){var e=t.getHeaderText();return function(t){e.textContent=r.updateCounter(e.textContent,t)}},prepareTag:function(t){var e=this.parseValue(t);return{title:e.value,color:this.faceters[e.id].color,count:"i",onMain:this.unclickHandler(t),onAux:this.auxHandler(t)}},traversePivot:function(t,e,i){var s=[],a=this.getPivotEntry(i),o=e[a.id].buckets;if(i===this.lastEnabled){var l=t.data("widget");l?t.children().slice(1).remove():((l=new c({id:a.id,color:a.color,renderItem:this.renderTag,pivotWidget:this,target:t,multivalue:this.multivalue,aggregate:this.aggregate,exclusion:this.exclusion})).init(this.manager),t.data({widget:l,id:a.id})),l.populate(o,!0),s=[]}else if(null!=o)for(var u=0,g=o.length;u<g;++u){var d,p=o[u],f=p.val.replace(h,"_");t.children().length>1?d=n("#"+f,t[0]).show():(d=r.fillTemplate(n("#tag-facet"),a).attr("id",f),p.title=p.val,p.onMain=this.clickHandler(a.id+":"+p.val),p.hint=buildValueRange(p),d.append(this.renderTag(p).addClass("category title").addClass(a.color)),s.push(d)),this.traversePivot(d,p,i+1)}t.append(s)}},SliderShowing.prototype={__expects:["updateHandler"],limits:null,units:null,initial:null,title:null,width:null,automatic:!0,isRange:!0,showScale:!0,format:"%s {{units}}",prepareLimits:function(t){this.limits="string"==typeof t?t.split(","):t,this.limits[0]=parseFloat(this.limits[0]),this.limits[1]=parseFloat(this.limits[1]),this.precision=Math.pow(10,parseInt(Math.min(1,Math.floor(Math.log10(this.limits[1]-this.limits[0]+1)-3)))),this.precision<1&&this.precision>.01&&(this.precison=.01)},updateSlider:function(t,e){Array.isArray(t)&&(t=t.join(",")),null!=e?(this.prepareLimits(e),this.target.jRange("updateRange",this.limits,t)):this.target.jRange("setValue",t)},makeSlider:function(){var t=this,e=this.limits[1]>this.limits[0],i=[r.formatNumber(this.limits[0],this.precision),this.title+(e||!this.units?"":" ("+this.units+")"),r.formatNumber(this.limits[1],this.precision)],n=t.updateHandler(),s={from:this.limits[0],to:this.limits[1],step:this.precision,scale:i,showScale:this.showScale,showLabels:e,disable:!e,isRange:this.isRange,width:this.width,format:r.formatString(this.format,this)||""};return null!=this.color&&(s.theme="theme-"+this.color),s.ondragend=function(e){return"string"==typeof e&&t.isRange&&(e=e.split(",")),e=Array.isArray(e)?e.map((function(t){return parseFloat(t)})):parseFloat(e),n(e)},this.target.jRange(s)}},SimpleRanger.prototype={__expects:["addValue","doRequest"],targetValue:null,updateHandler(){var t=this;return function(e){t.addValue(e)&&(t.sliderRoot.updateRequest=!0,t.doRequest())}},doRequest(){this.manager.doRequest()}};var g=e(s.Ranging,s.Patterning,SliderShowing,SimpleRanger,a.Delaying),d={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,echoParams:"none"};function RangeShowing(t){e.setup(this,t),this.slidersTarget=n(t.slidersTarget),this.lookupMap=t.lookupMap||{},this.pivotMap=null,this.rangeWidgets=[],Array.isArray(this.titleSkips)||(this.titleSkips=[this.titleSkips])}function Switching(i){e.setup(this,i);var s=this,a=n(s.switchSelector,n(i.target)[0]),r=t.get(s,s.switchField);"boolean"==typeof r?a[0].checked=r:a.val(r),a.on("change",(function(i){var a=n(this).val();t.set(s,s.switchField,"boolean"==typeof r?this.checked||"on"===a:a),e.act(s,s.onSwitching,i),i.stopPropagation()}))}function Texting(t){e.setup(this,t),this.target=n(t.target).find("input").on("change",this.clickHandler()),this.id=t.id}return RangeShowing.prototype={__expects:["getPivotEntry","getPivotCounts"],field:null,titleSkips:null,init:function(t){e.pass(this,RangeShowing,"init",t),this.manager=t;var i=this;i.applyCommand=n("#sliders-controls a.command.apply").on("click",(function(t){return i.skipClear=!0,i.manager.doRequest(),!1})),n("#sliders-controls a.command.close").on("click",(function(t){return i.rangeRemove(),!1}))},afterResponse:function(t){var i=this.getPivotCounts(t.facets);if(e.pass(this,RangeShowing,"afterResponse",t),this.pivotMap)if(this.updateRequest){if(this.rangeWidgets.length>0)for(var n,s,a=this.buildPivotMap(i),r=0,o=this.rangeWidgets.length;r<o;++r)s=a[(n=this.rangeWidgets[r]).targetValue],n.updateSlider([s[r].min,s[r].max])}else this.rangeRemove();else{var l=this.manager.getParameter("q").value||"";l&&"*:*"!=l||this.manager.getParameter(this.useJson?"json.filter":"fq").value||(this.pivotMap=this.buildPivotMap(i))}this.updateRequest=!1},buildPivotMap:function(t){var e=this,i={};traverser=function(t,n,a,r){var o,l=e.getPivotEntry(n),u=l.id,h=l.color;if(l.ranging&&!l.disabled&&(r=u+":"+t.val),a+=(t.val?l.field+":"+s.escapeValue(t.val):"-"+l.field+":*")+" ",o=t,null!=(l=e.getPivotEntry(n+1))&&(t=t[l.id].buckets),null!=l&&t.length)for(var c=0,g=t.length;c<g;++c)traverser(t[c],n+1,a,r);else{var d=i[r];d===undefined&&(i[r]=d=[]),d.push({id:u,pattern:a,color:h,min:o.min,max:o.max,avg:o.avg,val:o.val,count:o.count})}};for(var n=0;n<t.length;++n)traverser(t[n],0,"");return i},rangeRemove:function(){this.slidersTarget.empty().parent().removeClass("active");for(var t=0,e=this.rangeWidgets.length;t<e;++t)this.rangeWidgets[t].clearValues();this.rangeWidgets=[],this.lastPivotMap=this.lastPivotValue=null},buildTitle:function(t,e){for(var i=t.pattern.replace(/\\"/g,"%0022").match(/\w+:([^\s:\/"]+|"[^"]+")/g),n=[],s=0;s<i.length;++s){var a=i[s].match(/(\w+):([^\s:\/"]+|"[^"]+")/),r=a[2].replace(/^\s*\(\s*|\s*\)\s*$/g,"");a[1].match(e)||n.push(this.lookupMap[r]||r)}return n.join("/")+" <i>("+t.count+")</i>"},ensurePivotMap:function(t){if(null!=this.pivotMap)return!0;var e=this.useJson?"json.filter":"fq",i=this;return this.doSpying((function(t){t.removeParameters(e),t.removeParameters("fl"),t.getParameter("q").value="",t.mergeParameters(d)}),(function(e){i.pivotMap=i.buildPivotMap(i.getPivotCounts(e.facets)),i.openRangers(t)})),!1},openRangers:function(t){var e=this.pivotMap[t],i=(this.lastPivotMap=this.buildPivotMap(this.getPivotCounts()))[t];this.lastPivotValue=t,this.slidersTarget.empty().parent().addClass("active");for(var s=0,a=e.length;s<a;++s){var o,l=e[s],u=i[s],h={},c=r.ui.fillTemplate("#slider-one");this.slidersTarget.append(c),h.id=l.id,h.targetValue=t,h.color=l.color,h.field=this.field,h.limits=[l.min,l.max],h.initial=[u.min,u.max],h.target=c,h.isRange=!0,h.valuePattern=l.pattern+"{{v}}",h.automatic=!0,h.width=parseInt(this.slidersTarget.width()-n("#sliders-controls").width()-20)/(Math.min(a,2)+.1),h.title=this.buildTitle(u,/^unit[_shd]*|^effectendpoint[_shd]*/),h.units="unit"==u.id?r.ui.formatUnits(u.val):"",h.useJson=this.useJson,h.domain=this.domain,h.sliderRoot=this,this.rangeWidgets.push(o=new g(h)),o.init(this.manager)}},auxHandler:function(t){var e=this;return function(i){return i.stopPropagation(),e.rangeRemove(),t!=e.lastPivotValue&&e.ensurePivotMap(t)&&e.openRangers(t),!1}},clearValues:function(){this.rangeRemove(),e.pass(this,RangeShowing,"clearValues")}},Switching.prototype={switchSelector:".switcher",switchField:null,onSwitching:null},Texting.prototype={__expects:["clickHandler "],afterResponse:function(){n(this.target).val("")}},t.assign(r,o),r.Listing=Listing,r.Loading=Loading,r.AccordionExpansion=AccordionExpansion,r.Autocompletion=Autocompletion,r.ItemShowing=ItemShowing,r.ItemListing=ItemListing,r.Logging=Logging,r.PageShowing=PageShowing,r.Passing=Passing,r.PivotShowing=PivotShowing,r.RangeShowing=RangeShowing,r.SliderShowing=SliderShowing,r.Switching=Switching,r.Tagging=Tagging,r.Texting=Texting,r.SearchStatusShowing=SearchStatusShowing,r}));