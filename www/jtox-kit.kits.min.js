!function(e,t,i,a){CurrentSearchWidgeting=function(e){t.extend(!0,this,t.common(e,this)),this.target=e.target,this.id=e.id,this.manager=null,this.facetWidgets={},this.fqName=this.useJson?"json.filter":"fq"},CurrentSearchWidgeting.prototype={useJson:!1,renderItem:null,init:function(e){t.pass(this,CurrentSearchWidgeting,"init",e),this.manager=e},registerWidget:function(e,t){this.facetWidgets[e.id]=t},afterTranslation:function(e){var t=this,i=[],a=this.manager.getParameter("q"),n=this.manager.getAllValues(this.fqName);a.value&&!a.value.match(/^(\*:)?\*$/)&&i.push(t.renderItem({title:a.value,count:"x",onMain:function(){return a.value="",t.manager.doRequest(),!1}}).addClass("tag_fixed"));for(var s=0,r=null!=n?n.length:0;s<r;s++){var o,l=n[s],d=null;for(var u in t.facetWidgets)if(d=(o=t.manager.getListener(u)).fqParse(l))break;if(null!=d){Array.isArray(d)||(d=[d]);for(var c=0,h=d.length;c<h;++c){var p,g=d[c],f="function"==typeof o.prepareTag?o.prepareTag(g):{title:g,count:"x",color:o.color,onMain:o.unclickHandler(g)};i.push(p=t.renderItem(f).addClass("tag_selected "+(f.onAux?"tag_open":"tag_fixed"))),1<h&&p.addClass("tag_combined")}1<h&&p.addClass("tag_last")}}i.length?(i.push(t.renderItem({title:"Clear",onMain:function(){for(var e in a.value="",t.facetWidgets)t.manager.getListener(e).clearValues();return t.manager.doRequest(),!1}}).addClass("tag_selected tag_clear tag_fixed")),this.target.empty().addClass("tags").append(i)):this.target.removeClass("tags").html("<li>No filters selected!</li>")}},a.CurrentSearchWidget=t(CurrentSearchWidgeting)}(Solr,asSys,jQuery,jToxKit),function(c,h,p,g){function I(){null!=t&&clearTimeout(t),t=setTimeout(function(){var e=g.ui.modifyURL(window.location.href,"ui",encodeURIComponent(JSON.stringify(f)));e&&window.history.pushState({query:window.location.search},document.title,e),t=null},1e3)}function J(e){var t,i=t=e.title.replace(/^\"(.+)\"$/,"$1");i=t.replace(/^caNanoLab\./,"").replace(/^http\:\/\/dx\.doi\.org/,""),i=(r[i]||i).replace("NPO_","").replace(" nanoparticle","");var a=p("<span/>").html(e.count||0);"function"==typeof e.onAux&&a.click(e.onAux);var n=p("<li/>").append(p('<a href="#" class="tag" title="'+t+" "+(e.hint||"")+(i!=t?" ["+t+"]":"")+'">'+i+"</a>").append(a));return"function"==typeof e.onMain&&n.click(e.onMain),e.color&&n.addClass(e.color),n}function K(e){g.TagWidget.prototype.init.call(this,e),e.getListener("current").registerWidget(this)}function L(e){var t=this.getHeaderText();t.textContent=g.ui.updateCounter(t.textContent,e),h.act(this,this.header.data("refreshPanel"));var i=f[this.id]||{};i.values=this.getValues(),f[this.id]=i,I()}function M(e){var t="OR"==e.value.toUpperCase(),i=this.getValues();this.clearValues(),this.aggregate=!t,e.value=t?"AND":"OR";for(var a=0;a<i.length;++a)this.addValue(i[a]);this.doRequest();var n=f[this.id]||{};n.aggregate=!t,f[this.id]=n,I()}var r={},f={},i={servlet:"select",multipleSelection:!0,keepAllFacets:!0,connector:p,onPrepare:function(e){var t=e.url.indexOf("?");this.proxyUrl?(e.data={query:e.url.substr(t+1)},e.url=this.proxyUrl,e.type=e.method="POST"):e.url+=(t<0?"?":"&")+"wt=json"},topSpacing:10,nestingField:"type_s",nestingRules:{composition:{parent:"substance",limit:100},study:{parent:"substance",limit:1e4},params:{parent:"study",limit:1e4},conditions:{parent:"study",limit:1e4}},exportTypes:[],exportSolrDefaults:[{name:"facet",value:"false"},{name:"echoParams",value:"none"},{name:"rows",value:999999}],savedQueries:[],listingFields:[],reportDefinition:{},facets:[],summaryRenderers:{}},t=null;g.ui.FacetedSearch=function(e){this.id=null,h.extend(!0,this,i,e),this.serverUrl=this.solrUrl,"string"==typeof this.lookupMap&&(this.lookupMap=window[this.lookupMap]),null==this.lookupMap&&(this.lookupMap={}),r=this.lookupMap,p(e.target).html(g.ui.templates["faceted-search-kit"]),delete this.target;var t=g.ui.parseURL(window.location.href).params.ui;null!=t&&(f=JSON.parse(decodeURIComponent(t))),this.initDom(),this.initComm(),this.initExport(),this.initQueries()},g.ui.FacetedSearch.prototype={initDom:function(){this.accordion=p("#accordion"),this.accordion.accordion({heightStyle:"content",collapsible:!0,animate:200,active:!1,activate:function(e,t){if(t.newPanel&&t.newPanel[0]){var i,a=t.newHeader[0],n=t.newPanel[0],s=p("input.widget-filter",n),r=s.outerHeight(!0);p("span.ui-icon-search",a).length?i=t.newPanel.data("refreshPanel"):(i=function(){n.scrollHeight>n.clientHeight||""!=s.val()||p(a).hasClass("nested-tab")?(p(n).scrollTop(r),s.show(),p("span.ui-icon-search",a).removeClass("unused")):(s.hide(),p("span.ui-icon-search",a).addClass("unused"))},t.newPanel.data("refreshPanel",i),t.newHeader.data("refreshPanel",i),t.newHeader.append(p('<span class="ui-icon ui-icon-search"></span>').on("click",function(e){t.newPanel.animate({scrollTop:0<t.newPanel.scrollTop()?0:r},300,function(){0<t.newPanel.scrollTop()?p("input.widget-filter",n).blur():p("input.widget-filter",n).focus()}),e.stopPropagation(),e.preventDefault()}))),s.val(""),i()}}}),p(document).on("click","ul.tag-group",function(e){p(this).toggleClass("folded"),p(this).parents(".widget-root").data("refreshPanel").call()}),p(document).on("keyup","#accordion input.widget-filter",function(e){var i,a=p(this).val().toLowerCase(),t=p(this).parents("div.widget-root")[0];27==(e.keyCode||e.which)&&p(this).val(a=""),""==a?p("li,ul",t).show():p("li>a",t).each(function(){var e=p(this).closest("ul.tag-group"),t=p(this).parent();i=e.data("hidden")||0,t.hasClass("category")||(0<=this.title.toLowerCase().indexOf(a)||0<=this.innerText.toLowerCase().indexOf(a)?t.show():(t.hide(),++i)),e.length&&i&&e.data("hidden",i)}),p("ul.tag-group",t).each(function(){var e=p(this);i=parseInt(e.data("hidden"))||0,e.children().length>i+1?e.show().removeClass("folded"):e.hide().addClass("folded"),e.data("hidden",null)})});var i,a=p("#result-tabs"),n=this;a.tabs({}),p("#accordion-resizer").resizable({minWidth:150,maxWidth:450,grid:[10,10],handles:"e",start:function(e,t){i={width:a.width(),height:a.height()}},resize:function(e,t){n.accordion.accordion("refresh"),p("#query-sticky-wrapper").width(n.accordion.width()),p(this).width(function(e,t){return t-7}),a.width(i.width+t.originalSize.width-t.size.width)}}),p(".query-left#query").sticky({topSpacing:this.topSpacing,widthFromWrapper:!1})},initComm:function(){var e,s,t=h(c.Requesting,c.Spying,c.Pivoting,g.PivotWidgeting,g.RangeWidgeting),i=h(c.Requesting,c.Faceting,g.AccordionExpansion,g.TagWidget,g.Running);this.manager=e=new(h(c.Management,c.Configuring,c.QueryingJson,g.Translation,g.NestedSolrTranslation))(this),e.addListeners(new g.ResultWidget(p.extend(!0,{id:"result",target:p("#docs"),itemId:"s_uuid",nestLevel:"composition",onClick:function(e,t){if(s.findItem(t.s_uuid)<0){s.addItem(t);var i="",a=p('a[href="#basket_tab"]');a.html(g.ui.updateCounter(a.html(),s.length)),s.enumerateItems(function(e){i+=e.s_uuid+";"}),(i=g.ui.modifyURL(window.location.href,"basket",i))&&window.history.pushState({query:window.location.search},document.title,i),p("footer",this).toggleClass("add none")}},onCreated:function(e){p("footer",this).addClass("add")}},this))),e.addListeners(new(h(c.Widgets.Pager))({id:"pager",target:p("#pager"),prevLabel:"&lt;",nextLabel:"&gt;",innerWindow:1,renderHeader:function(e,t,i){p("#pager-header").html("<span>displaying "+Math.min(i,t+1)+" to "+Math.min(i,t+e)+" of "+i+"</span>")}}));for(var a=0,n=this.facets.length;a<n;++a){var r=this.facets[a],o=f[r.id];(u=new i(p.extend({target:this.accordion,expansionTemplate:"#tab-topcategory",subtarget:"ul",runMethod:M,multivalue:this.multipleSelection,aggregate:o===undefined||o.aggregate===undefined?this.aggregateFacets:o.aggregate,exclusion:this.multipleSelection||this.keepAllFacets,useJson:!0,renderItem:J,init:K,onUpdated:L,nesting:"type_s:substance",domain:{type:"parent",which:"type_s:substance"},classes:r.color},r))).afterTranslation=function(e){this.populate(this.getFacetCounts(e.facets))},p(u.target).closest("div.widget-content").find("input.switcher").val(u.aggregate?"OR":"AND"),e.addListeners(u)}for(var l in e.addListeners(new t({id:"studies",target:this.accordion,subtarget:"ul",expansionTemplate:"#tab-topcategory",before:"#cell_header",field:"loValue_d",lookupMap:this.lookupMap,pivot:this.pivot,statistics:{min:"min(loValue_d)",max:"max(loValue_d)",avg:"avg(loValue_d)"},slidersTarget:p("#sliders"),multivalue:this.multipleSelection,aggregate:this.aggregateFacets,exclusion:this.multipleSelection||this.keepAllFacets,useJson:!0,renderTag:J,classes:"dynamic-tab",nesting:"type_s:substance",domain:{type:"parent",which:"type_s:substance"}})),e.addListeners(new g.CurrentSearchWidget({id:"current",target:p("#selection"),renderItem:J,useJson:!0})),this.basket=s=new(h(g.ListWidget,g.ItemListWidget))(p.extend(!0,{id:"basket",target:p("#basket-docs"),summaryRenderers:this.summaryRenderers,itemId:"s_uuid",onClick:function(e,t){if(!1!==s.eraseItem(t.s_uuid)){p(this).remove();var i="",a=p('a[href="#basket_tab"]'),n=p("#result_"+t.s_uuid);a.html(g.ui.updateCounter(a.html(),s.length)),s.enumerateItems(function(e){i+=e.s_uuid+";"}),(i=g.ui.modifyURL(window.location.href,"basket",i))&&window.history.pushState({query:window.location.search},document.title,i),0<n.length&&p("footer",n[0]).toggleClass("add none")}else console.log("Trying to remove from basket an inexistent entry: "+JSON.stringify(t))},onCreated:function(e){p("footer",this).addClass("remove")}},this)),h.act(this,this.onPreInit,e),e.init(),f){var d=f[l].values,u=e.getListener(l);h.each(d,function(e){u.addValue(e)})}e.doRequest()},updateButtons:function(e){var t=p("button",e);if(p("#export_dataset").buttonset("option","disabled"))t.button("option","label","No target dataset selected...");else if(this.manager.getParameter("json.filter").length||"filtered"!=e.export_dataset.value)if(this.manager.response.response.numFound||"filtered"!=e.export_dataset.value){if(p(e).find("input[name=export_dataset]").val()){var i=p("#export_dataset :radio:checked + label").text().toLowerCase(),a=p(e.export_format).data("name").toUpperCase();t.button("enable").each(function(){var e=p(this);e.button("option","label",g.ui.formatString(e.data("format"),{source:i,format:a}))})}}else t.button("disable").button("option","label","No entries match the filters...");else t.button("disable").button("option","label","No filters selected...")},initQueries:function(){var i=this.manager;this.queries=new(h(g.ListWidget))({id:"queries",target:p("#saved-queries")}),this.queries.renderItem=function(e){return el$=g.ui.fillTemplate("#query-item",e),el$.data("query",e.filters),el$.on("click",function(e){var t=p(this).data("query");i.removeParameters("fq"),i.removeParameters("json.filter"),i.getParameter("q").value="",t.forEach(function(e){e.faceter?i.getListener(e.faceter).addValue(e.value):"object"==typeof e.parameter?i.addParameter(e.parameter):i.addParameter(e.name,e.value,e.domain)}),i.doRequest(),p("#result-tabs").tabs("option","active",0)}),el$},this.queries.populate(this.savedQueries)},initExport:function(){var l=this;this.prepareFormats(),this.prepareTypes(),p("#export_dataset").buttonset(),p("#export_type").buttonset(),p("#export_dataset input").on("change",function(e){l.updateButtons(this.form)}),p("#export_tab button").button({disabled:!0}),p("#report_go").on("click",function(e){var i=p(this),a=i.button("option","label");i.button("option","label","Generating the report..."),l.buildSummaryReport(function(e,t){i.button("option","label",e?a:t||a),e&&g.ui.activateDownload(null,e,"Report-"+(new Date).toISOString().replace(":","_")+".xlsx",!0)})}),p("#export_tab form").on("submit",function(e){function Db(){t.search.value=r.join(" "),t.action=l.ambitUrl+"query/substance/study/uuid?media="+encodeURIComponent(t.export_format.value)}var t=this,i=(i=t.export_format.value).substr(i.indexOf("/")+1),a=l.exportFormats[p(".data_formats .selected").data("index")],n=l.exportTypes[p(t).find("input[name=export_type]:checked").data("index")],s=n.server||a.server,r=null,o=new(h(g.Exporting,c.Configuring,c.QueryingURL))({exportDefinition:n,idField:"study"==n.exportLevel?"s_uuid_s":"s_uuid_hs",useJson:!1,expectJson:!0});return"filtered"!=t.export_dataset.value&&(r=[],l.basket.enumerateItems(function(e){r.push(e.s_uuid)})),o.init(l.manager),"ambitUrl"==s?r?Db():p.ajax(o.prepareExport([{name:"wt",value:"json"},{name:"fl",value:"s_uuid_hs"}],r).getAjax(l.serverUrl,{async:!1,dataType:"json",success:function(e){var i=[];p.each(e.response.docs,function(e,t){i.push(t.s_uuid_hs)}),Db()}})):t.action=o.prepareExport(l.exportSolrDefaults.concat("tsv"==i||"csv"==i?[{name:"wt",value:"json"},{name:"json2tsv",value:!0}]:[{name:"wt",value:i}]),r).getAjax(l[s]).url,!0}),p("#result-tabs").tabs({activate:function(e,t){if("export_tab"==t.newPanel[0].id){var i=l.manager.getParameter("q").value,a=0<(i&&i.length)||0<l.manager.getParameter("json.filter").length,n=a||!!l.basket.length;p("#export_dataset").buttonset(n?"enable":"disable"),p("#export_type").buttonset(n?"enable":"disable"),p("div.warning-message")[n?"hide":"show"](),p(".data_formats").toggleClass("disabled",!n),p("input#selected_data").prop("checked",!!l.basket.length).prop("disabled",!l.basket.length).toggleClass("disabled",!l.basket.length),p("input#filtered_data").prop("disabled",!a).toggleClass("disabled",!a),p(".data_formats .jtox-ds-download a").first().trigger("click"),p(".data_formats .jtox-ds-download a").first().trigger("click"),p("#export_dataset").buttonset("refresh")}}})},prepareFormats:function(){for(var e=p("#export_tab div.data_formats"),n=this,t=0,i=this.exportFormats.length;t<i;++t){var a=g.ui.fillTemplate("#export-format",this.exportFormats[t]);a.data("index",t),e.append(a),p("a",e[0]).on("click",function(e){var t=p(this),i=t.closest("form")[0];if(!t.hasClass("disabled")&&!t.hasClass("selected")){var a=t.closest("div.data_formats");i.export_format.value=t.data("mime"),p(i.export_format).data("name",t.data("name")),n.updateButtons(i),p("div",a[0]).removeClass("selected"),a.addClass("selected"),t.closest(".jtox-fadable").addClass("selected")}return!1})}},prepareTypes:function(){function $b(e){p(".data_formats a").addClass("disabled"),t.exportTypes[e].formats.split(",").forEach(function(e){p(".data_formats a[data-name="+e+"]").removeClass("disabled")}),p(".data_formats a:visible").not(".disabled").first().trigger("click")}for(var e=p("#export_tab div#export_type"),t=this,i=0,a=this.exportTypes.length;i<a;++i){this.exportTypes[i].selected=0==i?'checked="checked"':"";var n=g.ui.fillTemplate("#export-type",this.exportTypes[i]);n.data("index",i),e.append(n)}p("input[name=export_type]").on("change",function(e){return $b(p(this).data("index")),!1}),$b(0)},buildSummaryReport:function(a){function ic(e){if(!e)return["","","",""];var t,i=[[],[],[],[]];return _.each(e,function(e){i[0].push(e["E.method_s"]||""),i[3].push(r[e.reference_owner_s]||e.reference_owner_s),(t=_.trim(n(e)))&&i[1].push(t),(t=_.trim(s(e)))&&i[2].push(t)}),_.map(i,function(e){return _.uniq(e).join(", ")})}function jc(e){var a=new Array(o.length);return _.fill(a,null),_.each(e,function(e){if("study"===e.type_s){var t=(e.endpointcategory_s||"")+":"+(e.guidance_s||"")+":"+(e.effectendpoint_s||""),i=o.indexOf(t);(a[i]=a[i]||[]).push(e)}}),a}function kc(e){var t={};_.each(e._childDocuments_,function(e){"composition"===e.type_s&&(t[e.component_s]=t[e.component_s]||[]).push(e.CASRN_s)});var i=_.keys(t);return[i.join("\n"),_.map(t,function(e,t){return(1<i.length?t+": ":"")+e.join(",")}).join("\n"),"",""]}function oc(e){console.log(JSON.stringify(e).substr(0,256)),a(null,"string"==typeof e?e:"Error occurred!")}var e=new(h(g.Exporting,c.Configuring,c.QueryingJson))({exportDefinition:this.reportDefinition,useJson:!0,expectJson:!0}),o=[],n=function(e){var t=e.unit_s||"",i=[e.effectendpoint_type_s||"",e.textValue_s||""];return null!=e.loValue_d&&null!=e.upValue_d?i.push((">="==e.loQualifier_s?"[":"(")+g.ui.nicifyNumber(e.loValue_d)+t+" : "+g.ui.nicifyNumber(e.upValue_d)+t+("<="==e.upQualifier_s?"]":")")):null!=e.loValue_d?i.push(e.loQualifier_s||"",g.ui.nicifyNumber(e.loValue_d),t):i.push(e.upQualifier_s||"",g.ui.nicifyNumber(e.upValue_d),t),_.compact(i).join(" ")},s=function(e){return(e.errQualifier_s||"")+" "+(g.ui.nicifyNumber(e.err_d,3)||"")};e.init(this.manager),Promise.all([g.ui.promiseXHR({url:this.reportDefinition.template,settings:{responseType:"arraybuffer"}}),p.ajax(e.prepareExport().getAjax(this.solrUrl))]).then(function(e){var t=e[0],i=e[1];!function(e){var s=["endpointcategory","guidance","effectendpoint"],r=function(e,t){if(t.length>=s.length)o.push(t.join(":"));else for(var i=t.length,a=function(e){return null!=e.missing&&0<e.missing.count&&(e.missing.val="",e.buckets.unshift(e.missing)),e.buckets}(e[s[i]]),n=0;n<a.length;++n)r(a[n],t.concat([a[n].val]))};r(e,[])}(i.facets),XlsxPopulate.fromDataAsync(t).then(function(e){new XlsxDataPopulate({callbacksMap:{lookup:function(e){return r[e]||e},substanceProps:function(){return["Method","Value","Std. Dev","Data source"]},substanceIds:kc,getEndpoints:jc,getValues:ic,toxicColor:function(e){return{high:"CC0000",medium:"00CCCC",low:"00CC00"}[e]||(e!==undefined?"CCCCCC":e)}}}).processData(e,i),e.outputAsync().then(a,oc)},oc)},oc)}}}(Solr,asSys,jQuery,jToxKit),function(n,s,r){r.ui.Logging=function(e){var t=s(e.target);if(n.extend(!0,this,n.common(e,this)),this.target=e.target,t.html(r.ui.templates["logger-main"]),t.addClass("jtox-toolkit jtox-log"),"number"==typeof this.lineHeight&&(this.lineHeight=this.lineHeight.toString()+"px"),"number"!=typeof this.keepMessages&&(this.keepMessages=parseInt(this.keepMessages)),this.listRoot=s(".list-root",this.target)[0],this.statusEl=s(".status",this.target)[0],this.rightSide?(this.statusEl.style.right="0px",t.addClass("right-side")):this.statusEl.style.left="0px",this.setStatus(""),this.events={},this.autoHide&&(t.bind("click",function(e){s(this).toggleClass("hidden")}),t.bind("mouseleave",function(e){s(this).addClass("hidden")})),this.mountDestination){var i="object"==typeof this.mountDestination?this.mountDestination:n.path(window,this.mountDestination),a=this;i.onPrepare=function(e){return a.beforeRequest(e)},i.onSuccess=function(e,t,i){return a.afterRequest(e,i,t)},i.onError=function(e,t){return a.afterFailure(e,t)}}},r.ui.Logging.prototype={mountDestination:null,statusDelay:1500,keepMessages:50,lineHeight:"20px",rightSide:!1,hasDetails:!0,autoHide:!0,formatEvent:function(e,t){return null!=t?{details:t.status+" "+t.statusText+"<br/>"+t.getAllResponseHeaders()}:null!=e?{header:e.method.toUpperCase()+": "+e.service,details:"..."}:null},setIcon:function(e,t){"error"==t?e.addClass("ui-state-error"):e.removeClass("ui-state-error"),e.data("status",t),"error"==t?s(".icon",e).addClass("ui-icon ui-icon-alert").removeClass("loading ui-icon-check"):"success"==t?s(".icon",e).addClass("ui-icon ui-icon-check").removeClass("loading ui-icon-alert"):(s(".icon",e).removeClass("ui-icon ui-icon-check ui-icon-alert"),"connecting"==t&&s(".icon",e).addClass("loading"))},setStatus:function(e){var t=this;s(".icon",t.statusEl).removeClass("jt-faded"),t.setIcon(s(t.statusEl),e),"error"!=e&&"success"!=e||setTimeout(function(){s(".icon",t.statusEl).addClass("jt-faded");var e=!1;s(".logline",t.listRoot).each(function(){"connecting"==s(t).data("status")&&(e=!0)}),e&&t.setStatus("connecting")},t.statusDelay)},addLine:function(e){var i=this,a=r.ui.fillTemplate("#jtox-logline",e);for(a.height("0px"),this.listRoot.insertBefore(a[0],this.listRoot.firstElementChild),setTimeout(function(){a.height(i.lineHeight)},150),i.hasDetails&&s(".icon",a[0]).on("click",function(e){if(a.toggleClass("openned"),a.hasClass("openned")){var t=0;s(".data-field",a[0]).each(function(){t+=this.offsetHeight}),a.height(t+6)}else a.height(i.lineHeight);e.stopPropagation()});this.listRoot.childNodes.length>i.keepMessages;)this.listRoot.removeChild(this.listRoot.lastElementChild);return a},beforeRequest:function(e){var t=r.ui.parseURL(e.url),i=(e.service=t.protocol+"://"+t.host+t.path,this.formatEvent(e)),a=this.addLine(i);this.setStatus("connecting"),this.events[e.logId=Date.now()]=a,this.setIcon(a,"connecting"),a.data("status","connecting")},afterRequest:function(e,t,i){var a=this.formatEvent(t,i),n=this.events[t.logId];this.setStatus("success"),n?(delete this.events[t.logId],this.setIcon(n,"success"),r.ui.fillTree(n[0],a)):console.log("jToxLog: missing line for:"+t.service)},afterFailure:function(e,t){var i=this.formatEvent(t,e),a=this.events[t.logId];this.setStatus("error"),a?(delete this.events[t.logId],this.setIcon(a,"error"),r.ui.fillTree(a[0],i),console&&console.log("Error ["+t.service+"]: "+e.statusText)):console.log("jToxLog: missing line for:"+t.service+"("+e.statusText+")")}}}(asSys,jQuery,jToxKit),function(e,r,h,p){function buildValueRange(e,t){var i=" = ";return i+=null==e.min?"-&#x221E;":e.min,e.avg&&(i+="&#x2026;"+e.avg),i+="&#x2026;"+(null==e.max?"&#x221E;":e.max),t&&(i+=" "+p.ui.formatUnits(e.val).replace(/<sup>(2|3)<\/sup>/g,"&#x00B$1;").replace(/<sup>(\d)<\/sup>/g,"^$1")),i}function InnerTagWidgeting(e){this.id=e.id,this.pivotWidget=e.pivotWidget}var g=/\W/g;InnerTagWidgeting.prototype={pivotWidget:null,hasValue:function(e){return this.pivotWidget.hasValue(this.id+":"+e)},clickHandler:function(e){return this.pivotWidget.clickHandler(this.id+":"+e)},modifyTag:function(e){return e.hint=e.unit?"\n"+e.unit.buckets.map(function(e){return buildValueRange(e,!0)}).join("\n"):e.buildValueRange(e),e.color=this.color,e}};var f=r(p.TagWidget,InnerTagWidgeting);p.PivotWidgeting=function(e){r.extend(!0,this,r.common(e,this)),this.target=e.target,this.targets={},this.lastEnabled=0,this.initialPivotCounts=null},p.PivotWidgeting.prototype={__expects:["getFaceterEntry","getPivotEntry","getPivotCounts","auxHandler"],automatic:!1,renderTag:null,multivalue:!1,aggregate:!1,exclusion:!1,init:function(e){r.pass(this,p.PivotWidgeting,"init",e),this.manager=e,this.manager.getListener("current").registerWidget(this,!0)},addFaceter:function(e,t){var i=r.pass(this,p.PivotWidgeting,"addFaceter",e,t);return"object"==typeof e&&(i.color=e.color),t>this.lastEnabled&&!e.disabled&&(this.lastEnabled=t),i},afterTranslation:function(e){var t=this.getPivotCounts(e.facets);for(r.pass(this,p.PivotWidgeting,"afterTranslation",e),i=0;i<t.length;++i){var a=t[i],n=a.val.replace(g,"_"),s=this.targets[n];s?s.target.children("ul").hide():(this.targets[n]=s=new p.AccordionExpansion(h.extend(!0,{},this.settings,this.getFaceterEntry(0),{id:n,title:a.val})),s.updateHandler=this.updateHandler(s),s.target.children().last().remove()),this.traversePivot(s.target,a,1),s.updateHandler(a.count)}this.target.accordion("refresh")},updateHandler:function(e){var t=e.getHeaderText();return function(e){t.textContent=p.ui.updateCounter(t.textContent,e)}},prepareTag:function(e){var t=this.parseValue(e);return{title:t.value,color:this.faceters[t.id].color,count:"i",onMain:this.unclickHandler(e),onAux:this.auxHandler(e)}},traversePivot:function(e,t,i){var a=[],n=this.getPivotEntry(i),s=t[n.id].buckets;if(i===this.lastEnabled){var r=e.data("widget");r?e.children().slice(1).remove():((r=new f({id:n.id,color:n.color,renderItem:this.renderTag,pivotWidget:this,target:e,multivalue:this.multivalue,aggregate:this.aggregate,exclusion:this.exclusion})).init(this.manager),e.data({widget:r,id:n.id})),r.populate(s,!0),a=[]}else if(null!=s)for(var o=0,l=s.length;o<l;++o){var d,u=s[o],c=u.val.replace(g,"_");1<e.children().length?d=h("#"+c,e[0]).show():(d=p.ui.fillTemplate(h("#tag-facet"),n).attr("id",c),u.title=u.val,u.onMain=this.clickHandler(n.id+":"+u.val),u.hint=buildValueRange(u),d.append(this.renderTag(u).addClass("category title").addClass(n.color)),a.push(d)),this.traversePivot(d,u,i+1)}e.append(a)}}}(Solr,asSys,jQuery,jToxKit),function(p,l,u,c){function SimpleRanger(e){this.sliderRoot=e.sliderRoot}SimpleRanger.prototype.__expects=["addValue","doRequest"],SimpleRanger.prototype.targetValue=null,SimpleRanger.prototype.updateHandler=function(){var t=this;return function(e){t.addValue(e)&&(t.sliderRoot.updateRequest=!0,t.doRequest())}},SimpleRanger.prototype.doRequest=function(){this.manager.doRequest()},SingleRangeWidget=l(p.Ranging,p.Patterning,c.SliderWidget,SimpleRanger,p.Delaying);var n={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,echoParams:"none"};c.RangeWidgeting=function(e){l.extend(!0,this,l.common(e,this)),this.slidersTarget=u(e.slidersTarget),this.lookupMap=e.lookupMap||{},this.pivotMap=null,this.rangeWidgets=[],this.rangeCapable={},Array.isArray(this.titleSkips)||(this.titleSkips=[this.titleSkips])},c.RangeWidgeting.prototype={__expects:["getPivotEntry","getPivotCounts"],field:null,titleSkips:null,init:function(e){l.pass(this,c.RangeWidgeting,"init",e),this.manager=e;var t=this;t.applyCommand=u("#sliders-controls a.command.apply").on("click",function(e){return t.skipClear=!0,t.manager.doRequest(),!1}),u("#sliders-controls a.command.close").on("click",function(e){return t.rangeRemove(),!1})},afterTranslation:function(e){var t=this.getPivotCounts(e.facets);if(l.pass(this,c.RangeWidgeting,"afterTranslation",e),this.pivotMap)if(this.updateRequest){if(0<this.rangeWidgets.length)for(var i,a,n=this.buildPivotMap(t),s=0,r=this.rangeWidgets.length;s<r;++s)a=n[(i=this.rangeWidgets[s]).targetValue],i.updateSlider([a[s].min,a[s].max])}else this.rangeRemove();else{var o=this.manager.getParameter("q").value||"";o&&"*:*"!=o||this.manager.getParameter(this.useJson?"json.filter":"fq").value||(this.pivotMap=this.buildPivotMap(t))}this.updateRequest=!1},buildPivotMap:function(e){var c=this,h={};traverser=function(e,t,i,a){var n,s=c.getPivotEntry(t),r=s.id,o=s.color;if(s.ranging&&!s.disabled&&(a=r+":"+e.val),i+=(e.val?s.field+":"+p.escapeValue(e.val):"-"+s.field+":*")+" ",n=e,null!=(s=c.getPivotEntry(t+1))&&(e=e[s.id].buckets),null!=s&&e.length)for(var l=0,d=e.length;l<d;++l)traverser(e[l],t+1,i,a);else{var u=h[a];u===undefined&&(h[a]=u=[]),u.push({id:r,pattern:i,color:o,min:n.min,max:n.max,avg:n.avg,val:n.val,count:n.count}),c.rangeCapable[c.parseValue(a).id]=!0}};for(var t=0;t<e.length;++t)traverser(e[t],0,"");return h},rangeRemove:function(){this.slidersTarget.empty().parent().removeClass("active");for(var e=0,t=this.rangeWidgets.length;e<t;++e)this.rangeWidgets[e].clearValues();this.rangeWidgets=[],this.lastPivotMap=this.lastPivotValue=null},buildTitle:function(e,t){for(var i=e.pattern.replace(/\\"/g,"%0022").match(/\w+:([^\s:\/"]+|"[^"]+")/g),a=[],n=0;n<i.length;++n){var s=i[n].match(/(\w+):([^\s:\/"]+|"[^"]+")/),r=s[2].replace(/^\s*\(\s*|\s*\)\s*$/g,"");s[1].match(t)||a.push(this.lookupMap[r]||r)}return a.join("/")+" <i>("+e.count+")</i>"},ensurePivotMap:function(t){if(null!=this.pivotMap)return!0;var i=this.useJson?"json.filter":"fq",a=this;return this.doSpying(function(e){e.removeParameters(i),e.removeParameters("fl"),e.getParameter("q").value="",e.mergeParameters(n)},function(e){a.pivotMap=a.buildPivotMap(a.getPivotCounts(e.facets)),a.openRangers(t)}),!1},openRangers:function(e){var t=this.pivotMap[e],i=(this.lastPivotMap=this.buildPivotMap(this.getPivotCounts()))[e];this.lastPivotValue=e,this.slidersTarget.empty().parent().addClass("active");for(var a=0,n=t.length;a<n;++a){var s,r=t[a],o=i[a],l={},d=c.ui.fillTemplate("#slider-one");this.slidersTarget.append(d),l.id=r.id,l.targetValue=e,l.color=r.color,l.field=this.field,l.limits=[r.min,r.max],l.initial=[o.min,o.max],l.target=d,l.isRange=!0,l.valuePattern=r.pattern+"{{v}}",l.automatic=!0,l.width=parseInt(this.slidersTarget.width()-u("#sliders-controls").width()-20)/(Math.min(n,2)+.1),l.title=this.buildTitle(o,/^unit[_shd]*|^effectendpoint[_shd]*/),l.units="unit"==o.id?c.ui.formatUnits(o.val):"",l.useJson=this.useJson,l.domain=this.domain,(l.sliderRoot=this).rangeWidgets.push(s=new SingleRangeWidget(l)),s.init(this.manager)}},auxHandler:function(t){var i=this,e=this.parseValue(t);return this.rangeCapable[e.id]?function(e){return e.stopPropagation(),i.rangeRemove(),t!=i.lastPivotValue&&i.ensurePivotMap(t)&&i.openRangers(t),!1}:undefined},clearValues:function(){this.rangeRemove(),l.pass(this,c.RangeWidgeting,"clearValues")}}}(Solr,asSys,jQuery,jToxKit),function(e,l,d,u){var r='<a href="{{href}}" title="{{hint}}" target="{{target}}" class="{{css}}">{{value}}</a>';u.ItemListWidget=function(e){e.baseUrl=u.ui.fixBaseUrl(e.baseUrl)+"/",l.extend(!0,this,l.common(e,this)),this.lookupMap=e.lookupMap||{},this.target=e.target,this.id=e.id},u.ItemListWidget.prototype={baseUrl:"",summaryPrimes:["RESULTS"],tagDbs:{},onCreated:null,onClick:null,summaryRenderers:{RESULTS:function(e,t){var i=this;return e.map(function(e){return e.split(".").map(function(e){return i.lookupMap[e]||e}).join(".")})},REFOWNERS:function(e,t){return{topic:"Study Providers",content:e.map(function(e){return u.ui.formatString(r,{href:"#",hint:"Freetext search",target:"_self",value:e,css:"freetext_selector"})})}},REFS:function(e,t){return{topic:"References",content:e.map(function(e){var t=e.match(/^doi:(.+)$/);return t=null!=t?"https://www.doi.org/"+t[1]:e,u.ui.formatString(t.match(/^https?:\/\//)?r:'<span title="{{hint}}" class="{{css}}">{{value}}</span>',{href:t,hint:"External reference",target:"ref",value:e})})}}},renderItem:function(t){var i=this,a=d(this.renderSubstance(t));return a.length&&(d(this.target).append(a),"function"==typeof this.onClick&&d("a.command",a[0]).on("click",function(e){i.onClick.call(a[0],e,t,i)}),"function"==typeof this.onCreated&&this.onCreated.call(a,t,this),d("a.more",a[0]).on("click",function(e){e.preventDefault(),e.stopPropagation();var t=d(this),i=d(".more-less",t.parent()[0]);return i.is(":visible")?(i.hide(),t.text("more")):(i.show(),t.text("less")),!1})),null},renderSubstance:function(e){function qg(e){return e.map(function(e){return u.ui.formatString(t,e)}).join("")}var t=d("#summary-item").html(),i=this.buildSummary(e),a=this.getBaseUrl(e),n={logo:this.tagDbs[e.dbtag_hss]&&this.tagDbs[e.dbtag_hss].icon||"images/logo.png",link:"#",href:"#",title:(e.publicname||e.name)+(e.pubname===e.name?"":"  ("+e.name+")")+(null==e.substanceType?"":" "+(this.lookupMap[e.substanceType]||e.substanceType)),composition:this.renderComposition(e,'<a href="'+a+e.s_uuid+'/structure" title="Composition" target="'+e.s_uuid+'">&hellip;</a>').join("<br/>"),summary:0<i.length?qg(i.splice(0,this.summaryPrimes.length)):"",item_id:(this.prefix||this.id||"item")+"_"+e.s_uuid,footer:'<a href="'+a+e.s_uuid+'" title="Substance" target="'+e.s_uuid+'">Material</a><a href="'+a+e.s_uuid+'/structure" title="Composition" target="'+e.s_uuid+'">Composition</a><a href="'+a+e.s_uuid+'/study" title="Study" target="'+e.s_uuid+'">Studies</a>'};if(0<i.length&&(n.summary+='<a href="#" class="more">more</a><div class="more-less" style="display:none;">'+qg(i)+"</div>"),null==e.content)n.link=a+e.s_uuid,n.href=n.link+"/study",n.href_title="Study",n.href_target=e.s_uuid;else{var s="External database";if(e.owner_name&&0===e.owner_name.lastIndexOf("caNano",0)?(n.logo="images/canano.jpg",n.href_title="caNanoLab: "+n.link,n.href_target=s="caNanoLab",n.footer=""):(n.logo="images/external.png",n.href_title="External: "+n.link,n.href_target="external"),0<e.content.length){n.link=e.content[0];for(var r=0,o=e.content.length;r<o;r++)n.footer+='<a href="'+e.content[r]+'" target="external">'+s+"</a>"}}return u.ui.fillTemplate("#result-item",n)},getBaseUrl:function(e){if(this.tagDbs[e.dbtag_hss]===undefined)return this.baseUrl;var t=this.tagDbs[e.dbtag_hss].server,i=t.substr(-1);return t+("/"!=i?"/substance/":"substance/")},renderComposition:function(e,n){var s=[],t=e._extended_&&e._extended_.composition;if(t){var i={};l.each(t,function(e){var t=i[e.component_s],a=[];t===undefined&&(i[e.component_s]=t=[]),l.each(e,function(e,t){var i=t.match(/^(\w+)_[shd]+$/);(t=i&&i[1]||t).match(/type|id|component/)||a.push(u.ui.formatString(r,{href:"#",hint:"Freetext search on '"+t+"'",target:"_self",value:e,css:"freetext_selector"}))}),t.push(a.join(", "))}),l.each(i,function(e,t){for(var i="",a=0;a<e.length;++a)""!=e[a]&&(i+=0==a?": ":"; ",1<e.length&&(i+="<strong>["+(a+1)+"]</strong>&nbsp;"),i+=e[a]);""===i&&(i=":&nbsp;"+n),i=t+" ("+e.length+")"+i,s.push(i)})}return s},buildSummary:function(e){var r=this,o=[];return l.each(e,function(e,t){var i=t.match(/^SUMMARY\.([^_]+)_?[hsd]*$/);if(i){i=i[1];var a=r.summaryRenderers[i]||r.summaryRenderers._,n="function"==typeof a?a.call(r,e,i):e;if(n){"object"!=typeof n||Array.isArray(n)?n={topic:i.toLowerCase(),values:n}:null==n.topic&&(n.topic=i.toLowerCase()),n.content||(n.content=Array.isArray(n.values)?n.values.join(", "):n.values.toString());var s=r.summaryPrimes.indexOf(i);-1<s&&s<o.length?o.splice(s,0,n):o.push(n)}}}),o}},u.ResultWidgeting=function(e){l.extend(!0,this,l.common(e,this))},u.ResultWidgeting.prototype={__expects:["populate"],init:function(e){l.pass(this,u.ResultWidgeting,"init",e),this.manager=e},beforeRequest:function(){d(this.target).html(d("<img>").attr("src","images/ajax-loader.gif"))},afterFailure:function(e,t){d(this.target).html("Error retrieving data!")},afterTranslation:function(e){d(this.target).empty(),this.populate(e.entries)}},u.ResultWidget=l(e.Listing,u.ListWidget,u.ItemListWidget,u.ResultWidgeting)}(Solr,asSys,jQuery,jToxKit),jToxKit.ui.templates["faceted-search-kit"]='<div class="query-container">\x3c!-- left --\x3e<div id="query" class="query-left"><div id="accordion-resizer" class="ui-widget-content"><div id="accordion"></div></div></div>\x3c!-- right --\x3e<div id="result-tabs" class="query-right"><ul><li><a href="#hits_tab">Hits list</a></li><li><a href="#basket_tab">Selection</a></li><li><a href="#queries_tab">Saved Queries</a></li><li class="jtox-ds-export"><a href="#export_tab">Export</a></li></ul><div id="hits_tab"><div class="row remove-bottom"><ul class="tags remove-bottom" id="selection"></ul><footer><div id="sliders-controls"><a href="#" class="jtox-fadable command close">Close</a></div><div id="sliders"></div></footer></div><div id="navigation"><ul id="pager"></ul><div id="pager-header"></div></div><div class="docs_wrapper"><section id="docs" class="item-list"></section></div></div><div id="basket_tab"><section id="basket-docs" class="item-list"></section><div style="padding-top: 70px;"></div></div><div id="queries_tab"><section id="saved-queries" class="item-list"></section><div style="padding-top: 70px;"></div></div><div id="export_tab"><form target="_blank" method="post"><input type="hidden" name="search" /><h6>Select dataset to export</h6><div id="export_dataset"><input type="radio" value="filtered" name="export_dataset" id="filtered_data"checked="checked" /><label for="filtered_data">Filtered entries</label><input type="radio" value="selected" name="export_dataset" id="selected_data" /><label for="selected_data">Selected entries</label></div><h6>Select export type</h6><div id="export_type"></div><h6>Select output format</h6><input type="hidden" name="export_format" id="export_format" /><div class="data_formats"></div><br /><button id="export_go" type="submit" name="export_go" data-format="Download {{source}} as {{format}}">?</button><br /><button id="report_go" type="button" name="report_go" data-format="Generate summary report for {{source}}">?</button><div class="ui-state-error ui-corner-all warning-message" style="padding: 0 .7em;"><p><span class="ui-icon ui-icon-alert"style="float: left; margin-right: .3em;"></span><strong>Warning: </strong>Please, either add entries to the selection or some filters to the query.</p></div></form></div></div>\x3c!-- query container --\x3e</div>',jToxKit.ui.templates["faceted-search-templates"]='<section id="result-item"><article id="{{item_id}}" class="item"><header>{{title}}<a href="{{href}}" title="{{href_title}}" target="{{href_target}}"><spanclass="ui-icon ui-icon-extlink" style="float:right;margin:0;"></span></a></header><a href="{{link}}" title="{{link}}" class="avatar" target="_blank"><img jt-src="{{logo}}" /></a><div class="composition">{{composition}}</div>{{summary}}<footer class="links">{{footer}}<a href="#" class="add jtox-fadable command">Add to Selection</a><a href="#" class="remove jtox-fadable command">Remove from Selection</a><a href="#" class="none jtox-fadable command">Already added</a></footer></article></section><div id="summary-item"><div class="one-summary"><span class="topic">{{topic}}:</span><span class="value">{{content}}</span></div></div><div id="tag-facet"><ul class="tags tag-group folded"></ul></div><section id="query-item"><article id="{{id}}" class="item"><header>{{title}}</header><div class="composition">{{description}}<a href="#" title="Apply the query"><span style="float:right;margin:0;">Apply</span></a></div></article></section><div id="tab-topcategory"><h3 id="{{id}}_header" class="nested-tab">{{title}}</h3><div id="{{id}}" class="widget-content widget-root"><div><input type="text" placeholder="Filter_" class="widget-filter" /><input type="button" class="switcher" value="OR" /></div><ul class="widget-content tags remove-bottom" data-color="{{color}}"></ul></div></div><div id="slider-one"><input type="hidden" /></div><div id="export-type"><input type="radio" value="{{fields}}" {{selected}} name="export_type" id="{{name}}" /><label for="{{name}}">{{name}}</label></div><div id="export-format"><div class="jtox-inline jtox-ds-download jtox-fadable"><a target="_blank" data-name="{{name}}" data-mime="{{mime}}" href="#"><img class="borderless"jt-src="{{icon}}" /></a></div></div>',jT.ui.templates["logger-main"]='<div class="list-wrap"><div class="list-root"></div></div><div class="status"><div class="icon jtox-fadable"></div></div>',jT.ui.templates["logger-line"]='<div id="jtox-logline"><div class="logline"><div class="icon"></div><span class="content data-field" data-field="header">{{header}}</span><div class="details data-field" data-field="details">{{details}}</div></div></div>';