!function(e,t,a,i){var s={},o={},r={servlet:"select",multipleSelection:!0,keepAllFacets:!0,connector:a.ajax,loggerEl:null,onPrepare:function(e){var t=e.url.indexOf("?");this.proxyUrl?(e.data={query:e.url.substr(t+1)},e.url=this.proxyUrl,e.type=e.method="POST"):e.url+=(t<0?"?":"&")+"wt=json"},topSpacing:10,nestingField:"type_s",nestingRules:{composition:{parent:"substance",limit:100},study:{parent:"substance",limit:1e4},params:{parent:"study",limit:1e4},conditions:{parent:"study",limit:1e4}},exportTypes:[],exportSolrDefaults:[{name:"facet",value:"false"},{name:"echoParams",value:"none"},{name:"rows",value:999999}],savedQueries:[],listingFields:[],summaryReports:[],facets:[],summaryRenderers:{}},n=null,uiUpdate=function(){null!=n&&clearTimeout(n),n=setTimeout((function(){var e=i.modifyURL(window.location.href,"ui",encodeURIComponent(JSON.stringify(o)));e&&window.history.pushState({query:window.location.search},document.title,e),n=null}),1e3)},tagRender=function(e){var t,i=t=e.title.replace(/^\"(.+)\"$/,"$1");i=t.replace(/^caNanoLab\./,"").replace(/^http\:\/\/dx\.doi\.org/,""),i=(s[i]||i).replace("NPO_","").replace(" nanoparticle","");var o=a("<span/>").html(e.count||0);"function"==typeof e.onAux&&o.click(e.onAux);var r=a("<li/>").append(a('<a href="#" class="tag" title="'+t+" "+(e.hint||"")+(i!=t?" ["+t+"]":"")+'">'+i+"</a>").append(o));return"function"==typeof e.onMain&&r.click(e.onMain),e.color&&r.addClass(e.color),r},tagInit=function(e){i.Tagger.prototype.init.call(this,e),e.getListener("current").registerWidget(this)},tagsUpdated=function(e){var a=this.getHeaderText();a.textContent=i.updateCounter(a.textContent,e),t.act(this,this.header.data("refreshPanel"));var s=o[this.id]||{};s.values=this.getValues(),o[this.id]=s,uiUpdate()},toggleAggregate=function(e){var t="OR"==e.value.toUpperCase(),a=this.getValues();this.clearValues(),this.aggregate=!t,e.value=t?"AND":"OR";for(var i=0;i<a.length;++i)this.addValue(a[i]);this.doRequest();var s=o[this.id]||{};s.aggregate=!t,o[this.id]=s,uiUpdate()};i.kit.FacetedSearch=function(e){this.id=null,_.merge(this,r,e),this.serverUrl=this.solrUrl,"string"==typeof this.lookupMap&&(this.lookupMap=window[this.lookupMap]),null==this.lookupMap&&(this.lookupMap={}),s=this.lookupMap,a(e.target).html(i.templates["faceted-search-kit"]),delete this.target;var t=i.parseURL(window.location.href).params.ui;null!=t&&(o=JSON.parse(decodeURIComponent(t))),this.initDom(),this.initComm(),this.initExport(),this.initQueries()},i.kit.FacetedSearch.prototype=_.extend(i.kit.FacetedSearch.prototype,{initDom:function(){this.accordion=a("#accordion"),this.accordion.accordion({heightStyle:"content",collapsible:!0,animate:200,active:!1,activate:function(e,t){if(t.newPanel&&t.newPanel[0]){var i,s=t.newHeader[0],o=t.newPanel[0],r=a("input.widget-filter",o),n=r.outerHeight(!0);a("span.ui-icon-search",s).length?i=t.newPanel.data("refreshPanel"):(i=function(){o.scrollHeight>o.clientHeight||""!=r.val()||a(s).hasClass("nested-tab")?(a(o).scrollTop(n),r.show(),a("span.ui-icon-search",s).removeClass("unused")):(r.hide(),a("span.ui-icon-search",s).addClass("unused"))},t.newPanel.data("refreshPanel",i),t.newHeader.data("refreshPanel",i),t.newHeader.append(a('<span class="ui-icon ui-icon-search"></span>').on("click",(function(e){t.newPanel.animate({scrollTop:t.newPanel.scrollTop()>0?0:n},300,(function(){t.newPanel.scrollTop()>0?a("input.widget-filter",o).blur():a("input.widget-filter",o).focus()})),e.stopPropagation(),e.preventDefault()})))),r.val(""),i()}}}),a(document).on("click","ul.tag-group",(function(e){a(this).toggleClass("folded"),a(this).parents(".widget-root").data("refreshPanel").call()})),a(document).on("keyup","#accordion input.widget-filter",(function(e){var t,i=a(this).val().toLowerCase(),s=a(this).parents("div.widget-root")[0];27==(e.keyCode||e.which)&&a(this).val(i=""),""==i?a("li,ul",s).show():a("li>a",s).each((function(){var e=a(this).closest("ul.tag-group"),s=a(this).parent();t=e.data("hidden")||0,s.hasClass("category")||(this.title.toLowerCase().indexOf(i)>=0||this.innerText.toLowerCase().indexOf(i)>=0?s.show():(s.hide(),++t)),e.length&&t&&e.data("hidden",t)})),a("ul.tag-group",s).each((function(){var e=a(this);t=parseInt(e.data("hidden"))||0,e.children().length>t+1?e.show().removeClass("folded"):e.hide().addClass("folded"),e.data("hidden",null)}))}));var e=a("#result-tabs"),t=this;e.tabs({}),a("#accordion-resizer").resizable({minWidth:150,maxWidth:450,grid:[10,10],handles:"e",start:function(t,a){resSize={width:e.width(),height:e.height()}},resize:function(e,i){t.accordion.accordion("refresh"),a("#query-sticky-wrapper").width(t.accordion.width()),a(this).width((function(e,t){return t-7}))}}),a(".query-left#query").sticky({topSpacing:this.topSpacing,widthFromWrapper:!1})},initComm:function(){var s,r,n=t(e.Eventing,i.Spying,e.Pivoting,i.Pivoter,i.Ranger),d=t(e.Eventing,e.Faceting,i.AccordionExpander,i.Tagger,i.Switcher);this.manager=s=new(t(i.Communicating,e.Configuring,e.QueryingJson,e.NestedAdapter))(this),s.addListeners(new i.widget.SolrResult(a.extend(!0,{id:"result",target:a("#docs"),itemId:"s_uuid",nestLevel:"composition",onClick:function(e,t,s,o){if(r.findItem(t.s_uuid)<0){r.addItem(t);var n="",d=a('a[href="#basket_tab"]');d.html(i.updateCounter(d.html(),r.length)),r.enumerateItems((function(e){n+=e.s_uuid+";"})),(n=i.modifyURL(window.location.href,"basket",n))&&window.history.pushState({query:window.location.search},document.title,n),a("footer",this).toggleClass("add none")}},onCreated:function(e){a("footer",this).addClass("add")}},this))),s.addListeners(new i.widget.SolrPaging({id:"pager",target:a("#pager"),prevLabel:"&lt;",nextLabel:"&gt;",innerWindow:1,renderHeader:function(e,t,i){a("#pager-header").html("<span>displaying "+Math.min(i,t+1)+" to "+Math.min(i,t+e)+" of "+i+"</span>")}}));for(var l=0,c=this.facets.length;l<c;++l){var u=this.facets[l],p=o[u.id];(f=new d(a.extend({target:this.accordion,expansionTemplate:"#tab-topcategory",subtarget:"ul",runMethod:toggleAggregate,multivalue:this.multipleSelection,aggregate:p===undefined||p.aggregate===undefined?this.aggregateFacets:p.aggregate,exclusion:this.multipleSelection||this.keepAllFacets,useJson:!0,renderItem:tagRender,onUpdated:tagsUpdated,nesting:"type_s:substance",domain:{type:"parent",which:"type_s:substance"},classes:u.color},u))).init=tagInit,f.afterResponse=function(e){this.populate(this.getFacetCounts(e.facets))},a(f.target).closest("div.widget-content").find("input.switcher").val(f.aggregate?"OR":"AND"),s.addListeners(f)}for(var h in s.addListeners(new n({id:"studies",target:this.accordion,subtarget:"ul",expansionTemplate:"#tab-topcategory",before:"#cell_header",field:"loValue_d",lookupMap:this.lookupMap,pivot:this.pivot,statistics:{min:"min(loValue_d)",max:"max(loValue_d)",avg:"avg(loValue_d)"},slidersTarget:a("#sliders"),multivalue:this.multipleSelection,aggregate:this.aggregateFacets,exclusion:this.multipleSelection||this.keepAllFacets,useJson:!0,renderTag:tagRender,classes:"dynamic-tab",nesting:"type_s:substance",domain:{type:"parent",which:"type_s:substance"}})),s.addListeners(new i.SolrQueryReporter({id:"current",target:a("#selection"),renderItem:tagRender,useJson:!0})),this.basket=r=new(t(i.Populating,i.SolrItemLister))(a.extend(!0,{id:"basket",target:a("#basket-docs"),summaryRenderers:this.summaryRenderers,itemId:"s_uuid",onClick:function(e,t){if(!1!==r.eraseItem(t.s_uuid)){a(this).remove();var s="",o=a('a[href="#basket_tab"]'),n=a("#result_"+t.s_uuid);o.html(i.updateCounter(o.html(),r.length)),r.enumerateItems((function(e){s+=e.s_uuid+";"})),(s=i.modifyURL(window.location.href,"basket",s))&&window.history.pushState({query:window.location.search},document.title,s),n.length>0&&a("footer",n[0]).toggleClass("add none")}else console&&console.log("Trying to remove from basket an inexistent entry: "+JSON.stringify(t))},onCreated:function(e){a("footer",this).addClass("remove")}},this)),t.act(this,this.onPreInit,s),s.init(),o){var m=o[h].values,f=s.getListener(h);_.each(m,(function(e){f.addValue(e)}))}this.loggerEl&&s.addListeners(i.initKit(a(this.loggerEl))),s.doRequest()},updateButtons:function(e){var t=a("button",e);if(a("#export_dataset").buttonset("option","disabled"))t.button("option","label","No target dataset selected...").button("disable");else if(a(e).find("input[name=export_dataset]").val()){var s=a("#export_dataset :radio:checked + label").text().toLowerCase(),o=a(e.export_format).data("name").toUpperCase();t.button("enable").each((function(){var e=a(this);e.button("option","label",i.formatString(e.data("format"),{source:s,format:o}))}))}},initQueries:function(){var e=this.manager;this.queries=new(t(i.Populating,i.ItemRendering))({id:"queries",target:a("#predefined-queries")}),this.queries.renderItem=function(t){return el$=i.fillTemplate("#query-item",t),el$.data("query",t.filters),el$.on("click",(function(t){var i=a(this).data("query");e.removeParameters("fq"),e.removeParameters("json.filter"),e.getParameter("q").value="",i.forEach((function(t){t.faceter?e.getListener(t.faceter).addValue(t.value):"object"==typeof t.parameter?e.addParameter(t.parameter):e.addParameter(t.name,t.value,t.domain)})),e.doRequest(),a("#result-tabs").tabs("option","active",0)})),el$},this.queries.populate(this.savedQueries)},initExport:function(){var s=this;this.prepareFormats(),this.prepareTypes();var o=a("#report_select");a.each(s.summaryReports,(function(e,t){o.append('<option id="'+t.id+'"'+(0==e?' selected="true"':"")+">"+t.name+"</option>")})),a("#export_dataset").buttonset(),a("#export_type").buttonset(),a("#export_dataset input").on("change",(function(e){s.updateButtons(this.form)})),a("#export_tab button").button({disabled:!0}),a("#report_go").on("click",(function(e){var t=a(this),o=t.button("option","label");t.button("option","label","Generating the report..."),s.buildSummaryReport((function(e,a){t.button("option","label",e?o:a||o),e&&i.activateDownload(null,e,"Report-"+(new Date).toISOString().replace(":","_")+".xlsx",!0)}))})),a("#export_tab form").on("submit",(function(o){var r=this,n=(n=r.export_format.value).substr(n.indexOf("/")+1),d=s.exportFormats[a(".data_formats .selected").data("index")],l=s.exportTypes[a(r).find("input[name=export_type]:checked").data("index")],c=l.server||d.server,u=s.getSelectedIds(r),formAmbitUrl=function(){r.search.value=u.join(" "),r.action=s.ambitUrl+"query/substance/study/uuid?media="+encodeURIComponent(r.export_format.value)},p=new(t(i.Communicating,i.Exporting,e.Configuring,e.QueryingURL))({exportDefinition:l,useJson:!1,expectJson:!0,serverUrl:"ambitUrl"==c?s.serverUrl:s[c]});return p.init(s.manager),"ambitUrl"==c?u?formAmbitUrl():s.connector(p.prepareExport([{name:"wt",value:"json"},{name:"fl",value:"s_uuid_hs"}],u).getAjax({async:!1,dataType:"json",success:function(e){var t=[];_.each(e.response.docs,(function(e,a){t.push(a.s_uuid_hs)})),formAmbitUrl()}})):r.action=p.prepareExport(s.exportSolrDefaults.concat("tsv"==n?[{name:"wt",value:"json"},{name:"json2tsv",value:!0}]:[{name:"wt",value:n}]),u).getAjax().url,!0})),a("#result-tabs").tabs({activate:function(e,t){if("export_tab"==t.newPanel[0].id){var i=s.manager.getParameter("q").value,o=(i&&i.length)>0||s.manager.getParameter("json.filter").length>0,r=!!s.basket.length,n=o||r;a("#export_dataset").buttonset(n?"enable":"disable"),a("#export_type").buttonset(n?"enable":"disable"),a("div.warning-message")[n?"hide":"show"](),a(".data_formats").toggleClass("disabled",!n),a("input#selected_data").prop("checked",r).prop("disabled",!r).toggleClass("disabled",!r),a("input#filtered_data").prop("checked",o&&!r).prop("disabled",!o).toggleClass("disabled",!o),a(".data_formats .jtox-ds-download a").first().trigger("click"),a(".data_formats .jtox-ds-download a").first().trigger("click"),a("#export_dataset").buttonset("refresh"),s.updateButtons(s.form)}}})},getSelectedIds:function(e){var t=null;return e||(e=a("#export_tab form")[0]),"filtered"!=e.export_dataset.value&&(t=[],this.basket.enumerateItems((function(e){t.push(e.s_uuid)}))),t},prepareFormats:function(){for(var e=a("#export_tab div.data_formats"),t=this,s=0,o=this.exportFormats.length;s<o;++s){var r=i.fillTemplate("#export-format",this.exportFormats[s]);r.data("index",s),e.append(r),a("a",e[0]).on("click",(function(e){var i=a(this),s=i.closest("form")[0];if(!i.hasClass("disabled")&&!i.hasClass("selected")){var o=i.closest("div.data_formats");s.export_format.value=i.data("mime"),a(s.export_format).data("name",i.data("name")),t.updateButtons(s),a("div",o[0]).removeClass("selected"),o.addClass("selected"),i.closest(".jtox-fadable").addClass("selected")}return!1}))}},prepareTypes:function(){for(var e=a("#export_tab div#export_type"),t=this,updateTypes=function(e){a(".data_formats a").addClass("disabled"),t.exportTypes[e].formats.split(",").forEach((function(e){a(".data_formats a[data-name="+e+"]").removeClass("disabled")})),a(".data_formats a:visible").not(".disabled").first().trigger("click")},s=0,o=this.exportTypes.length;s<o;++s){this.exportTypes[s].selected=0==s?'checked="checked"':"";var r=i.fillTemplate("#export-type",this.exportTypes[s]);r.data("index",s),e.append(r)}a("input[name=export_type]").on("change",(function(e){return updateTypes(a(this).data("index")),!1})),updateTypes(0)},buildSummaryReport:function(o){var r=a.extend(!0,{callbacksMap:{lookup:function(e){return s[e]||e}}},this.summaryReports[a("#report_select")[0].selectedIndex].definition);Exporter=new(t(i.Exporting,i.Communicating,e.Configuring,e.QueryingJson))({exportDefinition:r,useJson:!0,expectJson:!0,serverUrl:this.solrUrl}),selectedIds=this.getSelectedIds(),errFn=function(e){console.log(JSON.stringify(e).substr(0,256)),o(null,"string"==typeof e?"Err: "+e:"Error occurred!")},Exporter.init(this.manager),Promise.all([i.promiseXHR({url:r.template,settings:{responseType:"arraybuffer"}}),this.connector(Exporter.prepareExport(null,selectedIds).getAjax())]).then((function(e){var t=e[0],a=e[1];"function"==typeof r.onData&&r.onData(a),XlsxPopulate.fromDataAsync(t).then((function(e){try{new XlsxDataFill(new XlsxDataFill.XlsxPopulateAccess(e,XlsxPopulate),r).fillData(a),e.outputAsync().then(o,errFn)}catch(t){errFn(t.message)}}),errFn)}),errFn)}})}(Solr,asSys||a$,jQuery||$,jToxKit||jT),jToxKit.templates["faceted-search-kit"]='<div class="query-container">\x3c!-- left --\x3e<div id="query" class="query-left"><div id="accordion-resizer" class="ui-widget-content"><div id="accordion"></div></div></div>\x3c!-- right --\x3e<div id="result-tabs" class="query-right"><ul><li><a href="#hits_tab">Hits list</a></li><li><a href="#basket_tab">Selection</a></li><li><a href="#queries_tab">Predefined Queries</a></li><li class="jtox-ds-export"><a href="#export_tab">Export</a></li></ul><div id="hits_tab"><div class="row remove-bottom"><ul class="tags remove-bottom" id="selection"></ul><footer><div id="sliders-controls"><a href="#" class="jtox-fadable command close">Close</a></div><div id="sliders"></div></footer></div><div id="navigation"><ul id="pager"></ul><div id="pager-header"></div></div><div class="docs_wrapper"><section id="docs" class="item-list"></section></div></div><div id="basket_tab"><section id="basket-docs" class="item-list"></section><div style="padding-top: 70px;"></div></div><div id="queries_tab"><section id="predefined-queries" class="item-list"></section><div style="padding-top: 70px;"></div></div><div id="export_tab"><form target="_blank" method="post"><input type="hidden" name="search"/><h6>Select dataset to export</h6><div id="export_dataset"><input type="radio" value="filtered" name="export_dataset" id="filtered_data" checked="checked"/><label for="filtered_data">Matched hits</label><input type="radio" value="selected" name="export_dataset" id="selected_data"/><label for="selected_data">Selected entries</label></div><h6>Select export type</h6><div id="export_type"></div><h6>Select output format</h6><input type="hidden" name="export_format" id="export_format"/><div class="data_formats"></div><br /><button id="export_go" type="submit" name="export_go" data-format="Download {{source}} as {{format}}">?</button><br /><select id="report_select" style="width: auto;"></select><button id="report_go" type="button" name="report_go" data-format="Generate summary report for {{source}}">?</button><div class="ui-state-error ui-corner-all warning-message" style="padding: 0 .7em;"><p><span class="ui-icon ui-icon-alert"style="float: left; margin-right: .3em;"></span><strong>Warning: </strong>Please, either add entries to the selection or some filters to the query.</p></div></form></div></div>\x3c!-- query container --\x3e</div>',jToxKit.templates["faceted-search-templates"]='<section id="result-item"><article id="{{item_id}}" class="item"><header>{{title}}</header><a href="{{link}}" title="{{link_title}}" class="avatar" target="{{link_target}}"><img jt-src="{{logo}}" /></a><div class="composition">{{composition}}</div>{{summary}}<footer class="links">{{footer}}<a href="#" class="add jtox-fadable command">Add to Selection</a><a href="#" class="remove jtox-fadable command">Remove from Selection</a><a href="#" class="none jtox-fadable command">Already added</a></footer></article></section><div id="summary-item"><div class="one-summary"><span class="topic">{{topic}}:</span><span class="value">{{content}}</span></div></div><div id="tag-facet"><ul class="tags tag-group folded"></ul></div><section id="query-item"><article id="{{id}}" class="item"><header>{{title}}</header><div class="composition">{{description}}<a href="#" title="Apply the query" style="width: 100%;"><span style="float:right;margin:0;">Apply</span></a></div></article></section><div id="tab-topcategory"><h3 id="{{id}}_header" class="nested-tab">{{title}}</h3><div id="{{id}}" class="widget-content widget-root"><div><input type="text" placeholder="Filter_" class="widget-filter"/><input type="button" class="switcher" value="OR"/></div><ul class="widget-content tags remove-bottom" data-color="{{color}}"></ul></div></div><div id="slider-one"><input type="hidden"/></div><div id="export-type"><input type="radio" value="{{fields}}" {{selected}} name="export_type" id="{{name}}"/><label for="{{name}}">{{name}}</label></div><div id="export-format"><div class="jtox-inline jtox-ds-download jtox-fadable"><a target="_blank" data-name="{{name}}" data-mime="{{mime}}" href="#"><img class="borderless" jt-src="{{icon}}"/></a></div></div>',jT.templates["logger-main"]='<div class="list-wrap"><div class="list-root"></div></div><div class="status"><div class="icon jtox-fadable"></div></div>',jT.templates["logger-line"]='<div id="jtox-logline"><div class="logline"><div class="icon"></div><span class="content data-field" data-field="header">{{header}}</span><div class="details data-field" data-field="details">{{details}}</div></div></div>';