!function(e,t,a,i){var s={},o={},n={servlet:"select",multipleSelection:!0,keepAllFacets:!0,connector:a,onPrepare:function(e){var t=e.url.indexOf("?");this.proxyUrl?(e.data={query:e.url.substr(t+1)},e.url=this.proxyUrl,e.type=e.method="POST"):e.url+=(t<0?"?":"&")+"wt=json"},topSpacing:10,nestingField:"type_s",nestingRules:{composition:{parent:"substance",limit:100},study:{parent:"substance",limit:1e4},params:{parent:"study",limit:1e4},conditions:{parent:"study",limit:1e4}},exportMaxRows:999999,exportTypes:[],exportLevels:{},exportSolrDefaults:["facet=false","echoParams=none"],listingFields:[],facets:[],summaryRenderers:{}},r=null,uiUpdate=function(){null!=r&&clearTimeout(r),r=setTimeout((function(){var e=i.modifyURL(window.location.href,"ui",encodeURIComponent(JSON.stringify(o)));e&&window.history.pushState({query:window.location.search},document.title,e),r=null}),1e3)},tagRender=function(e){var t,i=t=e.title.replace(/^\"(.+)\"$/,"$1");i=t.replace(/^caNanoLab\./,"").replace(/^http\:\/\/dx\.doi\.org/,""),i=(s[i]||i).replace("NPO_","").replace(" nanoparticle","");var o=a("<span/>").html(e.count||0);"function"==typeof e.onAux&&o.click(e.onAux);var n=a("<li/>").append(a('<a href="#" class="tag" title="'+t+" "+(e.hint||"")+(i!=t?" ["+t+"]":"")+'">'+i+"</a>").append(o));return"function"==typeof e.onMain&&n.click(e.onMain),e.color&&n.addClass(e.color),n},tagInit=function(e){i.Tagger.prototype.init.call(this,e),e.getListener("current").registerWidget(this)},tagsUpdated=function(e){var a=this.getHeaderText();a.textContent=i.updateCounter(a.textContent,e),t.act(this,this.header.data("refreshPanel"));var s=o[this.id]||{};s.values=this.getValues(),o[this.id]=s,uiUpdate()},toggleAggregate=function(e){var t="OR"==e.value.toUpperCase(),a=this.getValues();this.clearValues(),this.aggregate=!t,e.value=t?"AND":"OR";for(var i=0;i<a.length;++i)this.addValue(a[i]);this.doRequest();var s=o[this.id]||{};s.aggregate=!t,o[this.id]=s,uiUpdate()};i.kit.FacetedSearch=function(e){this.id=null,_.merge(this,n,e),this.serverUrl=this.solrUrl,"string"==typeof this.lookupMap&&(this.lookupMap=window[this.lookupMap]),null==this.lookupMap&&(this.lookupMap={}),s=this.lookupMap,a(e.target).html(i.templates["faceted-search-kit"]),delete this.target;var t=i.parseURL(window.location.href).params.ui;null!=t&&(o=JSON.parse(decodeURIComponent(t))),this.initDom(),this.initComm(),this.initExport()},i.kit.FacetedSearch.prototype=_.extend(i.kit.FacetedSearch.prototype,{initDom:function(){this.accordion=a("#accordion"),this.accordion.accordion({heightStyle:"content",collapsible:!0,animate:200,active:!1,activate:function(e,t){if(t.newPanel&&t.newPanel[0]){var i,s=t.newHeader[0],o=t.newPanel[0],n=a("input.widget-filter",o),r=n.outerHeight(!0);a("span.ui-icon-search",s).length?i=t.newPanel.data("refreshPanel"):(i=function(){o.scrollHeight>o.clientHeight||""!=n.val()||a(s).hasClass("nested-tab")?(a(o).scrollTop(r),n.show(),a("span.ui-icon-search",s).removeClass("unused")):(n.hide(),a("span.ui-icon-search",s).addClass("unused"))},t.newPanel.data("refreshPanel",i),t.newHeader.data("refreshPanel",i),t.newHeader.append(a('<span class="ui-icon ui-icon-search"></span>').on("click",(function(e){t.newPanel.animate({scrollTop:t.newPanel.scrollTop()>0?0:r},300,(function(){t.newPanel.scrollTop()>0?a("input.widget-filter",o).blur():a("input.widget-filter",o).focus()})),e.stopPropagation(),e.preventDefault()})))),n.val(""),i()}}}),a(document).on("click","ul.tag-group",(function(e){a(this).toggleClass("folded"),a(this).parents(".widget-root").data("refreshPanel").call()})),a(document).on("keyup","#accordion input.widget-filter",(function(e){var t,i=a(this).val().toLowerCase(),s=a(this).parents("div.widget-root")[0];27==(e.keyCode||e.which)&&a(this).val(i=""),""==i?a("li,ul",s).show():a("li>a",s).each((function(){var e=a(this).closest("ul.tag-group"),s=a(this).parent();t=e.data("hidden")||0,s.hasClass("category")||(this.title.toLowerCase().indexOf(i)>=0||this.innerText.toLowerCase().indexOf(i)>=0?s.show():(s.hide(),++t)),e.length&&t&&e.data("hidden",t)})),a("ul.tag-group",s).each((function(){var e=a(this);t=parseInt(e.data("hidden"))||0,e.children().length>t+1?e.show().removeClass("folded"):e.hide().addClass("folded"),e.data("hidden",null)}))}));var e,t=a("#result-tabs"),i=this;t.tabs({}),a("#accordion-resizer").resizable({minWidth:150,maxWidth:450,grid:[10,10],handles:"e",start:function(a,i){e={width:t.width(),height:t.height()}},resize:function(s,o){i.accordion.accordion("refresh"),a("#query-sticky-wrapper").width(i.accordion.width()),a(this).width((function(e,t){return t-7})),t.width(e.width+o.originalSize.width-o.size.width)}}),a(".query-left#query").sticky({topSpacing:this.topSpacing,widthFromWrapper:!1})},initComm:function(){var s,n,r=t(e.Eventing,e.Spying,e.Pivoting,i.Pivoter,i.Ranger),d=t(e.Eventing,e.Faceting,i.AccordionExpander,i.Tagger,i.Switcher);this.manager=s=new(t(CommBase.Communicating,e.Configuring,e.QueryingJson,e.NestedAdapter))(this),s.addListeners(new i.widget.SolrResult(a.extend(!0,{id:"result",target:a("#docs"),itemId:"s_uuid",nestLevel:"composition",onClick:function(e,t,s,o){if(n.findItem(t.s_uuid)<0){n.addItem(t);var r="",d=a('a[href="#basket_tab"]');d.html(i.updateCounter(d.html(),n.length)),n.enumerateItems((function(e){r+=e.s_uuid+";"})),(r=i.modifyURL(window.location.href,"basket",r))&&window.history.pushState({query:window.location.search},document.title,r),a("footer",this).toggleClass("add none")}},onCreated:function(e){a("footer",this).addClass("add")}},this))),s.addListeners(new i.widget.SolrPaging({id:"pager",target:a("#pager"),prevLabel:"&lt;",nextLabel:"&gt;",innerWindow:1,renderHeader:function(e,t,i){a("#pager-header").html("<span>displaying "+Math.min(i,t+1)+" to "+Math.min(i,t+e)+" of "+i+"</span>")}}));for(var l=0,c=this.facets.length;l<c;++l){var u=this.facets[l],p=o[u.id];(f=new d(a.extend({target:this.accordion,expansionTemplate:"#tab-topcategory",subtarget:"ul",runMethod:toggleAggregate,multivalue:this.multipleSelection,aggregate:p===undefined||p.aggregate===undefined?this.aggregateFacets:p.aggregate,exclusion:this.multipleSelection||this.keepAllFacets,useJson:!0,renderItem:tagRender,onUpdated:tagsUpdated,nesting:"type_s:substance",domain:{type:"parent",which:"type_s:substance"},classes:u.color},u))).init=tagInit,f.afterResponse=function(e){this.populate(this.getFacetCounts(e.facets))},a(f.target).closest("div.widget-content").find("input.switcher").val(f.aggregate?"OR":"AND"),s.addListeners(f)}for(var h in s.addListeners(new r({id:"studies",target:this.accordion,subtarget:"ul",expansionTemplate:"#tab-topcategory",before:"#cell_header",field:"loValue_d",lookupMap:this.lookupMap,pivot:this.pivot,statistics:{min:"min(loValue_d)",max:"max(loValue_d)",avg:"avg(loValue_d)"},slidersTarget:a("#sliders"),multivalue:this.multipleSelection,aggregate:this.aggregateFacets,exclusion:this.multipleSelection||this.keepAllFacets,useJson:!0,renderTag:tagRender,classes:"dynamic-tab",nesting:"type_s:substance",domain:{type:"parent",which:"type_s:substance"}})),s.addListeners(new i.SolrQueryReporter({id:"current",target:a("#selection"),renderItem:tagRender,useJson:!0})),this.basket=n=new(t(i.Populating,i.SolrItemLister))(a.extend(!0,{id:"basket",target:a("#basket-docs"),summaryRenderers:this.summaryRenderers,itemId:"s_uuid",onClick:function(e,t){if(!1!==n.eraseItem(t.s_uuid)){a(this).remove();var s="",o=a('a[href="#basket_tab"]'),r=a("#result_"+t.s_uuid);o.html(i.updateCounter(o.html(),n.length)),n.enumerateItems((function(e){s+=e.s_uuid+";"})),(s=i.modifyURL(window.location.href,"basket",s))&&window.history.pushState({query:window.location.search},document.title,s),r.length>0&&a("footer",r[0]).toggleClass("add none")}else console.log("Trying to remove from basket an inexistent entry: "+JSON.stringify(t))},onCreated:function(e){a("footer",this).addClass("remove")}},this)),t.act(this,this.onPreInit,s),s.init(),o){var m=o[h].values,f=s.getListener(h);_.each(m,(function(e){f.addValue(e)}))}s.doRequest()},updateButton:function(e){return b=a("button",e),a(e).find("input[name=export_dataset]").val()?this.manager.getParameter("json.filter").length||"filtered"!=e.export_dataset.value?a(e).find("input[name=export_dataset]").val()&&b.button("enable").button("option","label","Download "+a("#export_dataset :radio:checked + label").text().toLowerCase()+" as "+a(e.export_format).data("name").toUpperCase()):b.button("disable").button("option","label","No filters selected..."):b.button("option","label","No target dataset selected..."),b},initExport:function(){var t=this;this.prepareFormats(),this.prepareTypes(),a("#export_dataset").buttonset(),a("#export_type").buttonset(),a("#export_dataset input").on("change",(function(e){t.updateButton(this.form)})),a("#export_tab button").button({disabled:!0}),a("#export_tab form").on("submit",(function(i){var s=this,o=(o=s.export_format.value).substr(o.indexOf("/")+1),n=t.exportFormats[a(".data_formats .selected").data("index")],r=t.exportTypes[a(s).find("input[name=export_type]:checked").data("index")],d=r.server||n.server,l=t.manager.getParameter("json.filter"),c=[],u=[],p=null,makeParameter=function(e,a){var i={value:e.value,name:a||e.name};if(e.domain&&"parent"==e.domain.type)if(r.exportLevel){var s=t.exportLevels[r.exportLevel];e.value&&!e.value.match(s.fieldsRegExp)||(i.domain=s.domain)}else i.domain=e.domain;return i},prepareFilters=function(){for(var a=0,i=l.length;a<i;a++){var s=l[a];c.push(e.stringifyParameter(makeParameter(s,"fq"))),u.push(e.stringifyValue(s).replace(/"|\\/g,"\\$&"))}c.push(e.stringifyParameter(makeParameter(t.manager.getParameter("q")))||"*:*")};return"filtered"!=s.export_dataset.value&&(p=[],t.basket.enumerateItems((function(e){p.push(e.s_uuid)}))),"ambitUrl"==d?p?(s.search.value=p.join(" "),s.action=t.ambitUrl+"query/substance/study/uuid?media="+encodeURIComponent(s.export_format.value)):(prepareFilters(),c.push("wt=json","fl=s_uuid_hs"),a.ajax({url:t.serverUrl+"select?"+c.join("&"),async:!1,dataType:"json",success:function(e){var i=[];a.each(e.response.docs,(function(e,t){i.push(t.s_uuid_hs)})),s.search.value=i.join(" "),s.action=t.ambitUrl+"query/substance/study/uuid?media="+encodeURIComponent(s.export_format.value)}})):(prepareFilters(),p&&c.push("fq="+encodeURIComponent(("study"==r.exportLevel?"s_uuid_s":"s_uuid_hs")+":("+p.join(" ")+")")),Array.prototype.push.apply(c,t.exportSolrDefaults),r.extraParams&&Array.prototype.push.apply(c,r.extraParams),c.push("fl="+encodeURIComponent(r.fields.replace("{{filter}}",u.length>1?"("+u.join(" AND ")+")":u.length>0?u[0]:r.defaultFilter))),c.push("rows="+t.exportMaxRows),"tsv"==o?c.push("wt=json","json2tsv=true"):c.push("wt="+o),s.action=t[d]+"select?"+c.join("&")),!0})),a("#result-tabs").tabs({activate:function(e,i){if("export_tab"==i.newPanel[0].id){t.basket.length&&a("input#selected_data").prop("checked",!0),a("button",i.newPanel[0]).button("disable").button("option","label","No output format selected...");var s=t.manager.getParameter("json.filter").length>0;a("#selected_data")[0].disabled=t.basket.length<1,a("#filtered_data")[0].disabled=!s,t.basket.length?(a(".data_formats").removeClass("disabled"),a("#export_type").buttonset("enable"),a(".warning-message").hide(),a("#selected_data")[0].checked=!0):(a("#filtered_data")[0].checked=s,s||t.manager.getParameter("q").value.length>0?(a(".data_formats").removeClass("disabled"),a("#export_type").buttonset("enable"),a(".warning-message").hide()):(a(".data_formats").addClass("disabled"),a("#export_type").buttonset("disable"),a(".warning-message").show())),a(".data_formats .jtox-ds-download a").first().trigger("click"),a("#export_dataset").buttonset("refresh")}}})},prepareFormats:function(){var e=a("#export_tab div.data_formats");self=this;for(var t=0,s=this.exportFormats.length;t<s;++t){var o=i.fillTemplate("#export-format",this.exportFormats[t]);o.data("index",t),e.append(o),a("a",e[0]).on("click",(function(e){var t=a(this),i=t.closest("form")[0];if(!t.hasClass("disabled")&&!t.hasClass("selected")){var s=t.closest("div.data_formats");i.export_format.value=t.data("mime"),a(i.export_format).data("name",t.data("name")),self.updateButton(i),a("div",s[0]).removeClass("selected"),s.addClass("selected"),t.closest(".jtox-fadable").addClass("selected")}return!1}))}},prepareTypes:function(){for(var e=a("#export_tab div#export_type"),t=this,s=0,o=this.exportTypes.length;s<o;++s){this.exportTypes[s].selected=0==s?'checked="checked"':"";var n=i.fillTemplate("#export-type",this.exportTypes[s]);n.data("index",s),e.append(n),a("input[name=export_type]").on("change",(function(e){var i=a(this);return a(".data_formats a").addClass("disabled"),t.exportTypes[i.data("index")].formats.split(",").forEach((function(e){a(".data_formats a[data-name="+e+"]").removeClass("disabled")})),a(".data_formats a:visible").not(".disabled").first().trigger("click"),!1}))}}})}(Solr,asSys||a$,jQuery||$,jToxKit||jT),jToxKit.templates["faceted-search-kit"]='<div class="query-container">\x3c!-- left --\x3e<div id="query" class="query-left"><div id="accordion-resizer" class="ui-widget-content"><div id="accordion"></div></div></div>\x3c!-- right --\x3e<div id="result-tabs" class="query-right"><ul><li><a href="#hits_tab">Hits list</a></li><li><a href="#basket_tab">Selection</a></li><li class="jtox-ds-export"><a href="#export_tab">Export</a></li></ul><div id="hits_tab"><div class="row remove-bottom"><ul class="tags remove-bottom" id="selection"></ul><footer><div id="sliders-controls"><a href="#" class="jtox-fadable command close">Close</a></div><div id="sliders"></div></footer></div><div id="navigation"><ul id="pager"></ul><div id="pager-header"></div></div><div class="docs_wrapper"><section id="docs" class="item-list"></section></div></div><div id="basket_tab"><section id="basket-docs" class="item-list"></section><div style="padding-top: 70px;"></div></div><div id="export_tab"><form target="_blank" method="post"><input type="hidden" name="search"/><h6>Select dataset to export</h6><div id="export_dataset"><input type="radio" value="filtered" name="export_dataset" id="filtered_data" checked="checked"/><label for="filtered_data">Filtered entries</label><input type="radio" value="selected" name="export_dataset" id="selected_data"/><label for="selected_data">Selected entries</label></div><h6>Select export type</h6><div id="export_type"></div><h6>Select output format</h6><input type="hidden" name="export_format" id="export_format"/><div class="data_formats"></div><br/><button type="submit" name="export_go" data-prefix="Download">?</button><div class="ui-state-error ui-corner-all warning-message" style="padding: 0 .7em;"><p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span><strong>Warning:</strong>Please either add entries to the selection or specify a query</p></div></form></div></div>\x3c!-- query container --\x3e</div>',jToxKit.templates["faceted-search-templates"]='<section id="result-item"><article id="{{item_id}}" class="item"><header>{{title}}<a href="{{href}}" title="{{href_title}}" target="{{href_target}}"><span class="ui-icon ui-icon-extlink" style="float:right;margin:0;"></span></a></header><a href="{{link}}" title="{{link}}" class="avatar" target="_blank"><img jt-src="{{logo}}"/></a><div class="composition">{{composition}}</div>{{summary}}<footer class="links">{{footer}}<a href="#" class="add jtox-fadable command">Add to Selection</a><a href="#" class="remove jtox-fadable command">Remove from Selection</a><a href="#" class="none jtox-fadable command">Already added</a></footer></article></section><div id="summary-item"><div class="one-summary"><span class="topic">{{topic}}:</span><span class="value">{{content}}</span></div></div><div id="tag-facet"><ul class="tags tag-group folded"></ul></div><div id="tab-topcategory"><h3 id="{{id}}_header" class="nested-tab">{{title}}</h3><div id="{{id}}" class="widget-content widget-root"><div><input type="text" placeholder="Filter_" class="widget-filter"/><input type="button" class="switcher" value="OR"/></div><ul class="widget-content tags remove-bottom" data-color="{{color}}"></ul></div></div><div id="slider-one"><input type="hidden"/></div><div id="export-type"><input type="radio" value="{{fields}}" {{selected}} name="export_type" id="{{name}}"/><label for="{{name}}">{{name}}</label></div><div id="export-format"><div class="jtox-inline jtox-ds-download jtox-fadable"><a target="_blank" data-name="{{name}}" data-mime="{{mime}}" href="#"><img class="borderless" jt-src="{{icon}}"/></a></div></div>';