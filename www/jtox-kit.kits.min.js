!function(t,e,i,a){CurrentSearchWidgeting=function(t){e.extend(!0,this,e.common(t,this)),this.target=t.target,this.id=t.id,this.manager=null,this.facetWidgets={},this.fqName=this.useJson?"json.filter":"fq"},CurrentSearchWidgeting.prototype={useJson:!1,renderItem:null,init:function(t){e.pass(this,CurrentSearchWidgeting,"init",t),this.manager=t},registerWidget:function(t,e){this.facetWidgets[t.id]=e},afterTranslation:function(t){var e=this,i=[],a=this.manager.getParameter("q"),s=this.manager.getAllValues(this.fqName);a.value&&!a.value.match(/^(\*:)?\*$/)&&i.push(e.renderItem({title:a.value,count:"x",onMain:function(){return a.value="",e.manager.doRequest(),!1}}).addClass("tag_fixed"));for(var n=0,r=null!=s?s.length:0;n<r;n++){var o=s[n],l=null;for(var d in e.facetWidgets){var u=e.manager.getListener(d);if(l=u.fqParse(o))break}if(null!=l){Array.isArray(l)||(l=[l]);for(var c=0,h=l.length;c<h;++c){var g,p=l[c],f="function"==typeof u.prepareTag?u.prepareTag(p):{title:p,count:"x",color:u.color,onMain:u.unclickHandler(p)};i.push(g=e.renderItem(f).addClass("tag_selected "+(f.onAux?"tag_open":"tag_fixed"))),1<h&&g.addClass("tag_combined")}1<h&&g.addClass("tag_last")}}i.length?(i.push(e.renderItem({title:"Clear",onMain:function(){for(var t in a.value="",e.facetWidgets)e.manager.getListener(t).clearValues();return e.manager.doRequest(),!1}}).addClass("tag_selected tag_clear tag_fixed")),this.target.empty().addClass("tags").append(i)):this.target.removeClass("tags").html("<li>No filters selected!</li>")}},a.CurrentSearchWidget=e(CurrentSearchWidgeting)}(Solr,asSys,jQuery,jToxKit),function(g,c,p,h){var n={},f={},i={servlet:"autophrase",multipleSelection:!0,keepAllFacets:!0,connector:p,onPrepare:function(t){var e=t.url.indexOf("?");this.proxyUrl?(t.data={query:t.url.substr(e+1)},t.url=this.proxyUrl,t.type=t.method="POST"):t.url+=(e<0?"?":"&")+"wt=json"},topSpacing:10,nestingField:"type_s",nestingRules:{composition:{parent:"substance",limit:100},study:{parent:"substance",limit:1e4},params:{parent:"study",limit:1e4},conditions:{parent:"study",limit:1e4}},exportMaxRows:999999,exportTypes:[],exportLevels:{},exportSolrDefaults:["facet=false","echoParams=none"],listingFields:[],facets:[],summaryRenderers:{}},e=null,r=function(){null!=e&&clearTimeout(e),e=setTimeout(function(){var t=h.ui.modifyURL(window.location.href,"ui",encodeURIComponent(JSON.stringify(f)));t&&window.history.pushState({query:window.location.search},document.title,t),e=null},1e3)},m=function(t){var e,i=e=t.title.replace(/^\"(.+)\"$/,"$1");i=e.replace(/^caNanoLab\./,"").replace(/^http\:\/\/dx\.doi\.org/,""),i=(n[i]||i).replace("NPO_","").replace(" nanoparticle","");var a=p("<span/>").html(t.count||0);"function"==typeof t.onAux&&a.click(t.onAux);var s=p("<li/>").append(p('<a href="#" class="tag" title="'+e+" "+(t.hint||"")+(i!=e?" ["+e+"]":"")+'">'+i+"</a>").append(a));return"function"==typeof t.onMain&&s.click(t.onMain),t.color&&s.addClass(t.color),s},v=function(t){h.TagWidget.prototype.init.call(this,t),t.getListener("current").registerWidget(this)},x=function(t){var e=this.getHeaderText();e.textContent=h.ui.updateCounter(e.textContent,t),c.act(this,this.header.data("refreshPanel"));var i=f[this.id]||{};i.values=this.getValues(),f[this.id]=i,r()},y=function(t){var e="OR"==t.value.toUpperCase(),i=this.getValues();this.clearValues(),this.aggregate=!e,t.value=e?"AND":"OR";for(var a=0;a<i.length;++a)this.addValue(i[a]);this.doRequest();var s=f[this.id]||{};s.aggregate=!e,f[this.id]=s,r()};h.ui.FacetedSearch=function(t){this.id=null,c.extend(!0,this,i,t),this.serverUrl=this.solrUrl,"string"==typeof this.lookupMap&&(this.lookupMap=window[this.lookupMap]),null==this.lookupMap&&(this.lookupMap={}),n=this.lookupMap,p(t.target).html(h.ui.templates["faceted-search-kit"]),delete this.target;var e=h.ui.parseURL(window.location.href).params.ui;null!=e&&(f=JSON.parse(decodeURIComponent(e))),this.initDom(),this.initComm(),this.initExport()},h.ui.FacetedSearch.prototype={initDom:function(){this.accordion=p("#accordion"),this.accordion.accordion({heightStyle:"content",collapsible:!0,animate:200,active:!1,activate:function(t,e){if(e.newPanel&&e.newPanel[0]){var i,a=e.newHeader[0],s=e.newPanel[0],n=p("input.widget-filter",s),r=n.outerHeight(!0);p("span.ui-icon-search",a).length?i=e.newPanel.data("refreshPanel"):(i=function(){s.scrollHeight>s.clientHeight||""!=n.val()||p(a).hasClass("nested-tab")?(p(s).scrollTop(r),n.show(),p("span.ui-icon-search",a).removeClass("unused")):(n.hide(),p("span.ui-icon-search",a).addClass("unused"))},e.newPanel.data("refreshPanel",i),e.newHeader.data("refreshPanel",i),e.newHeader.append(p('<span class="ui-icon ui-icon-search"></span>').on("click",function(t){e.newPanel.animate({scrollTop:0<e.newPanel.scrollTop()?0:r},300,function(){0<e.newPanel.scrollTop()?p("input.widget-filter",s).blur():p("input.widget-filter",s).focus()}),t.stopPropagation(),t.preventDefault()}))),n.val(""),i()}}}),p(document).on("click","ul.tag-group",function(t){p(this).toggleClass("folded"),p(this).parents(".widget-root").data("refreshPanel").call()}),p(document).on("keyup","#accordion input.widget-filter",function(t){var i,a=p(this).val().toLowerCase(),e=p(this).parents("div.widget-root")[0];27==(t.keyCode||t.which)&&p(this).val(a=""),""==a?p("li,ul",e).show():p("li>a",e).each(function(){var t=p(this).closest("ul.tag-group"),e=p(this).parent();i=t.data("hidden")||0,e.hasClass("category")||(0<=this.title.toLowerCase().indexOf(a)||0<=this.innerText.toLowerCase().indexOf(a)?e.show():(e.hide(),++i)),t.length&&i&&t.data("hidden",i)}),p("ul.tag-group",e).each(function(){var t=p(this);i=parseInt(t.data("hidden"))||0,t.children().length>i+1?t.show().removeClass("folded"):t.hide().addClass("folded"),t.data("hidden",null)})});var i,a=p("#result-tabs"),s=this;a.tabs({}),p("#accordion-resizer").resizable({minWidth:150,maxWidth:450,grid:[10,10],handles:"e",start:function(t,e){i={width:a.width(),height:a.height()}},resize:function(t,e){s.accordion.accordion("refresh"),p("#query-sticky-wrapper").width(s.accordion.width()),p(this).width(function(t,e){return e-7}),a.width(i.width+e.originalSize.width-e.size.width)}}),p(".query-left#query").sticky({topSpacing:this.topSpacing,widthFromWrapper:!1})},initComm:function(){var t,r,e=c(g.Requesting,g.Spying,g.Pivoting,h.PivotWidgeting,h.RangeWidgeting),i=c(g.Requesting,g.Faceting,h.AccordionExpansion,h.TagWidget,h.Running);this.manager=t=new(c(g.Management,g.Configuring,g.QueryingJson,h.Translation,h.NestedSolrTranslation))(this),t.addListeners(new h.ResultWidget(p.extend(!0,{id:"result",target:p("#docs"),itemId:"s_uuid",nestLevel:"composition",onClick:function(t,e,i,a){if(r.findItem(e.s_uuid)<0){r.addItem(e);var s="",n=p('a[href="#basket_tab"]');n.html(h.ui.updateCounter(n.html(),r.length)),r.enumerateItems(function(t){s+=t.s_uuid+";"}),(s=h.ui.modifyURL(window.location.href,"basket",s))&&window.history.pushState({query:window.location.search},document.title,s),p("footer",this).toggleClass("add none")}},onCreated:function(t){p("footer",this).addClass("add")}},this))),t.addListeners(new(c(g.Widgets.Pager))({id:"pager",target:p("#pager"),prevLabel:"&lt;",nextLabel:"&gt;",innerWindow:1,renderHeader:function(t,e,i){p("#pager-header").html("<span>displaying "+Math.min(i,e+1)+" to "+Math.min(i,e+t)+" of "+i+"</span>")}}));for(var a=0,s=this.facets.length;a<s;++a){var n=this.facets[a],o=f[n.id];(u=new i(p.extend({target:this.accordion,expansionTemplate:"#tab-topcategory",subtarget:"ul",runMethod:y,multivalue:this.multipleSelection,aggregate:o===undefined||o.aggregate===undefined?this.aggregateFacets:o.aggregate,exclusion:this.multipleSelection||this.keepAllFacets,useJson:!0,renderItem:m,init:v,onUpdated:x,nesting:"type_s:substance",domain:{type:"parent",which:"type_s:substance"},classes:n.color},n))).afterTranslation=function(t){this.populate(this.getFacetCounts(t.facets))},p(u.target).closest("div.widget-content").find("input.switcher").val(u.aggregate?"OR":"AND"),t.addListeners(u)}for(var l in t.addListeners(new e({id:"studies",target:this.accordion,subtarget:"ul",expansionTemplate:"#tab-topcategory",before:"#cell_header",field:"loValue_d",lookupMap:this.lookupMap,pivot:this.pivot,statistics:{min:"min(loValue_d)",max:"max(loValue_d)",avg:"avg(loValue_d)"},slidersTarget:p("#sliders"),multivalue:this.multipleSelection,aggregate:this.aggregateFacets,exclusion:this.multipleSelection||this.keepAllFacets,useJson:!0,renderTag:m,classes:"dynamic-tab",nesting:"type_s:substance",domain:{type:"parent",which:"type_s:substance"}})),t.addListeners(new h.CurrentSearchWidget({id:"current",target:p("#selection"),renderItem:m,useJson:!0})),this.basket=r=new(c(h.ListWidget,h.ItemListWidget))(p.extend(!0,{id:"basket",target:p("#basket-docs"),summaryRenderers:this.summaryRenderers,itemId:"s_uuid",onClick:function(t,e){if(!1!==r.eraseItem(e.s_uuid)){p(this).remove();var i="",a=p('a[href="#basket_tab"]'),s=p("#result_"+e.s_uuid);a.html(h.ui.updateCounter(a.html(),r.length)),r.enumerateItems(function(t){i+=t.s_uuid+";"}),(i=h.ui.modifyURL(window.location.href,"basket",i))&&window.history.pushState({query:window.location.search},document.title,i),0<s.length&&p("footer",s[0]).toggleClass("add none")}else console.log("Trying to remove from basket an inexistent entry: "+JSON.stringify(e))},onCreated:function(t){p("footer",this).addClass("remove")}},this)),c.act(this,this.onPreInit,t),t.init(),f){var d=f[l].values,u=t.getListener(l);c.each(d,function(t){u.addValue(t)})}t.doRequest()},updateButton:function(t){return b=p("button",t),p(t).find("input[name=export_dataset]").val()?this.manager.getParameter("json.filter").length||"filtered"!=t.export_dataset.value?p(t).find("input[name=export_dataset]").val()&&b.button("enable").button("option","label","Download "+p("#export_dataset :radio:checked + label").text().toLowerCase()+" as "+p(t.export_format).data("name").toUpperCase()):b.button("disable").button("option","label","No filters selected..."):b.button("option","label","No target dataset selected..."),b},initExport:function(){var h=this;this.prepareFormats(),this.prepareTypes(),p("#export_dataset").buttonset(),p("#export_type").buttonset(),p("#export_dataset input").on("change",function(t){h.updateButton(this.form)}),p("#export_tab button").button({disabled:!0}),p("#export_tab form").on("submit",function(t){var e=this,i=(i=e.export_format.value).substr(i.indexOf("/")+1),a=h.exportFormats[p(".data_formats .selected").data("index")],s=h.exportTypes[p(e).find("input[name=export_type]:checked").data("index")],n=s.server||a.server,r=h.manager.getParameter("json.filter"),o=[],l=[],d=null,u=function(t,e){var i={value:t.value,name:e||t.name};if(t.domain&&"parent"==t.domain.type)if(s.exportLevel){var a=h.exportLevels[s.exportLevel];t.value&&!t.value.match(a.fieldsRegExp)||(i.domain=a.domain)}else i.domain=t.domain;return i},c=function(){for(var t=0,e=r.length;t<e;t++){var i=r[t];o.push(g.stringifyParameter(u(i,"fq"))),l.push(g.stringifyValue(i).replace(/"|\\/g,"\\$&"))}o.push(g.stringifyParameter(u(h.manager.getParameter("q")))||"*:*")};return"filtered"!=e.export_dataset.value&&(d=[],h.basket.enumerateItems(function(t){d.push(t.s_uuid)})),"ambitUrl"==n?d?(e.search.value=d.join(" "),e.action=h.ambitUrl+"query/substance/study/uuid?media="+encodeURIComponent(e.export_format.value)):(c(),o.push("wt=json","fl=s_uuid_hs"),p.ajax({url:h.serverUrl+"select?"+o.join("&"),async:!1,dataType:"json",success:function(t){var i=[];p.each(t.response.docs,function(t,e){i.push(e.s_uuid_hs)}),e.search.value=i.join(" "),e.action=h.ambitUrl+"query/substance/study/uuid?media="+encodeURIComponent(e.export_format.value)}})):(c(),d&&o.push("fq="+encodeURIComponent(("study"==s.exportLevel?"s_uuid_s":"s_uuid_hs")+":("+d.join(" ")+")")),Array.prototype.push.apply(o,h.exportSolrDefaults),s.extraParams&&Array.prototype.push.apply(o,s.extraParams),o.push("fl="+encodeURIComponent(s.fields.replace("{{filter}}",1<l.length?"("+l.join(" AND ")+")":0<l.length?l[0]:s.defaultFilter))),o.push("rows="+h.exportMaxRows),"tsv"==i?o.push("wt=json","json2tsv=true"):o.push("wt="+i),e.action=h[n]+"select?"+o.join("&")),!0}),p("#result-tabs").tabs({activate:function(t,e){if("export_tab"==e.newPanel[0].id){h.basket.length&&p("input#selected_data").prop("checked",!0),p("button",e.newPanel[0]).button("disable").button("option","label","No output format selected...");var i=0<h.manager.getParameter("json.filter").length;p("#selected_data")[0].disabled=h.basket.length<1,p("#filtered_data")[0].disabled=!i,h.basket.length?(p(".data_formats").removeClass("disabled"),p("#export_type").buttonset("enable"),p(".warning-message").hide(),p("#selected_data")[0].checked=!0):(p("#filtered_data")[0].checked=i)||0<h.manager.getParameter("q").value.length?(p(".data_formats").removeClass("disabled"),p("#export_type").buttonset("enable"),p(".warning-message").hide()):(p(".data_formats").addClass("disabled"),p("#export_type").buttonset("disable"),p(".warning-message").show()),p(".data_formats .jtox-ds-download a").first().trigger("click"),p("#export_dataset").buttonset("refresh")}}})},prepareFormats:function(){for(var t=p("#export_tab div.data_formats"),e=0,i=(self=this).exportFormats.length;e<i;++e){var a=h.ui.fillTemplate("#export-format",this.exportFormats[e]);a.data("index",e),t.append(a),p("a",t[0]).on("click",function(t){var e=p(this),i=e.closest("form")[0];if(!e.hasClass("disabled")&&!e.hasClass("selected")){var a=e.closest("div.data_formats");i.export_format.value=e.data("mime"),p(i.export_format).data("name",e.data("name")),self.updateButton(i),p("div",a[0]).removeClass("selected"),a.addClass("selected"),e.closest(".jtox-fadable").addClass("selected")}return!1})}},prepareTypes:function(){for(var t=p("#export_tab div#export_type"),i=this,e=0,a=this.exportTypes.length;e<a;++e){this.exportTypes[e].selected=0==e?'checked="checked"':"";var s=h.ui.fillTemplate("#export-type",this.exportTypes[e]);s.data("index",e),t.append(s),p("input[name=export_type]").on("change",function(t){var e=p(this);return p(".data_formats a").addClass("disabled"),i.exportTypes[e.data("index")].formats.split(",").forEach(function(t){p(".data_formats a[data-name="+t+"]").removeClass("disabled")}),p(".data_formats a:visible").not(".disabled").first().trigger("click"),!1})}}}}(Solr,asSys,jQuery,jToxKit),function(s,n,r){r.ui.Logging=function(t){var e=n(t.target);if(s.extend(!0,this,s.common(t,this)),this.target=t.target,e.html(r.ui.templates["logger-main"]),e.addClass("jtox-toolkit jtox-log"),"number"==typeof this.lineHeight&&(this.lineHeight=this.lineHeight.toString()+"px"),"number"!=typeof this.keepMessages&&(this.keepMessages=parseInt(this.keepMessages)),this.listRoot=n(".list-root",this.target)[0],this.statusEl=n(".status",this.target)[0],this.rightSide?(this.statusEl.style.right="0px",e.addClass("right-side")):this.statusEl.style.left="0px",this.setStatus(""),this.events={},this.autoHide&&(e.bind("click",function(t){n(this).toggleClass("hidden")}),e.bind("mouseleave",function(t){n(this).addClass("hidden")})),this.mountDestination){var i="object"==typeof this.mountDestination?this.mountDestination:s.path(window,this.mountDestination),a=this;i.onPrepare=function(t){return a.beforeRequest(t)},i.onSuccess=function(t,e,i){return a.afterRequest(t,i,e)},i.onError=function(t,e){return a.afterFailure(t,e)}}},r.ui.Logging.prototype={mountDestination:null,statusDelay:1500,keepMessages:50,lineHeight:"20px",rightSide:!1,hasDetails:!0,autoHide:!0,formatEvent:function(t,e){return null!=e?{details:e.status+" "+e.statusText+"<br/>"+e.getAllResponseHeaders()}:null!=t?{header:t.method.toUpperCase()+": "+t.service,details:"..."}:null},setIcon:function(t,e){"error"==e?t.addClass("ui-state-error"):t.removeClass("ui-state-error"),t.data("status",e),"error"==e?n(".icon",t).addClass("ui-icon ui-icon-alert").removeClass("loading ui-icon-check"):"success"==e?n(".icon",t).addClass("ui-icon ui-icon-check").removeClass("loading ui-icon-alert"):(n(".icon",t).removeClass("ui-icon ui-icon-check ui-icon-alert"),"connecting"==e&&n(".icon",t).addClass("loading"))},setStatus:function(t){var e=this;n(".icon",e.statusEl).removeClass("jt-faded"),e.setIcon(n(e.statusEl),t),"error"!=t&&"success"!=t||setTimeout(function(){n(".icon",e.statusEl).addClass("jt-faded");var t=!1;n(".logline",e.listRoot).each(function(){"connecting"==n(e).data("status")&&(t=!0)}),t&&e.setStatus("connecting")},e.statusDelay)},addLine:function(t){var i=this,a=r.ui.fillTemplate("#jtox-logline",t);for(a.height("0px"),this.listRoot.insertBefore(a[0],this.listRoot.firstElementChild),setTimeout(function(){a.height(i.lineHeight)},150),i.hasDetails&&n(".icon",a[0]).on("click",function(t){if(a.toggleClass("openned"),a.hasClass("openned")){var e=0;n(".data-field",a[0]).each(function(){e+=this.offsetHeight}),a.height(e+6)}else a.height(i.lineHeight);t.stopPropagation()});this.listRoot.childNodes.length>i.keepMessages;)this.listRoot.removeChild(this.listRoot.lastElementChild);return a},beforeRequest:function(t){var e=r.ui.parseURL(t.url),i=(t.service=e.protocol+"://"+e.host+e.path,this.formatEvent(t)),a=this.addLine(i);this.setStatus("connecting"),this.events[t.logId=Date.now()]=a,this.setIcon(a,"connecting"),a.data("status","connecting")},afterRequest:function(t,e,i){var a=this.formatEvent(e,i),s=this.events[e.logId];this.setStatus("success"),s?(delete this.events[e.logId],this.setIcon(s,"success"),r.ui.fillTree(s[0],a)):console.log("jToxLog: missing line for:"+e.service)},afterFailure:function(t,e){var i=this.formatEvent(e,t),a=this.events[e.logId];this.setStatus("error"),a?(delete this.events[e.logId],this.setIcon(a,"error"),r.ui.fillTree(a[0],i),console&&console.log("Error ["+e.service+"]: "+t.statusText)):console.log("jToxLog: missing line for:"+e.service+"("+t.statusText+")")}}}(asSys,jQuery,jToxKit),function(t,r,h,g){function buildValueRange(t,e){var i=" = ";return i+=null==t.min?"-&#x221E;":t.min,t.avg&&(i+="&#x2026;"+t.avg),i+="&#x2026;"+(null==t.max?"&#x221E;":t.max),e&&(i+=" "+g.ui.formatUnits(t.val).replace(/<sup>(2|3)<\/sup>/g,"&#x00B$1;").replace(/<sup>(\d)<\/sup>/g,"^$1")),i}function InnerTagWidgeting(t){this.id=t.id,this.pivotWidget=t.pivotWidget}var p=/\W/g;InnerTagWidgeting.prototype={pivotWidget:null,hasValue:function(t){return this.pivotWidget.hasValue(this.id+":"+t)},clickHandler:function(t){return this.pivotWidget.clickHandler(this.id+":"+t)},modifyTag:function(t){return t.hint=t.unit?"\n"+t.unit.buckets.map(function(t){return buildValueRange(t,!0)}).join("\n"):t.buildValueRange(t),t.color=this.color,t}};var f=r(g.TagWidget,InnerTagWidgeting);g.PivotWidgeting=function(t){r.extend(!0,this,r.common(t,this)),this.target=t.target,this.targets={},this.lastEnabled=0,this.initialPivotCounts=null},g.PivotWidgeting.prototype={__expects:["getFaceterEntry","getPivotEntry","getPivotCounts","auxHandler"],automatic:!1,renderTag:null,multivalue:!1,aggregate:!1,exclusion:!1,init:function(t){r.pass(this,g.PivotWidgeting,"init",t),this.manager=t,this.manager.getListener("current").registerWidget(this,!0)},addFaceter:function(t,e){var i=r.pass(this,g.PivotWidgeting,"addFaceter",t,e);return"object"==typeof t&&(i.color=t.color),e>this.lastEnabled&&!t.disabled&&(this.lastEnabled=e),i},afterTranslation:function(t){var e=this.getPivotCounts(t.facets);for(r.pass(this,g.PivotWidgeting,"afterTranslation",t),i=0;i<e.length;++i){var a=e[i],s=a.val.replace(p,"_"),n=this.targets[s];n?n.target.children("ul").hide():(this.targets[s]=n=new g.AccordionExpansion(h.extend(!0,{},this.settings,this.getFaceterEntry(0),{id:s,title:a.val})),n.updateHandler=this.updateHandler(n),n.target.children().last().remove()),this.traversePivot(n.target,a,1),n.updateHandler(a.count)}this.target.accordion("refresh")},updateHandler:function(t){var e=t.getHeaderText();return function(t){e.textContent=g.ui.updateCounter(e.textContent,t)}},prepareTag:function(t){var e=this.parseValue(t);return{title:e.value,color:this.faceters[e.id].color,count:"i",onMain:this.unclickHandler(t),onAux:this.auxHandler(t)}},traversePivot:function(t,e,i){var a=[],s=this.getPivotEntry(i),n=e[s.id].buckets;if(i===this.lastEnabled){var r=t.data("widget");r?t.children().slice(1).remove():((r=new f({id:s.id,color:s.color,renderItem:this.renderTag,pivotWidget:this,target:t,multivalue:this.multivalue,aggregate:this.aggregate,exclusion:this.exclusion})).init(this.manager),t.data({widget:r,id:s.id})),r.populate(n,!0),a=[]}else if(null!=n)for(var o=0,l=n.length;o<l;++o){var d,u=n[o],c=u.val.replace(p,"_");1<t.children().length?d=h("#"+c,t[0]).show():(d=g.ui.fillTemplate(h("#tag-facet"),s).attr("id",c),u.title=u.val,u.onMain=this.clickHandler(s.id+":"+u.val),u.hint=buildValueRange(u),d.append(this.renderTag(u).addClass("category title").addClass(s.color)),a.push(d)),this.traversePivot(d,u,i+1)}t.append(a)}}}(Solr,asSys,jQuery,jToxKit),function(g,l,u,c){function SimpleRanger(t){this.sliderRoot=t.sliderRoot}SimpleRanger.prototype.__expects=["addValue","doRequest"],SimpleRanger.prototype.targetValue=null,SimpleRanger.prototype.updateHandler=function(){var e=this;return function(t){e.addValue(t)&&(e.sliderRoot.updateRequest=!0,e.doRequest())}},SimpleRanger.prototype.doRequest=function(){this.manager.doRequest()},SingleRangeWidget=l(g.Ranging,g.Patterning,c.SliderWidget,SimpleRanger,g.Delaying);var s={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,echoParams:"none"};c.RangeWidgeting=function(t){l.extend(!0,this,l.common(t,this)),this.slidersTarget=u(t.slidersTarget),this.lookupMap=t.lookupMap||{},this.pivotMap=null,this.rangeWidgets=[],Array.isArray(this.titleSkips)||(this.titleSkips=[this.titleSkips])},c.RangeWidgeting.prototype={__expects:["getPivotEntry","getPivotCounts"],field:null,titleSkips:null,init:function(t){l.pass(this,c.RangeWidgeting,"init",t),this.manager=t;var e=this;e.applyCommand=u("#sliders-controls a.command.apply").on("click",function(t){return e.skipClear=!0,e.manager.doRequest(),!1}),u("#sliders-controls a.command.close").on("click",function(t){return e.rangeRemove(),!1})},afterTranslation:function(t){var e=this.getPivotCounts(t.facets);if(l.pass(this,c.RangeWidgeting,"afterTranslation",t),this.pivotMap)if(this.updateRequest){if(0<this.rangeWidgets.length)for(var i,a,s=this.buildPivotMap(e),n=0,r=this.rangeWidgets.length;n<r;++n)a=s[(i=this.rangeWidgets[n]).targetValue],i.updateSlider([a[n].min,a[n].max])}else this.rangeRemove();else{var o=this.manager.getParameter("q").value||"";o&&"*:*"!=o||this.manager.getParameter(this.useJson?"json.filter":"fq").value||(this.pivotMap=this.buildPivotMap(e))}this.updateRequest=!1},buildPivotMap:function(t){var c=this,h={};traverser=function(t,e,i,a){var s,n=c.getPivotEntry(e),r=n.id,o=n.color;if(n.ranging&&!n.disabled&&(a=r+":"+t.val),i+=(t.val?n.field+":"+g.escapeValue(t.val):"-"+n.field+":*")+" ",s=t,null!=(n=c.getPivotEntry(e+1))&&(t=t[n.id].buckets),null!=n&&t.length)for(var l=0,d=t.length;l<d;++l)traverser(t[l],e+1,i,a);else{var u=h[a];u===undefined&&(h[a]=u=[]),u.push({id:r,pattern:i,color:o,min:s.min,max:s.max,avg:s.avg,val:s.val,count:s.count})}};for(var e=0;e<t.length;++e)traverser(t[e],0,"");return h},rangeRemove:function(){this.slidersTarget.empty().parent().removeClass("active");for(var t=0,e=this.rangeWidgets.length;t<e;++t)this.rangeWidgets[t].clearValues();this.rangeWidgets=[],this.lastPivotMap=this.lastPivotValue=null},buildTitle:function(t,e){for(var i=t.pattern.replace(/\\"/g,"%0022").match(/\w+:([^\s:\/"]+|"[^"]+")/g),a=[],s=0;s<i.length;++s){var n=i[s].match(/(\w+):([^\s:\/"]+|"[^"]+")/),r=n[2].replace(/^\s*\(\s*|\s*\)\s*$/g,"");n[1].match(e)||a.push(this.lookupMap[r]||r)}return a.join("/")+" <i>("+t.count+")</i>"},ensurePivotMap:function(e){if(null!=this.pivotMap)return!0;var i=this.useJson?"json.filter":"fq",a=this;return this.doSpying(function(t){t.removeParameters(i),t.removeParameters("fl"),t.getParameter("q").value="",t.mergeParameters(s)},function(t){a.pivotMap=a.buildPivotMap(a.getPivotCounts(t.facets)),a.openRangers(e)}),!1},openRangers:function(t){var e=this.pivotMap[t],i=(this.lastPivotMap=this.buildPivotMap(this.getPivotCounts()))[t];this.lastPivotValue=t,this.slidersTarget.empty().parent().addClass("active");for(var a=0,s=e.length;a<s;++a){var n,r=e[a],o=i[a],l={},d=c.ui.fillTemplate("#slider-one");this.slidersTarget.append(d),l.id=r.id,l.targetValue=t,l.color=r.color,l.field=this.field,l.limits=[r.min,r.max],l.initial=[o.min,o.max],l.target=d,l.isRange=!0,l.valuePattern=r.pattern+"{{v}}",l.automatic=!0,l.width=parseInt(this.slidersTarget.width()-u("#sliders-controls").width()-20)/(Math.min(s,2)+.1),l.title=this.buildTitle(o,/^unit[_shd]*|^effectendpoint[_shd]*/),l.units="unit"==o.id?c.ui.formatUnits(o.val):"",l.useJson=this.useJson,l.domain=this.domain,(l.sliderRoot=this).rangeWidgets.push(n=new SingleRangeWidget(l)),n.init(this.manager)}},auxHandler:function(e){var i=this;return function(t){return t.stopPropagation(),i.rangeRemove(),e!=i.lastPivotValue&&i.ensurePivotMap(e)&&i.openRangers(e),!1}},clearValues:function(){this.rangeRemove(),l.pass(this,c.RangeWidgeting,"clearValues")}}}(Solr,asSys,jQuery,jToxKit),function(t,l,d,u){var r='<a href="{{href}}" title="{{hint}}" target="{{target}}" class="{{css}}">{{value}}</a>';u.ItemListWidget=function(t){t.baseUrl=u.ui.fixBaseUrl(t.baseUrl)+"/",l.extend(!0,this,l.common(t,this)),this.lookupMap=t.lookupMap||{},this.target=t.target,this.id=t.id},u.ItemListWidget.prototype={baseUrl:"",summaryPrimes:["RESULTS"],tagDbs:{},onCreated:null,onClick:null,summaryRenderers:{RESULTS:function(t,e){var i=this;return t.map(function(t){return t.split(".").map(function(t){return i.lookupMap[t]||t}).join(".")})},REFOWNERS:function(t,e){return{topic:"Study Providers",content:t.map(function(t){return u.ui.formatString(r,{href:"#",hint:"Freetext search",target:"_self",value:t,css:"freetext_selector"})})}},REFS:function(t,e){return{topic:"References",content:t.map(function(t){var e=t.match(/^doi:(.+)$/);return e=null!=e?"https://www.doi.org/"+e[1]:t,u.ui.formatString(e.match(/^https?:\/\//)?r:'<span title="{{hint}}" class="{{css}}">{{value}}</span>',{href:e,hint:"External reference",target:"ref",value:t})})}}},renderItem:function(e){var i=this,a=d(this.renderSubstance(e));return a.length&&(d(this.target).append(a),"function"==typeof this.onClick&&d("a.command",a[0]).on("click",function(t){i.onClick.call(a[0],t,e,i)}),"function"==typeof this.onCreated&&this.onCreated.call(a,e,this),d("a.more",a[0]).on("click",function(t){t.preventDefault(),t.stopPropagation();var e=d(this),i=d(".more-less",e.parent()[0]);return i.is(":visible")?(i.hide(),e.text("more")):(i.show(),e.text("less")),!1})),null},renderSubstance:function(t){var e=d("#summary-item").html(),i=this.buildSummary(t),a=this.getBaseUrl(t),s=function(t){return t.map(function(t){return u.ui.formatString(e,t)}).join("")},n={logo:this.tagDbs[t.dbtag_hss]&&this.tagDbs[t.dbtag_hss].icon||"images/logo.png",link:"#",href:"#",title:(t.publicname||t.name)+(t.pubname===t.name?"":"  ("+t.name+")")+(null==t.substanceType?"":" "+(this.lookupMap[t.substanceType]||t.substanceType)),composition:this.renderComposition(t,'<a href="'+a+t.s_uuid+'/structure" title="Composition" target="'+t.s_uuid+'">&hellip;</a>').join("<br/>"),summary:0<i.length?s(i.splice(0,this.summaryPrimes.length)):"",item_id:(this.prefix||this.id||"item")+"_"+t.s_uuid,footer:'<a href="'+a+t.s_uuid+'" title="Substance" target="'+t.s_uuid+'">Material</a><a href="'+a+t.s_uuid+'/structure" title="Composition" target="'+t.s_uuid+'">Composition</a><a href="'+a+t.s_uuid+'/study" title="Study" target="'+t.s_uuid+'">Studies</a>'};if(0<i.length&&(n.summary+='<a href="#" class="more">more</a><div class="more-less" style="display:none;">'+s(i)+"</div>"),null==t.content)n.link=a+t.s_uuid,n.href=n.link+"/study",n.href_title="Study",n.href_target=t.s_uuid;else{var r="External database";if(t.owner_name&&0===t.owner_name.lastIndexOf("caNano",0)?(n.logo="images/canano.jpg",n.href_title="caNanoLab: "+n.link,n.href_target=r="caNanoLab",n.footer=""):(n.logo="images/external.png",n.href_title="External: "+n.link,n.href_target="external"),0<t.content.length){n.link=t.content[0];for(var o=0,l=t.content.length;o<l;o++)n.footer+='<a href="'+t.content[o]+'" target="external">'+r+"</a>"}}return u.ui.fillTemplate("#result-item",n)},getBaseUrl:function(t){if(this.tagDbs[t.dbtag_hss]!==undefined){var e=this.tagDbs[t.dbtag_hss].server,i=e.substr(-1);return e+("/"!=i?"/substance/":"substance/")}return this.baseUrl},renderComposition:function(t,s){var n=[],e=t._extended_&&t._extended_.composition;if(e){var i={};l.each(e,function(t){var e=i[t.component_s],a=[];e===undefined&&(i[t.component_s]=e=[]),l.each(t,function(t,e){var i=e.match(/^(\w+)_[shd]+$/);(e=i&&i[1]||e).match(/type|id|component/)||a.push(u.ui.formatString(r,{href:"#",hint:"Freetext search on '"+e+"'",target:"_self",value:t,css:"freetext_selector"}))}),e.push(a.join(", "))}),l.each(i,function(t,e){for(var i="",a=0;a<t.length;++a)""!=t[a]&&(i+=0==a?": ":"; ",1<t.length&&(i+="<strong>["+(a+1)+"]</strong>&nbsp;"),i+=t[a]);""===i&&(i=":&nbsp;"+s),i=e+" ("+t.length+")"+i,n.push(i)})}return n},buildSummary:function(t){var r=this,o=[];return l.each(t,function(t,e){var i=e.match(/^SUMMARY\.([^_]+)_?[hsd]*$/);if(i){i=i[1];var a=r.summaryRenderers[i]||r.summaryRenderers._,s="function"==typeof a?a.call(r,t,i):t;if(s){"object"!=typeof s||Array.isArray(s)?s={topic:i.toLowerCase(),values:s}:null==s.topic&&(s.topic=i.toLowerCase()),s.content||(s.content=Array.isArray(s.values)?s.values.join(", "):s.values.toString());var n=r.summaryPrimes.indexOf(i);-1<n&&n<o.length?o.splice(n,0,s):o.push(s)}}}),o}},u.ResultWidgeting=function(t){l.extend(!0,this,l.common(t,this))},u.ResultWidgeting.prototype={__expects:["populate"],init:function(t){l.pass(this,u.ResultWidgeting,"init",t),this.manager=t},beforeRequest:function(){d(this.target).html(d("<img>").attr("src","images/ajax-loader.gif"))},afterFailure:function(t,e){d(this.target).html("Error retrieving data!")},afterTranslation:function(t){d(this.target).empty(),this.populate(t.entries)}},u.ResultWidget=l(t.Listing,u.ListWidget,u.ItemListWidget,u.ResultWidgeting)}(Solr,asSys,jQuery,jToxKit),jToxKit.ui.templates["faceted-search-kit"]='<div class="query-container">\x3c!-- left --\x3e<div id="query" class="query-left"><div id="accordion-resizer" class="ui-widget-content"><div id="accordion"></div></div></div>\x3c!-- right --\x3e<div id="result-tabs" class="query-right"><ul><li><a href="#hits_tab">Hits list</a></li><li><a href="#basket_tab">Selection</a></li><li class="jtox-ds-export"><a href="#export_tab">Export</a></li></ul><div id="hits_tab"><div class="row remove-bottom"><ul class="tags remove-bottom" id="selection"></ul><footer><div id="sliders-controls"><a href="#" class="jtox-fadable command close">Close</a></div><div id="sliders"></div></footer></div><div id="navigation"><ul id="pager"></ul><div id="pager-header"></div></div><div class="docs_wrapper"><section id="docs" class="item-list"></section></div></div><div id="basket_tab"><section id="basket-docs" class="item-list"></section><div style="padding-top: 70px;"></div></div><div id="export_tab"><form target="_blank" method="post"><input type="hidden" name="search"/><h6>Select dataset to export</h6><div id="export_dataset"><input type="radio" value="filtered" name="export_dataset" id="filtered_data" checked="checked"/><label for="filtered_data">Filtered entries</label><input type="radio" value="selected" name="export_dataset" id="selected_data"/><label for="selected_data">Selected entries</label></div><h6>Select export type</h6><div id="export_type"></div><h6>Select output format</h6><input type="hidden" name="export_format" id="export_format"/><div class="data_formats"></div><br/><button type="submit" name="export_go" data-prefix="Download">?</button><div class="ui-state-error ui-corner-all warning-message" style="padding: 0 .7em;"><p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span><strong>Warning:</strong>Please either add entries to the selection or specify a query</p></div></form></div></div>\x3c!-- query container --\x3e</div>',jToxKit.ui.templates["faceted-search-templates"]='<section id="result-item"><article id="{{item_id}}" class="item"><header>{{title}}<a href="{{href}}" title="{{href_title}}" target="{{href_target}}"><span class="ui-icon ui-icon-extlink" style="float:right;margin:0;"></span></a></header><a href="{{link}}" title="{{link}}" class="avatar" target="_blank"><img jt-src="{{logo}}"/></a><div class="composition">{{composition}}</div>{{summary}}<footer class="links">{{footer}}<a href="#" class="add jtox-fadable command">Add to Selection</a><a href="#" class="remove jtox-fadable command">Remove from Selection</a><a href="#" class="none jtox-fadable command">Already added</a></footer></article></section><div id="summary-item"><div class="one-summary"><span class="topic">{{topic}}:</span><span class="value">{{content}}</span></div></div><div id="tag-facet"><ul class="tags tag-group folded"></ul></div><div id="tab-topcategory"><h3 id="{{id}}_header" class="nested-tab">{{title}}</h3><div id="{{id}}" class="widget-content widget-root"><div><input type="text" placeholder="Filter_" class="widget-filter"/><input type="button" class="switcher" value="OR"/></div><ul class="widget-content tags remove-bottom" data-color="{{color}}"></ul></div></div><div id="slider-one"><input type="hidden"/></div><div id="export-type"><input type="radio" value="{{fields}}" {{selected}} name="export_type" id="{{name}}"/><label for="{{name}}">{{name}}</label></div><div id="export-format"><div class="jtox-inline jtox-ds-download jtox-fadable"><a target="_blank" data-name="{{name}}" data-mime="{{mime}}" href="#"><img class="borderless" jt-src="{{icon}}"/></a></div></div>',jT.ui.templates["logger-main"]='<div class="list-wrap"><div class="list-root"></div></div><div class="status"><div class="icon jtox-fadable"></div></div>',jT.ui.templates["logger-line"]='<div id="jtox-logline"><div class="logline"><div class="icon"></div><span class="content data-field" data-field="header">{{header}}</span><div class="details data-field" data-field="details">{{details}}</div></div></div>';